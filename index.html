<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>



    <title>ระบบลงทะเบียนแข่งขัน</title>
    <style>
        body {
            font-family: 'Kanit', 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        
        .app-section { display: none; }
        .app-section.active { display: block; }
        .nav-item.active { color: #0ea5e9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .badge-green { background-color: #dcfce7; color: #166534; border: 1px solid #22c55e; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; border: 1px solid #f59e0b; }
        .badge-red { background-color: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
            display: block;
            font-size: 24px;
            line-height: 1;
            margin: 0 auto;
        }
        .file-input-style {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #334155;
            padding: 8px 12px;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-style:hover {
            background-color: #e2e8f0;
        }

        /* ขยายตัวอักษรใน Modal รูปทีมให้ชัดขึ้น */
        #team-photo-modal-content {
            font-size: 0.95rem;
        }
        #team-photo-modal-content .text-[9px],
        #team-photo-modal-content .text-[10px],
        #team-photo-modal-content .text-[11px] {
            font-size: 0.8rem !important;
        }
        #team-photo-modal-content .text-xs {
            font-size: 0.8rem;
        }
        #team-photo-modal-content .text-lg {
            font-size: 1.2rem;
        }

        /* ปรับตารางหน้าทีมให้ใช้งานได้ดีบนหน้าจอเล็ก (Mobile Friendly) */
        @media (max-width: 768px) {
            #section-teams .overflow-x-auto {
                overflow-x: visible;
            }
            #section-teams table {
                width: 100%;
                border-collapse: collapse;
            }
            #section-teams thead {
                display: none;
            }
            #section-teams tbody {
                display: block;
            }
            #section-teams tbody tr {
                display: block;
                margin-bottom: 0.75rem;
                padding: 0.6rem 0.75rem;
                border-radius: 0.9rem;
                border: 1px solid #e2e8f0;
                background-color: #ffffff;
                box-shadow: 0 1px 2px rgba(15,23,42,0.03);
            }
            /* แถวหัวหมวดหมู่ */
            #section-teams tbody tr.bg-slate-100 {
                border: none;
                box-shadow: none;
                padding: 0.2rem 0.2rem 0;
                margin: 0.4rem 0 0.2rem;
                border-radius: 0;
                background-color: transparent;
            }
            #section-teams tbody tr.bg-slate-100 td {
                padding: 0;
                font-size: 0.78rem;
                font-weight: 600;
                color: #475569;
            }
            /* ช่องในแต่ละทีมเป็น block + label */
            #section-teams tbody tr td {
                display: block;
                padding: 0.15rem 0;
                font-size: 0.78rem;
                border: none !important;
                white-space: normal;
            }
            /* รหัสทีม */
            #section-teams tbody tr td:nth-child(1)::before {
                content: "รหัสทีม: ";
                font-weight: 600;
                color: #0f172a;
            }
            /* กิจกรรม */
            #section-teams tbody tr td:nth-child(2)::before {
                content: "กิจกรรม: ";
                font-weight: 600;
                color: #0f172a;
            }
            /* ชื่อทีม/โรงเรียน แสดงแบบเต็มไม่เพิ่ม label (มีภายในอยู่แล้ว) */
            #section-teams tbody tr td:nth-child(3) {
                margin-top: 0.2rem;
            }
            /* ครู */
            #section-teams tbody tr td:nth-child(4)::before {
                content: "ครู (ต้อง/มี): ";
                font-weight: 500;
                color: #475569;
            }
            /* นร. */
            #section-teams tbody tr td:nth-child(5)::before {
                content: "นร. (ต้อง/มี): ";
                font-weight: 500;
                color: #475569;
            }
            /* ระดับ */
            #section-teams tbody tr td:nth-child(6)::before {
                content: "ระดับ: ";
                font-weight: 500;
                color: #475569;
            }
            /* สถานะ */
            #section-teams tbody tr td:nth-child(7)::before {
                content: "สถานะ: ";
                font-weight: 500;
                color: #475569;
                margin-right: 0.25rem;
            }
            #section-teams tbody tr td:nth-child(7) span {
                margin-top: 0.15rem;
            }
            /* จัดการ */
            #section-teams tbody tr td:nth-child(8)::before {
                content: "จัดการ: ";
                font-weight: 500;
                color: #475569;
            }
        }
    
        /* PDF Export (Kanit) */
        .pdf-kanit, .pdf-kanit * {
            font-family: 'Kanit', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif !important;
        }
        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .pdf-table th, .pdf-table td {
            border: 1px solid #e5e7eb;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .pdf-table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
        .pdf-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .pdf-subtitle {
            font-size: 12px;
            color: #475569;
            margin-bottom: 8px;
        }
</style>
</head>
<body class="text-slate-800">

<div class="container mx-auto max-w-5xl pb-24">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex-col items-center justify-center" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
        <p class="mt-4 text-lg font-semibold text-sky-600">กำลังโหลด...</p>
    </div>

    <!-- 1. Hero Section -->
    <section id="section-hero" class="app-section active p-6 text-center bg-slate-50 rounded-b-lg">
        <ion-icon name="trophy-outline" class="text-6xl text-sky-500 mx-auto"></ion-icon>
        <h1 class="text-3xl font-bold text-slate-900 mt-4">ลงทะเบียนแข่งขันระดับสถานศึกษา</h1>
        <p class="text-lg text-slate-600 mt-2">ระบบจัดการการแข่งขันวิชาการและกิจกรรม</p>
        <button type="button" class="mt-6 inline-flex items-center justify-center bg-sky-500 text-white font-semibold px-8 py-3 rounded-lg shadow-md hover:bg-sky-600 transition-colors"
                onclick="handleStartRegistration(event)">
            เริ่มลงทะเบียน
        </button>
        <div class="mt-6 p-3 bg-sky-100 border border-sky-200 text-sky-800 rounded-lg text-sm text-left">
            <strong>คำแนะนำ:</strong> คลิก "เริ่มลงทะเบียน" เพื่อเลื่อนไปยังแบบฟอร์ม หรือเลื่อนลงเพื่อสำรวจกิจกรรมที่เปิดรับสมัคร
        </div>
        <div class="mt-10 text-left space-y-6">
            <div class="flex flex-col gap-3 md:flex-row md:items-end">
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-slate-900">กิจกรรมที่เปิดรับสมัคร</h2>
                    <p class="text-sm text-slate-500 mt-1">ค้นหากิจกรรมที่ยังเปิดให้สมัครและกดสมัครได้ทันที</p>
                </div>
                <div class="w-full md:w-80 relative">
                    <span class="material-symbols-outlined text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none">search</span>
                    <input id="home-activity-search" type="search" class="w-full pl-11 pr-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ค้นหาจากชื่อกิจกรรม หมวดหมู่ หรือระดับ" autocomplete="off">
                </div>
            </div>
            <div id="home-category-filter" class="flex flex-wrap gap-2"></div>
            <p id="home-activity-meta" class="text-sm text-slate-500">กำลังโหลดข้อมูลกิจกรรม...</p>
            <div id="home-activity-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="home-activity-empty" class="hidden text-center text-slate-500">
                <span class="material-symbols-outlined text-4xl mb-2 text-slate-400">info</span>
                <p>ไม่พบกิจกรรมที่ตรงกับคำค้นหา</p>
            </div>
            <div class="flex justify-center">
                <button id="home-activity-load-more" class="hidden px-5 py-2 rounded-lg border border-sky-500 text-sky-600 font-semibold hover:bg-sky-50 transition-colors">
                    ดูเพิ่มเติม
                </button>
            </div>
        </div>
        </section>

        <!-- Member/Auth Section -->
        <section id="section-auth" class="app-section p-4">
            <h2 class="text-2xl font-bold mb-2 px-2">สมัครสมาชิก / เข้าระบบ</h2>
            <p class="text-sm text-slate-500 mb-6 px-2">เลือกวิธีสมัครสมาชิกและเข้าสู่ระบบอย่างสะดวก ระบบจะดึงข้อมูลโรงเรียนจากฐานข้อมูล Schools ให้โดยอัตโนมัติ</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Login Card -->
                <div id="login-card" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-4">
                    <h3 class="text-xl font-semibold text-slate-900 mb-4">เข้าสู่ระบบ</h3>
                    <div id="login-form-wrapper" class="space-y-4">
                        <form id="auth-login-form" class="space-y-4">
                            <div>
                                <label for="login-username" class="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้</label>
                                <input type="text" id="login-username" name="username" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="username">
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                                <input type="password" id="login-password" name="password" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="current-password">
                            </div>
                            <button type="submit" id="login-submit-button" class="w-full bg-slate-900 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-slate-800 transition-colors">เข้าสู่ระบบ</button>
                        </form>
                        <div id="login-progress-indicator" class="hidden mt-3 text-sm text-sky-600 flex items-center gap-2">
                            <span class="h-4 w-4 border-2 border-sky-500 border-t-transparent rounded-full animate-spin"></span>
                            <span>กำลังตรวจสอบข้อมูล...</span>
                        </div>
                        <div id="login-status" class="text-sm text-slate-500"></div>
                    </div>
                    <div id="auth-user-panel" class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg hidden">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full border border-slate-200 bg-white flex items-center justify-center overflow-hidden">
                                <img id="auth-user-avatar" alt="Avatar" class="hidden w-full h-full object-cover">
                                <span id="auth-user-avatar-placeholder" class="material-symbols-outlined text-slate-400">person</span>
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-slate-800">เข้าสู่ระบบแล้ว</p>
                                <p class="text-sm text-slate-600 mt-1" id="auth-user-summary">-</p>
                                <p class="text-xs text-slate-500 mt-1" id="auth-user-school">-</p>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2 hidden" id="auth-user-email"></p>
                        <button id="logout-button" type="button" class="mt-3 w-full bg-white text-slate-700 font-semibold px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100 transition-colors">ออกจากระบบ</button>
                    </div>
                </div>

                <!-- Signup Card -->
                <div id="signup-card" class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                        <h3 class="text-xl font-semibold text-slate-900">สมัครสมาชิกใหม่</h3>
                        <button id="toggle-signup-form" type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition-colors" aria-expanded="false">
                            <span class="material-symbols-outlined text-base" id="toggle-signup-form-icon">expand_more</span>
                            <span id="toggle-signup-form-text">เปิดฟอร์มสมัครสมาชิก</span>
                        </button>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">
                        ระบบจะซ่อนแบบฟอร์มไว้ก่อนเพื่อป้องกันการกรอกโดยไม่ตั้งใจ กดปุ่ม “เปิดฟอร์มสมัครสมาชิก” หากต้องการลงทะเบียนใหม่
                    </div>
                    <div id="signup-form-container" class="hidden mt-4 space-y-4">
                        <form id="auth-signup-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="signup-name" class="block text-sm font-medium text-slate-700 mb-1">ชื่อ</label>
                                    <input type="text" id="signup-name" name="name" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                </div>
                                <div>
                                    <label for="signup-surname" class="block text-sm font-medium text-slate-700 mb-1">นามสกุล</label>
                                    <input type="text" id="signup-surname" name="surname" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                </div>
                            </div>
                            <div>
                                <label for="signup-tel" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์</label>
                                <input type="tel" id="signup-tel" name="tel" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" data-only-digits="true" inputmode="numeric" pattern="[0-9]*" required>
                            </div>
                            <div>
                                <label for="signup-email" class="block text-sm font-medium text-slate-700 mb-1">อีเมล</label>
                                <input type="email" id="signup-email" name="email" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="email">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">รูปประจำตัว (ไม่บังคับ)</label>
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 rounded-full border border-slate-200 bg-white flex items-center justify-center overflow-hidden">
                                        <img id="signup-avatar-preview" alt="รูปประจำตัว" class="hidden w-full h-full object-cover">
                                        <span id="signup-avatar-placeholder" class="material-symbols-outlined text-slate-400">person</span>
                                    </div>
                                    <div class="flex-1 space-y-2">
                                        <input type="file" id="signup-avatar" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200" accept="image/png, image/jpeg">
                                        <p id="signup-avatar-status" class="text-xs text-slate-500" data-default-status="รองรับ .png, .jpg ขนาดไม่เกิน 2MB">รองรับ .png, .jpg ขนาดไม่เกิน 2MB</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="auth-school-select" class="block text-sm font-medium text-slate-700 mb-1">เลือกโรงเรียน (จากฐานข้อมูล)</label>
                                <select id="auth-school-select" name="schoolId" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                    <option value="">-- กำลังโหลดรายชื่อโรงเรียน --</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="signup-username" class="block text-sm font-medium text-slate-700 mb-1">ชื่อผู้ใช้</label>
                                    <input type="text" id="signup-username" name="username" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="new-username">
                                </div>
                                <div>
                                    <label for="signup-password" class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน</label>
                                    <input type="password" id="signup-password" name="password" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="new-password">
                                </div>
                            </div>
                            <div>
                                <label for="signup-confirm-password" class="block text-sm font-medium text-slate-700 mb-1">ยืนยันรหัสผ่าน</label>
                                <input type="password" id="signup-confirm-password" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required autocomplete="new-password">
                            </div>
                            <button type="submit" class="w-full bg-sky-500 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-sky-600 transition-colors">สมัครสมาชิก</button>
                        </form>
                        <div id="signup-status" class="text-sm text-slate-500"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Activities Filter & Cards -->
    <section id="section-activities" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">รายการกิจกรรม</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 px-2">
            <select id="filter-category" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                <option value="">-- เลือกหมวดหมู่กิจกรรม --</option>
            </select>
            <select id="filter-activity-name" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                <option value="">-- เลือกกิจกรรม --</option>
            </select>
        </div>
        <div id="activity-container" class="space-y-6">
            <p id="activity-loading" class="text-slate-500">กำลังโหลดรายการกิจกรรม...</p>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> เลือก "หมวดหมู่" เพื่อกรองรายการกิจกรรมที่สนใจ จากนั้นคลิก "สมัครทีม" บนการ์ดที่ต้องการ
        </div>
    </section>

    <!-- 4. Form สมัครทีม -->
    <section id="section-form" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">กรอกข้อมูลการสมัคร</h2>
        
        <!-- Stepper UI -->
        <div class="flex justify-between items-center mb-6 px-2">
            <div id="step-indicator-1" class="step-indicator active text-center flex-1">
                <div class="w-10 h-10 mx-auto bg-sky-500 text-white rounded-full flex items-center justify-center font-bold text-lg">1</div>
                <p class="text-sm font-semibold text-sky-600 mt-1">ข้อมูลทีม</p>
            </div>
            <div class="flex-1 h-1 bg-slate-200"></div>
            <div id="step-indicator-2" class="step-indicator text-center flex-1">
                <div class="w-10 h-10 mx-auto bg-slate-300 text-slate-600 rounded-full flex items-center justify-center font-bold text-lg">2</div>
                <p class="text-sm font-semibold text-slate-500 mt-1">ผู้ติดต่อ</p>
            </div>
            <div class="flex-1 h-1 bg-slate-200"></div>
            <div id="step-indicator-3" class="step-indicator text-center flex-1">
                <div class="w-10 h-10 mx-auto bg-slate-300 text-slate-600 rounded-full flex items-center justify-center font-bold text-lg">3</div>
                <p class="text-sm font-semibold text-slate-500 mt-1">สมาชิก</p>
            </div>
        </div>

        <form id="registration-form" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-6">
            <div id="registration-lock-notice" class="p-4 rounded-lg bg-amber-50 border border-amber-200 text-amber-700 text-sm">
                กรุณาเข้าสู่ระบบก่อนจึงจะสามารถกรอกแบบฟอร์มสมัครได้
            </div>
            <fieldset id="registration-fieldset" disabled class="space-y-6">

            <!-- Step 1: Team Info -->
            <div id="form-step-1" class="form-step active">
                <h3 class="text-xl font-semibold mb-4">ขั้นที่ 1: ข้อมูลทีม</h3>
                <div class="space-y-4">
                    <div>
                        <label for="form-activity-category" class="block text-sm font-medium text-slate-700 mb-1">หมวดหมู่กิจกรรม</label>
                        <select id="form-activity-category" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="">-- เลือกหมวดหมู่ --</option>
                        </select>
                    </div>
                    <div>
                        <label for="form-activity" class="block text-sm font-medium text-slate-700 mb-1">กิจกรรม*</label>
                        <select id="form-activity" name="activity" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            <option value="">-- เลือกกิจกรรม --</option>
                        </select>
                    </div>
                    <div>
                        <label for="form-level" class="block text-sm font-medium text-slate-700 mb-1">ระดับ*</label>
                        <select id="form-level" name="level" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            <option value="">-- เลือกระดับ --</option>
                        </select>
                    </div>
                    <div>
                        <label for="form-school" class="block text-sm font-medium text-slate-700 mb-1">โรงเรียน*</label>
                        <input type="text" id="form-school" name="school" list="school-options" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="พิมพ์ชื่อโรงเรียนเพื่อค้นหา" autocomplete="off" required>
                        <datalist id="school-options"></datalist>
                    </div>
                    <div>
                        <label for="form-teamName" class="block text-sm font-medium text-slate-700 mb-1">ชื่อทีม (ถ้ามี)</label>
                        <input type="text" id="form-teamName" name="teamName" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    </div>

                    <!-- Upload Logo -->
                    <div>
                        <label for="form-logo" class="block text-sm font-medium text-slate-700 mb-1">โลโก้ทีม (ถ้ามี)</label>
                        <div class="flex items-center gap-4">
                            <div class="w-20 h-20 rounded-2xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                                <img id="form-logo-preview" alt="โลโก้ทีม" class="hidden w-full h-full object-cover">
                                <span id="form-logo-placeholder" class="material-symbols-outlined text-3xl text-slate-400">image</span>
                            </div>
                            <div class="flex-1 space-y-1">
                                <input type="file" id="form-logo" name="logo" class="w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-sky-100 file:text-sky-700
                                    hover:file:bg-sky-200"
                                    accept="image/png, image/jpeg">
                                <p id="logo-status" class="text-xs text-slate-500" data-default-status="รองรับ .png, .jpg (ไม่เกิน 2MB)">รองรับ .png, .jpg (ไม่เกิน 2MB)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Upload Team Photo -->
                    <div>
                        <label for="form-team-photo" class="block text-sm font-medium text-slate-700 mb-1">รูปภาพทีม (รวมสมาชิก)</label>
                        <div class="flex items-center gap-4">
                            <div class="w-24 h-24 rounded-xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                                <img id="team-photo-preview" alt="Team preview" class="hidden w-full h-full object-cover">
                                <span id="team-photo-placeholder" class="material-symbols-outlined text-4xl text-slate-400">group</span>
                            </div>
                            <div class="flex-1 space-y-2">
                                <input type="file" id="form-team-photo" name="teamPhoto" class="w-full text-sm text-slate-500
                                    file:mr-4 file:py-2 file:px-4
                                    file:rounded-lg file:border-0
                                    file:text-sm file:font-semibold
                                    file:bg-sky-100 file:text-sky-700
                                    hover:file:bg-sky-200"
                                    accept="image/png, image/jpeg">
                                <p id="team-photo-status" class="text-xs text-slate-500" data-default-status="รองรับ .png, .jpg ไม่เกิน 3MB">รองรับ .png, .jpg ไม่เกิน 3MB</p>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="mt-6 text-right">
                    <button type="button" onclick="nextStep(2)" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-lg shadow-md hover:bg-sky-600 transition-colors">ถัดไป &gt;</button>
                </div>
            </div>

            <!-- Step 2: Contact Person -->
            <div id="form-step-2" class="form-step">
                <h3 class="text-xl font-semibold mb-4">ขั้นที่ 2: ผู้ติดต่อหลัก (ครู/ผู้ประสานงาน)</h3>
                <div class="space-y-4">
                    <div>
                        <label for="contact-name" class="block text-sm font-medium text-slate-700 mb-1">ชื่อ-สกุล*</label>
                        <input type="text" id="contact-name" name="contactName" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    </div>
                    <div>
                        <label for="contact-phone" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์*</label>
                        <input type="tel" id="contact-phone" name="contactPhone" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" data-only-digits="true" inputmode="numeric" pattern="[0-9]*" required>
                    </div>
                    <div>
                        <label for="contact-email" class="block text-sm font-medium text-slate-700 mb-1">อีเมล*</label>
                        <input type="email" id="contact-email" name="contactEmail" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="prevStep(1)" class="bg-slate-200 text-slate-700 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition-colors">&lt; ย้อนกลับ</button>
                    <button type="button" onclick="nextStep(3)" class="bg-sky-500 text-white font-semibold px-6 py-2 rounded-lg shadow-md hover:bg-sky-600 transition-colors">ถัดไป &gt;</button>
                </div>
            </div>

            <!-- Step 3: Members -->
            <div id="form-step-3" class="form-step">
                <h3 class="text-xl font-semibold mb-4">ขั้นที่ 3: รายชื่อสมาชิก</h3>
                <div id="member-requirements" class="p-3 bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-lg mb-4">
                    กรุณาเลือกกิจกรรมก่อน...
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-slate-800 mb-2">ครูผู้ควบคุม</h4>
                    <div id="teacher-fields" class="space-y-3"></div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-slate-800 mb-2">นักเรียน</h4>
                    <div id="student-fields" class="space-y-3"></div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="prevStep(2)" class="bg-slate-200 text-slate-700 font-semibold px-6 py-2 rounded-lg hover:bg-slate-300 transition-colors">&lt; ย้อนกลับ</button>
                    <button id="form-submit-button" type="submit" class="bg-green-500 text-white font-bold px-6 py-2 rounded-lg shadow-md hover:bg-green-600 transition-colors">ส่งใบสมัคร</button>
                </div>
            </div>
            </fieldset>
        </form>
        <datalist id="teacher-prefix-options">
            <option value="นาย">
            <option value="นางสาว">
            <option value="นาง">
            <option value="ผศ.">
            <option value="ดร.">
            <option value="ผศ.ดร.">
        </datalist>
        <datalist id="student-prefix-options">
            <option value="เด็กชาย">
            <option value="เด็กหญิง">
            <option value="นาย">
            <option value="นางสาว">
        </datalist>

        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> กรอกข้อมูลให้ครบถ้วน 3 ขั้นตอน จำนวนสมาชิกและครูที่ต้องกรอก จะขึ้นอยู่กับกิจกรรมที่เลือก
        </div>
    </section>

    <!-- 5. Upload Files -->
    <section id="section-upload" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">อัปโหลดเอกสาร (เพิ่มเติม)</h2>
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-4">
            <div>
                <label for="upload-team-id" class="block text-sm font-medium text-slate-700 mb-1">เลือกทีม (ที่สมัครแล้ว)</label>
                <select id="upload-team-id" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">-- กรุณาเลือกรหัสทีม --</option>
                </select>
            </div>
            <div>
                <label for="upload-file-type" class="block text-sm font-medium text-slate-700 mb-1">ประเภทไฟล์</label>
                <select id="upload-file-type" class="w-full p-3 border border-slate-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="">-- เลือกประเภทไฟล์ --</option>
                    <option value="Consent">ใบยินยอมผู้ปกครอง</option>
                    <option value="Slip">สลิปโอนเงิน (ถ้ามี)</option>
                    <option value="Portfolio">แฟ้มผลงาน (ถ้ามี)</option>
                    <option value="Other">อื่นๆ</option>
                </select>
            </div>
            <div>
                <label for="file-input" class="block text-sm font-medium text-slate-700 mb-1">เลือกไฟล์ (PDF, JPG, PNG ไม่เกิน 5MB)</label>
                <input id="file-input" type="file" class="w-full text-sm text-slate-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-lg file:border-0
                    file:text-sm file:font-semibold
                    file:bg-sky-100 file:text-sky-700
                    hover:file:bg-sky-200"
                    accept=".pdf,.jpg,.jpeg,.png">
            </div>
            <button id="upload-button" class="w-full bg-sky-500 text-white font-semibold px-6 py-3 rounded-lg shadow-md hover:bg-sky-600 transition-colors">
                อัปโหลดไฟล์
            </button>
            <div id="upload-status" class="mt-4 space-y-2"></div>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> ใช้ส่วนนี้เพื่ออัปโหลดเอกสารอื่นๆ ที่จำเป็นหลังจากการสมัครทีมเสร็จสิ้น
        </div>
    </section>

    <!-- 6. Team List -->
    <section id="section-teams" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-2 px-2">ตรวจสอบสถานะทีม</h2>
        <div id="team-scope-banner" class="hidden mb-4 mx-2 flex items-center gap-2 rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-600">
            <span class="material-symbols-outlined text-base text-slate-400">info</span>
            <span id="team-scope-text" class="font-medium"></span>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <input type="search" id="team-search" placeholder="ค้นหาจากชื่อทีม, โรงเรียน..." class="flex-grow p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                <button id="export-csv-button" type="button" class="bg-slate-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-slate-700">Export CSV</button>
                <button id="export-pdf-button" type="button" class="bg-slate-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-slate-700">Export PDF</button>
                <button id="export-attendance-pdf-button" class="btn btn-green">ใบลงเวลา PDF (กิจกรรม)</button>
            </div>
            <div class="overflow-x-auto no-scrollbar">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">รหัสทีม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">กิจกรรม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ชื่อทีม / โลโก้</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ครู (ต้อง/มี)</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">นร. (ต้อง/มี)</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ระดับ</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">สถานะ</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="team-table-body" class="bg-white divide-y divide-slate-200">
                        <tr><td colspan="8" class="p-4 text-center text-slate-500">กำลังโหลดข้อมูลทีม...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ:</strong> "Pending" = รอตรวจสอบ, "Approved" = สมัครสำเร็จ, "Rejected" = ข้อมูลไม่ครบ/ไม่ถูกต้อง
        </div>
    </section>

    <!-- 7. Edit Team (คำอธิบาย) -->
    <section id="section-edit" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">การจัดการข้อมูลทีม (สำหรับผู้สมัคร)</h2>
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 space-y-4">
            <p class="text-slate-700">ส่วนนี้คือหน้าสำหรับผู้สมัครเพื่อแก้ไขข้อมูลทีมและสมาชิกหลังจากสมัครไปแล้ว (โดยปกติจะเข้าผ่านลิงก์พิเศษที่ส่งให้ทางอีเมล หรือหลังจากล็อกอิน)</p>
            <h3 class="text-lg font-semibold">การทำงานของ UI:</h3>
            <ul class="list-decimal list-inside space-y-2 text-slate-600">
                <li>ผู้ใช้จะเห็นฟอร์มที่กรอกข้อมูลเดิมของทีมไว้</li>
                <li>มีปุ่ม <strong>"แก้ไขข้อมูลทีม"</strong> (เช่น ชื่อทีม, ผู้ติดต่อ, โลโก้)</li>
                <li>ในส่วนรายชื่อสมาชิก แต่ละคนจะมีปุ่ม <strong>[ แก้ไข ]</strong> และ <strong>[ ลบสมาชิก ]</strong></li>
                <li>มีปุ่ม <strong>[ + เพิ่มสมาชิก ]</strong> (หากกิจกรรมอนุญาต หรือใช้แทนที่คนเดิม)</li>
                <li>เมื่อแก้ไขเสร็จ กดปุ่ม <strong>"บันทึกการเปลี่ยนแปลง"</strong></li>
            </ul>
        </div>
    </section>

    <!-- 8. Profile -->
    <section id="section-profile" class="app-section p-4">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-4 px-2">
            <div>
                <h2 class="text-2xl font-bold">โปรไฟล์ผู้สมัคร</h2>
                <p class="text-sm text-slate-500">ตรวจสอบข้อมูลติดต่อ สถิติโรงเรียน และแก้ไขรายละเอียดของคุณ</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button type="button" class="inline-flex items-center gap-2 text-sm font-semibold text-sky-600 hover:text-sky-800 transition-colors" onclick="navigateTo('section-form', this)">
                    <span class="material-symbols-outlined text-base">assignment_add</span>
                    <span>ไปยังแบบฟอร์มสมัคร</span>
                </button>
                <button id="profile-logout-btn" type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="handleProfileSectionLogout(event)">
                    <span class="material-symbols-outlined text-base">logout</span>
                    <span>ออกจากระบบ</span>
                </button>
            </div>
        </div>

        <div id="profile-guest-notice" class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div>
                    <p class="text-lg font-semibold text-slate-900">เข้าสู่ระบบเพื่อดูโปรไฟล์ของคุณ</p>
                    <p class="text-sm text-slate-500 mt-1">ระบบจะแสดงข้อมูลติดต่อและสถิติโรงเรียนเมื่อคุณเข้าสู่ระบบ</p>
                </div>
                <button type="button" class="inline-flex items-center gap-2 bg-sky-500 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-sky-600 transition-colors" onclick="navigateTo('section-auth', this)">
                    <span class="material-symbols-outlined text-base">login</span>
                    <span>เข้าสู่ระบบ</span>
                </button>
            </div>
        </div>

        <div id="profile-content" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row md:items-center md:gap-6">
                <div class="flex items-center gap-4 flex-1">
                    <div class="w-20 h-20 rounded-full border-2 border-slate-200 bg-slate-50 flex items-center justify-center overflow-hidden">
                        <img id="profile-avatar" alt="รูปโปรไฟล์" class="hidden w-full h-full object-cover">
                        <span id="profile-avatar-fallback" class="material-symbols-outlined text-slate-400 text-4xl">person</span>
                    </div>
                    <div class="space-y-1">
                        <p id="profile-name" class="text-xl font-semibold text-slate-900">-</p>
                        <p id="profile-username" class="text-sm text-slate-500">-</p>
                        <p id="profile-email" class="text-sm text-slate-500">-</p>
                        <p id="profile-phone" class="text-sm text-slate-500">-</p>
                    </div>
                </div>
                <div class="mt-4 md:mt-0">
                    <p class="text-sm text-slate-500">โรงเรียน</p>
                    <p id="profile-school" class="text-lg font-semibold text-slate-900">-</p>
                    <p id="profile-cluster" class="text-sm text-slate-500">-</p>
                </div>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">กิจกรรมที่ลงสมัคร</p>
                    <p id="profile-stats-activities" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">จำนวนทีม</p>
                    <p id="profile-stats-teams" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">นักเรียนทั้งหมด</p>
                    <p id="profile-stats-students" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm text-center">
                    <p class="text-sm text-slate-500">ครูผู้ควบคุม</p>
                    <p id="profile-stats-teachers" class="text-3xl font-bold text-sky-600 mt-1">--</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">รายละเอียดบัญชี</h3>
                        <p class="text-sm text-slate-500">ตรวจสอบข้อมูลผู้ใช้งานและสิทธิ์ปัจจุบัน</p>
                    </div>
                    <span id="profile-role-badge" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 bg-slate-50">
                        <span class="material-symbols-outlined text-base">shield_person</span>
                        <span id="profile-role-label">-</span>
                    </span>
                </div>
                <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm text-slate-600">
                    <div>
                        <dt class="font-medium text-slate-500">ชื่อผู้ใช้</dt>
                        <dd id="profile-detail-username" class="text-slate-900 break-all">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">สิทธิ์การใช้งาน</dt>
                        <dd id="profile-detail-level" class="text-slate-900">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">อีเมล</dt>
                        <dd id="profile-detail-email" class="text-slate-900 break-all">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">เบอร์ติดต่อ</dt>
                        <dd id="profile-detail-tel" class="text-slate-900">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">โรงเรียน</dt>
                        <dd id="profile-detail-school" class="text-slate-900">-</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-slate-500">เครือข่าย</dt>
                        <dd id="profile-detail-cluster" class="text-slate-900">-</dd>
                    </div>
                </dl>
                <p id="profile-permission-note" class="mt-4 text-xs text-slate-500"></p>
            </div>

            <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">ทีมของคุณ</h3>
                        <p class="text-sm text-slate-500">ดูสถานะทีมและจัดการสมาชิก</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50" onclick="loadRegisteredTeams(true)">
                            <span class="material-symbols-outlined text-base">refresh</span>
                            <span>รีเฟรช</span>
                        </button>
                        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50" onclick="navigateTo('section-teams')">
                            <span class="material-symbols-outlined text-base">table</span>
                            <span>เปิดตารางทีม</span>
                        </button>
                    </div>
                </div>
                <div id="profile-team-list" class="space-y-3 text-sm text-slate-600">
                    <p class="text-slate-500">ยังไม่มีข้อมูลทีม</p>
                </div>
            </div>

            <div class="grid gap-6 lg:grid-cols-2">
                <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm space-y-4">
                    <h3 class="text-lg font-semibold text-slate-900">ข้อมูลโรงเรียน</h3>
                    <dl class="text-sm text-slate-600 space-y-3">
                        <div class="flex items-center justify-between">
                            <dt class="font-medium text-slate-500">รหัสโรงเรียน</dt>
                            <dd id="profile-school-id" class="text-slate-900">-</dd>
                        </div>
                        <div class="flex items-center justify-between">
                            <dt class="font-medium text-slate-500">เครือข่าย/ภูมิภาค</dt>
                            <dd id="profile-school-cluster" class="text-slate-900">-</dd>
                        </div>
                        <div>
                            <dt class="font-medium text-slate-500">หมายเหตุ</dt>
                            <dd class="text-slate-400 text-sm">หากต้องการแก้ไขข้อมูลโรงเรียนเพิ่มเติม กรุณาติดต่อผู้ดูแลระบบ</dd>
                        </div>
                    </dl>
                </div>
                <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-900">แก้ไขข้อมูลติดต่อ</h3>
                            <p class="text-sm text-slate-500">ข้อมูลนี้ใช้ในการติดต่อและออกหนังสือราชการ</p>
                        </div>
                        <span id="profile-form-status" class="text-sm text-slate-500"></span>
                    </div>
                    <form id="profile-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-name-input" class="block text-sm font-medium text-slate-700 mb-1">ชื่อ</label>
                                <input type="text" id="profile-name-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                            <div>
                                <label for="profile-surname-input" class="block text-sm font-medium text-slate-700 mb-1">นามสกุล</label>
                                <input type="text" id="profile-surname-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-email-input" class="block text-sm font-medium text-slate-700 mb-1">อีเมล</label>
                                <input type="email" id="profile-email-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                            <div>
                                <label for="profile-phone-input" class="block text-sm font-medium text-slate-700 mb-1">เบอร์โทรศัพท์</label>
                                <input type="tel" id="profile-phone-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="profile-password-input" class="block text-sm font-medium text-slate-700 mb-1">รหัสผ่านใหม่</label>
                                <input type="password" id="profile-password-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="เว้นว่างหากไม่เปลี่ยน">
                            </div>
                            <div>
                                <label for="profile-password-confirm-input" class="block text-sm font-medium text-slate-700 mb-1">ยืนยันรหัสผ่านใหม่</label>
                                <input type="password" id="profile-password-confirm-input" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="พิมพ์ซ้ำเพื่อยืนยัน">
                            </div>
                        </div>
                        <div>
                            <label for="profile-school-select" class="block text-sm font-medium text-slate-700 mb-1">โรงเรียน</label>
                            <select id="profile-school-select" class="w-full p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="">-- เลือกโรงเรียน --</option>
                            </select>
                        </div>
                        <div class="text-right">
                            <button type="submit" id="profile-form-submit" class="inline-flex items-center gap-2 bg-slate-900 text-white font-semibold px-5 py-2 rounded-lg shadow hover:bg-slate-800 transition-colors">
                                <span class="material-symbols-outlined text-base">save</span>
                                <span>บันทึกการเปลี่ยนแปลง</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- 9. Report -->
    <section id="section-report" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">รายงานสรุปผล</h2>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 text-center">
                <div class="text-3xl font-bold text-sky-600" id="report-total-teams">...</div>
                <div class="text-sm font-medium text-slate-600">ทีมทั้งหมด</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 text-center">
                <div class="text-3xl font-bold text-sky-600" id="report-total-teachers">...</div>
                <div class="text-sm font-medium text-slate-600">ครูทั้งหมด</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 text-center">
                <div class="text-3xl font-bold text-sky-600" id="report-total-students">...</div>
                <div class="text-sm font-medium text-slate-600">นักเรียนทั้งหมด</div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow border border-slate-200 text-center">
                <div class="text-3xl font-bold text-sky-600" id="report-total-all">...</div>
                <div class="text-sm font-medium text-slate-600">รวมสมาชิก</div>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md border border-slate-200">
            <h3 class="text-xl font-semibold mb-4">สรุปตามกิจกรรม</h3>
            <div class="overflow-x-auto no-scrollbar">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">กิจกรรม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">จำนวนทีม</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ครู</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">นักเรียน</th>
                            <th class="p-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">รวม</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="bg-white divide-y divide-slate-200">
                        <tr><td colspan="5" class="p-4 text-center text-slate-500">กำลังโหลดข้อมูลรายงาน...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="report-management-wrapper" class="hidden space-y-6 mt-8">
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">การจัดการผู้ใช้</h3>
                        <p class="text-sm text-slate-500">ดูรายชื่อผู้ใช้ในสิทธิ์ของคุณ (จำกัดตามบทบาท)</p>
                    </div>
                    <button type="button" id="user-management-refresh" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        <span>รีเฟรช</span>
                    </button>
                </div>
                <p id="user-management-status" class="text-xs text-slate-500 mt-3">เฉพาะผู้ใช้ที่มีสิทธิ์</p>
                <div class="mt-4 flex flex-wrap gap-2 hidden" id="user-management-actions">
                    <button type="button" id="user-management-add" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                        <span class="material-symbols-outlined text-base">person_add</span>
                        <span>เพิ่มผู้ใช้</span>
                    </button>
                </div>
                <div id="user-management-content" class="mt-4 space-y-3 text-sm text-slate-600"></div>
                <form id="user-management-form" class="hidden mt-4 border border-slate-200 rounded-xl p-4 bg-slate-50 space-y-3">
                    <div class="flex items-center justify-between">
                        <p id="user-form-title" class="text-sm font-semibold text-slate-800">เพิ่มผู้ใช้ใหม่</p>
                        <button type="button" id="user-management-cancel" class="text-xs text-slate-500 hover:text-slate-700">ยกเลิก</button>
                    </div>
                    <input type="hidden" id="user-form-userid">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ชื่อผู้ใช้</label>
                            <input type="text" id="user-form-username" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ระดับสิทธิ์</label>
                            <select id="user-form-level" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <option value="User">User</option>
                                <option value="School_Admin">School Admin</option>
                                <option value="Group_Admin">Group Admin</option>
                                <option value="Area">Area</option>
                                <option value="Admin">Admin</option>
                                <option value="Score">Score</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ชื่อ</label>
                            <input type="text" id="user-form-name" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">นามสกุล</label>
                            <input type="text" id="user-form-surname" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">อีเมล</label>
                            <input type="email" id="user-form-email" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">เบอร์ติดต่อ</label>
                            <input type="tel" id="user-form-tel" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">รหัสผ่าน (เฉพาะตอนสร้างหรือเปลี่ยน)</label>
                            <input type="password" id="user-form-password" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ปล่อยว่างหากไม่เปลี่ยน">
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600 mb-1 block">ยืนยันรหัสผ่าน</label>
                            <input type="password" id="user-form-password-confirm" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ปล่อยว่างหากไม่เปลี่ยน">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 mb-1 block">โรงเรียน</label>
                        <select id="user-form-school" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="">-- เลือกโรงเรียน --</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100" id="user-form-cancel-btn">ยกเลิก</button>
                        <button type="submit" class="inline-flex items-center gap-2 rounded-lg bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" id="user-form-submit-btn">
                            <span class="material-symbols-outlined text-base">save</span>
                            <span>บันทึกผู้ใช้</span>
                        </button>
                    </div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-900">การจัดการโรงเรียน</h3>
                        <p class="text-sm text-slate-500">ตรวจสอบรายชื่อโรงเรียนในเครือข่ายของคุณ</p>
                    </div>
                    <button type="button" id="school-management-refresh" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 hover:bg-slate-50">
                        <span class="material-symbols-outlined text-base">refresh</span>
                        <span>รีเฟรช</span>
                    </button>
                </div>
                <p id="school-management-status" class="text-xs text-slate-500 mt-3">เฉพาะผู้ใช้ที่มีสิทธิ์</p>
                <div id="school-management-content" class="mt-4 space-y-3 text-sm text-slate-600"></div>
            </div>
        </div>
    </section>

    <!-- 10. Admin Section -->
    <section id="section-admin" class="app-section p-4">
        <h2 class="text-2xl font-bold mb-4 px-2">สำหรับผู้ดูแลระบบ</h2>
        <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
            <h3 class="text-xl font-semibold mb-4">รายการไฟล์ที่รอตรวจสอบ</h3>
            <div id="admin-file-review-list" class="space-y-4">
                <p id="admin-loading" class="text-slate-500">กำลังโหลดรายการ...</p>
            </div>
        </div>
        <div class="mt-6 p-3 bg-slate-100 border border-slate-200 text-slate-700 rounded-lg text-sm">
            <strong>คำแนะนำ (Admin):</strong> ตรวจสอบไฟล์ที่อัปโหลดล่าสุด หากกด "ไม่ผ่าน" กรุณาระบุเหตุผลให้ชัดเจนในช่องหมายเหตุ
        </div>
    </section>

</div>

<!-- Bottom Navbar -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-10">
    <div class="flex flex-nowrap items-stretch gap-1 max-w-5xl mx-auto px-2 overflow-x-auto no-scrollbar">
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50 active" onclick="navigateTo('section-hero', this)">
            <span class="material-symbols-outlined text-2xl">home</span>
            <span class="text-xs block">หน้าหลัก</span>
        </button>
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50" onclick="navigateTo('section-form', this)">
            <span class="material-symbols-outlined text-2xl">assignment</span>
            <span class="text-xs block">ลงทะเบียน</span>
        </button>
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50" onclick="navigateTo('section-teams', this)">
            <span class="material-symbols-outlined text-2xl">groups</span>
            <span class="text-xs block">ทีมของฉัน</span>
        </button>
        <button class="nav-item flex-none md:flex-1 min-w-[4.5rem] p-3 text-center text-slate-600 hover:bg-sky-50" onclick="navigateTo('section-report', this)">
            <span class="material-symbols-outlined text-2xl">monitoring</span>
            <span class="text-xs block">รายงาน</span>
        </button>
        <div id="nav-profile-wrapper" class="relative flex-none md:flex-1 min-w-[4.5rem]">
            <button id="nav-profile-button" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="nav-profile-menu" class="nav-item w-full p-3 text-center text-slate-600 hover:bg-sky-50" onclick="handleNavProfileButton(event)">
                <div class="flex flex-col items-center gap-1">
                    <div class="w-9 h-9 rounded-full border border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                        <img id="nav-profile-avatar" alt="โปรไฟล์" class="hidden w-full h-full object-cover">
                        <span id="nav-profile-avatar-fallback" class="material-symbols-outlined text-2xl text-slate-400">account_circle</span>
                    </div>
                    <span id="nav-profile-label" class="text-xs block">โปรไฟล์</span>
                </div>
            </button>
            <div id="nav-profile-menu" class="hidden absolute bottom-full left-1/2 z-20 mb-3 w-72 max-w-xs -translate-x-1/2 md:w-80">
                <div class="rounded-2xl border border-slate-200 bg-white/95 shadow-2xl backdrop-blur p-4 space-y-4">
                    <div id="nav-profile-menu-guest" class="space-y-4">
                        <div class="rounded-2xl border border-slate-200 bg-slate-50/70 p-3">
                            <p class="text-sm font-semibold text-slate-700 mb-2">เข้าสู่ระบบอย่างรวดเร็ว</p>
                            <form id="nav-login-form" class="space-y-2" onsubmit="handleNavLoginSubmit(event)">
                                <div>
                                    <label for="nav-login-username" class="sr-only">ชื่อผู้ใช้</label>
                                    <input id="nav-login-username" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อผู้ใช้" autocomplete="username" required>
                                </div>
                                <div>
                                    <label for="nav-login-password" class="sr-only">รหัสผ่าน</label>
                                    <input id="nav-login-password" type="password" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="รหัสผ่าน" autocomplete="current-password" required>
                                </div>
                                <button type="submit" id="nav-login-submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                                    <span class="material-symbols-outlined text-base">login</span>
                                    <span>เข้าสู่ระบบ</span>
                                </button>
                                <p id="nav-login-status" class="text-xs text-slate-500 min-h-[1.25rem]"></p>
                            </form>
                        </div>
                        <div class="rounded-2xl border border-dashed border-slate-300 p-3 space-y-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-slate-700">ยังไม่มีบัญชี?</p>
                                    <p class="text-xs text-slate-500">สมัครใช้งานเพื่อสร้างทีมได้ทันที</p>
                                </div>
                                <button type="button" id="nav-signup-toggle" class="inline-flex items-center gap-1 text-xs font-semibold text-sky-600 hover:text-sky-800" onclick="toggleNavSignupForm()">
                                    <span class="material-symbols-outlined text-base" id="nav-signup-toggle-icon">expand_more</span>
                                    <span id="nav-signup-toggle-label">เปิดฟอร์มสมัคร</span>
                                </button>
                            </div>
                            <form id="nav-signup-form" class="hidden space-y-2" onsubmit="handleNavSignupSubmit(event)">
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="nav-signup-name" type="text" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อ" required>
                                    <input id="nav-signup-surname" type="text" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="นามสกุล" required>
                                </div>
                                <div>
                                    <input id="nav-signup-username" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อผู้ใช้" required>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input id="nav-signup-password" type="password" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="รหัสผ่าน" required>
                                    <input id="nav-signup-confirm" type="password" class="rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ยืนยันรหัสผ่าน" required>
                                </div>
                                <div>
                                    <input id="nav-signup-email" type="email" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="อีเมล" required>
                                </div>
                                <div>
                                    <input id="nav-signup-tel" type="tel" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="เบอร์ติดต่อ" required>
                                </div>
                                <div>
                                    <select id="nav-signup-school" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-sky-500">
                                        <option value="">-- เลือกโรงเรียน --</option>
                                    </select>
                                </div>
                                <button type="submit" id="nav-signup-submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-3 py-2 text-xs font-semibold text-white hover:bg-sky-600">
                                    <span class="material-symbols-outlined text-base">person_add</span>
                                    <span>สมัครสมาชิก</span>
                                </button>
                                <p id="nav-signup-status" class="text-xs text-slate-500 min-h-[1.25rem]"></p>
                            </form>
                            <button type="button" class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="openAuthFromProfile('signup')">
                                <span class="material-symbols-outlined text-base">open_in_new</span>
                                <span>เปิดฟอร์มเต็มหน้าจอ</span>
                            </button>
                        </div>
                    </div>
                    <div id="nav-profile-menu-user" class="hidden space-y-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full border border-slate-200 bg-slate-50 flex items-center justify-center overflow-hidden">
                                <img id="nav-profile-menu-avatar" alt="เมนูโปรไฟล์" class="hidden w-full h-full object-cover">
                                <span id="nav-profile-menu-avatar-fallback" class="material-symbols-outlined text-3xl text-slate-400">person</span>
                            </div>
                            <div class="text-sm">
                                <p id="nav-profile-menu-name" class="font-semibold text-slate-900">-</p>
                                <p id="nav-profile-menu-role" class="text-xs uppercase tracking-wide text-slate-500">USER</p>
                                <p id="nav-profile-menu-school" class="text-xs text-slate-500">โรงเรียน: -</p>
                            </div>
                        </div>
                        <div id="nav-profile-avatar-editor" class="hidden space-y-2 rounded-xl border border-dashed border-slate-200 bg-slate-50 p-3 text-sm">
                            <div class="text-xs font-medium text-slate-600">รูปโปรไฟล์</div>
                            <label for="nav-profile-avatar-input" class="inline-flex w-full cursor-pointer items-center justify-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:border-slate-400">
                                <span class="material-symbols-outlined text-base">upload</span>
                                <span>เลือกไฟล์ใหม่</span>
                            </label>
                            <input type="file" id="nav-profile-avatar-input" class="hidden" accept="image/png,image/jpeg">
                            <p id="nav-profile-avatar-status" class="text-xs text-slate-500" data-default-status="รองรับ .jpg, .png ไม่เกิน 2MB">รองรับ .jpg, .png ไม่เกิน 2MB</p>
                            <p id="nav-profile-approval-hint" class="text-[11px] text-amber-600">รูปใหม่จะใช้งานหลังจากโรงเรียนได้รับการอนุมัติจาก Admin</p>
                            <button type="button" id="nav-profile-avatar-submit" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-sky-500 px-3 py-2 text-sm font-semibold text-white hover:bg-sky-600 disabled:cursor-not-allowed disabled:opacity-50">
                                <span class="material-symbols-outlined text-base">check_circle</span>
                                <span>ส่งคำขอเปลี่ยนรูป</span>
                            </button>
                        </div>
                        <div class="space-y-2">
                            <button type="button" class="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="goToProfileSection()">
                                <span class="material-symbols-outlined text-base">account_circle</span>
                                <span>เปิดหน้าโปรไฟล์</span>
                            </button>
                            <button type="button" id="nav-profile-admin-link" class="hidden w-full inline-flex items-center justify-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="goToAdminSection()">
                                <span class="material-symbols-outlined text-base">admin_panel_settings</span>
                                <span>แดชบอร์ดผู้ดูแล</span>
                            </button>
                            <button type="button" id="nav-profile-logout" class="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800">
                                <span class="material-symbols-outlined text-base">logout</span>
                                <span>ออกจากระบบ</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<div id="team-manage-panel" class="fixed inset-0 bg-black/40 z-40 hidden items-end md:items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col max-h-full overflow-hidden relative">
        <div id="team-manage-loading" class="hidden absolute inset-0 bg-white/85 z-20 flex flex-col items-center justify-center gap-3">
            <div class="h-10 w-10 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin"></div>
            <p class="text-sm font-medium text-slate-600">กำลังบันทึกข้อมูลทีม...</p>
        </div>
        <div class="flex items-center justify-between border-b border-slate-200 px-4 py-3">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">จัดการทีม</p>
                <h3 id="team-manage-title" class="text-lg font-semibold text-slate-900">-</h3>
                <p id="team-manage-cluster" class="text-[11px] text-amber-600">เครือข่าย: -</p>
            </div>
            <div class="flex items-center gap-2">
                <span id="team-manage-status-pill" class="px-2 py-1 text-xs font-semibold rounded-full border border-slate-200 text-slate-600">-</span>
                <button type="button" class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200" onclick="closeTeamManager()">
                    <span class="material-symbols-outlined text-base">close</span>
                </button>
            </div>
        </div>
        <div class="overflow-y-auto p-4 space-y-4">
            <div id="team-manage-lock" class="hidden rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-700 flex items-start gap-2">
                <span class="material-symbols-outlined text-base">info</span>
                <p>สถานะทีมกำลัง <strong>Print</strong> ไม่สามารถแก้ไขข้อมูลได้</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <label class="text-xs font-semibold text-slate-500">ชื่อทีม</label>
                    <input id="team-manage-name" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                </div>
            <div class="space-y-3">
                <label class="text-xs font-semibold text-slate-500">สถานะ</label>
                <select id="team-manage-status" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Print">Print</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <p id="team-manage-status-hint" class="text-[11px] text-slate-500">สิทธิ์ Admin/Area เท่านั้นที่สามารถแก้สถานะได้</p>
            </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-slate-500">ผู้ประสานงาน</label>
                    <input id="team-manage-contact-name" type="text" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="ชื่อ-นามสกุล">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-slate-500">เบอร์ติดต่อ</label>
                    <input id="team-manage-contact-phone" type="tel" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="08x-xxx-xxxx" data-only-digits="true" inputmode="numeric" pattern="[0-9]*">
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-slate-500">อีเมล</label>
                    <input id="team-manage-contact-email" type="email" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="example@mail.com">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">โลโก้ทีม</p>
                            <p class="text-xs text-slate-500">อัปเดตโลโก้สำหรับบัตร/รายงาน</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 rounded-2xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                            <img id="team-manage-logo-preview" alt="Team logo preview" class="hidden w-full h-full object-cover">
                            <span id="team-manage-logo-placeholder" class="material-symbols-outlined text-slate-400 text-3xl">image</span>
                        </div>
                        <div class="flex-1 text-xs space-y-2">
                            <p id="team-manage-logo-status" class="text-slate-500" data-default-status="รองรับ .png, .jpg ไม่เกิน 2MB (School Admin / Group Admin / Area / Admin)">รองรับ .png, .jpg ไม่เกิน 2MB (School Admin / Group Admin / Area / Admin)</p>
                            <input id="team-manage-logo-input" type="file" class="w-full text-xs text-slate-500 file:mr-3 file:rounded-lg file:border-0 file:bg-sky-100 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-sky-700 hover:file:bg-sky-200" accept="image/png,image/jpeg" disabled>
                        </div>
                    </div>
                </div>
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">รูปทีม</p>
                            <p class="text-xs text-slate-500">รูปถ่ายรวมทีม ใช้ในแสดงผล/รายงาน</p>
                        </div>
                        <button type="button" id="team-manage-photo-open" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-2 py-1 text-[11px] text-slate-600 hover:bg-slate-50" disabled>
                            <span class="material-symbols-outlined text-base">open_in_new</span>
                            ดูรูป
                        </button>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="w-24 h-16 rounded-2xl border border-dashed border-slate-300 bg-slate-50 flex items-center justify-center overflow-hidden">
                            <img id="team-manage-photo-preview" alt="Team photo preview" class="hidden w-full h-full object-cover">
                            <span id="team-manage-photo-placeholder" class="material-symbols-outlined text-slate-400 text-3xl">group</span>
                        </div>
                        <div class="flex-1 text-xs space-y-2">
                            <p id="team-manage-photo-status" class="text-slate-500" data-default-status="รองรับ .png, .jpg ไม่เกิน 3MB (School Admin / Group Admin / Area / Admin)">รองรับ .png, .jpg ไม่เกิน 3MB (School Admin / Group Admin / Area / Admin)</p>
                            <input id="team-manage-photo-input" type="file" class="w-full text-xs text-slate-500 file:mr-3 file:rounded-lg file:border-0 file:bg-sky-100 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-sky-700 hover:file:bg-sky-200" accept="image/png,image/jpeg" disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">ครูผู้ควบคุมทีม</p>
                            <p class="text-xs text-slate-500">เพิ่มหรือลบครูได้ตามสิทธิ์</p>
                        </div>
                        <button type="button" class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50" onclick="addManagedMember('teacher')" id="team-add-teacher-btn">
                            <span class="material-symbols-outlined text-base">add</span>
                        </button>
                    </div>
                    <div id="team-manage-teachers" class="space-y-2 text-sm text-slate-600"></div>
                </div>
                <div class="rounded-2xl border border-slate-200 p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-800">นักเรียนในทีม</p>
                            <p class="text-xs text-slate-500">ระบุชื่อและระดับชั้น</p>
                        </div>
                        <button type="button" class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50" onclick="addManagedMember('student')" id="team-add-student-btn">
                            <span class="material-symbols-outlined text-base">add</span>
                        </button>
                    </div>
                    <div id="team-manage-students" class="space-y-2 text-sm text-slate-600"></div>
                </div>
            </div>
        </div>
        <div class="border-t border-slate-200 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <p id="team-manage-feedback" class="text-xs text-slate-500">ปรับปรุงข้อมูลให้ถูกต้องก่อนบันทึก</p>
            <div class="flex flex-wrap justify-end gap-2">
                <button type="button" class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-50" onclick="closeTeamManager()">ปิด</button>
                <button type="button" id="team-manage-delete" class="inline-flex items-center gap-2 rounded-lg border border-red-200 bg-red-50 px-4 py-2 text-sm font-semibold text-red-600 hover:bg-red-100" onclick="deleteActiveTeam()">ลบทีม</button>
                <button type="button" id="team-manage-save" class="inline-flex items-center gap-2 rounded-lg bg-sky-500 px-4 py-2 text-sm font-semibold text-white hover:bg-sky-600" onclick="saveManagedTeam()">บันทึกการเปลี่ยนแปลง</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ดูรูปทีม/สมาชิก + รายละเอียดกิจกรรม -->
<div id="team-photo-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl p-6 relative">
        <button type="button"
                class="absolute top-3 right-3 w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600"
                onclick="closeTeamPhotoModal()">
            ?
        </button>
        <div id="team-photo-modal-content" class="space-y-4 text-slate-700">
            <!-- เนื้อหาเติมด้วย JS -->
        </div>
    </div>
</div>

<script>
    // --- Global State ---
    let ALL_ACTIVITIES = [];
    let ALL_TEAMS = [];
    let CURRENT_STEP = 1;
    let LOGO_FILE_DATA = null;
    let TEAM_PHOTO_FILE_DATA = null;
    let USER_AVATAR_FILE_DATA = null;
    let PROFILE_AVATAR_FILE_DATA = null;
    const MEMBER_PHOTO_DATA = {};
    const homeActivityState = {
        search: '',
        category: '',
        visibleCount: 9,
        pageSize: 9
    };
    let homeSearchDebounce = null;
    let teamSearchTerm = '';
    let teamSearchDebounce = null;
    let isLoadingActivities = false;
    let isLoadingTeams = false;
    let isLoadingReport = false;
    let suppressCategorySync = false;
    const FETCH_COOLDOWN_MS = 30000;
    let lastActivitiesFetch = 0;
    let lastTeamsFetch = 0;
    let lastReportFetch = 0;
    let cachedReport = null;
    let SCHOOL_OPTIONS = [];
    let SCHOOL_LOOKUP_BY_NAME = new Map();
    let SCHOOL_LOOKUP_BY_ID = new Map();
    let isLoadingSchools = false;
    let lastSchoolFetch = 0;
    const SCHOOL_FETCH_COOLDOWN_MS = 60000;
    let SCHOOL_CLUSTER_LOOKUP = new Map();
    let currentUser = null;
    let isAppAdmin = false;
    const AUTH_STORAGE_KEY = 'registration-app-user';
    let isProfileMenuOpen = false;
    let navSignupFormVisible = false;
    let navAuthBusyState = { login: false, signup: false };
    let activeManagedTeam = null;
    let managedTeamMembers = { teachers: [], students: [] };
    let teamManageEditable = false;
    let teamManageStatusEditable = false;
    let teamManageImageEditable = false;
    let teamManageLogoFileData = null;
    let teamManagePhotoFileData = null;
    let MANAGED_USERS = [];
    let MANAGED_SCHOOLS = [];
    let isLoadingManagedUsers = false;
    let isLoadingManagedSchools = false;
    let userFormMode = 'create';
    let isSavingManagedUser = false;
    let isUpdatingSchoolCluster = false;
    const TEAM_MANAGE_MEMBER_PHOTO_DATA = {};
    let homeCountdownInterval = null;
    let homeCountdownElements = [];
    const DEADLINE_WARNING_HOURS = 72;
    const CLASS_LEVEL_OPTIONS = [
        'อนุบาล 1', 'อนุบาล 2', 'อนุบาล 3',
        'ป.1', 'ป.2', 'ป.3', 'ป.4', 'ป.5', 'ป.6',
        'ม.1', 'ม.2', 'ม.3', 'ม.4', 'ม.5', 'ม.6',
        'ปวช.1', 'ปวช.2', 'ปวช.3'
    ];

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const sections = document.querySelectorAll('.app-section');
    const navItems = document.querySelectorAll('.nav-item');
    const navProfileWrapper = document.getElementById('nav-profile-wrapper');
    const navProfileButton = document.getElementById('nav-profile-button');
    const navProfileAvatar = document.getElementById('nav-profile-avatar');
    const navProfileAvatarFallback = document.getElementById('nav-profile-avatar-fallback');
    const navProfileLabel = document.getElementById('nav-profile-label');
    const navProfileMenu = document.getElementById('nav-profile-menu');
    const navProfileMenuGuest = document.getElementById('nav-profile-menu-guest');
    const navProfileMenuUser = document.getElementById('nav-profile-menu-user');
    const navProfileMenuAvatar = document.getElementById('nav-profile-menu-avatar');
    const navProfileMenuAvatarFallback = document.getElementById('nav-profile-menu-avatar-fallback');
    const navProfileMenuName = document.getElementById('nav-profile-menu-name');
    const navProfileMenuRole = document.getElementById('nav-profile-menu-role');
    const navProfileMenuSchool = document.getElementById('nav-profile-menu-school');
    const navProfileAvatarEditor = document.getElementById('nav-profile-avatar-editor');
    const navProfileAvatarInput = document.getElementById('nav-profile-avatar-input');
    const navProfileAvatarStatus = document.getElementById('nav-profile-avatar-status');
    const navProfileAvatarSubmit = document.getElementById('nav-profile-avatar-submit');
    const navProfileApprovalHint = document.getElementById('nav-profile-approval-hint');
    const navProfileAdminLink = document.getElementById('nav-profile-admin-link');
    const navProfileLogoutButton = document.getElementById('nav-profile-logout');
    const navLoginForm = document.getElementById('nav-login-form');
    const navLoginUsernameInput = document.getElementById('nav-login-username');
    const navLoginPasswordInput = document.getElementById('nav-login-password');
    const navLoginStatus = document.getElementById('nav-login-status');
    const navLoginSubmitButton = document.getElementById('nav-login-submit');
    const navSignupToggle = document.getElementById('nav-signup-toggle');
    const navSignupToggleIcon = document.getElementById('nav-signup-toggle-icon');
    const navSignupToggleLabel = document.getElementById('nav-signup-toggle-label');
    const navSignupForm = document.getElementById('nav-signup-form');
    const navSignupStatus = document.getElementById('nav-signup-status');
    const navSignupSubmitButton = document.getElementById('nav-signup-submit');
    const navSignupNameInput = document.getElementById('nav-signup-name');
    const navSignupSurnameInput = document.getElementById('nav-signup-surname');
    const navSignupUsernameInput = document.getElementById('nav-signup-username');
    const navSignupPasswordInput = document.getElementById('nav-signup-password');
    const navSignupConfirmInput = document.getElementById('nav-signup-confirm');
    const navSignupEmailInput = document.getElementById('nav-signup-email');
    const navSignupTelInput = document.getElementById('nav-signup-tel');
    const navSignupSchoolSelect = document.getElementById('nav-signup-school');
    const homeActivitySearchInput = document.getElementById('home-activity-search');
    const homeActivityContainer = document.getElementById('home-activity-container');
    const homeActivityMeta = document.getElementById('home-activity-meta');
    const homeActivityLoadMoreBtn = document.getElementById('home-activity-load-more');
    const homeActivityEmpty = document.getElementById('home-activity-empty');
    const homeCategoryFilter = document.getElementById('home-category-filter');
    const activityContainer = document.getElementById('activity-container');
    const activityLoading = document.getElementById('activity-loading');
    const teamTableBody = document.getElementById('team-table-body');
    const teamScopeBanner = document.getElementById('team-scope-banner');
    const teamScopeText = document.getElementById('team-scope-text');
    const reportTableBody = document.getElementById('report-table-body');
    const adminReviewList = document.getElementById('admin-file-review-list');
    const adminLoading = document.getElementById('admin-loading');
    const reportManagementWrapper = document.getElementById('report-management-wrapper');
    const userManagementContent = document.getElementById('user-management-content');
    const userManagementStatus = document.getElementById('user-management-status');
    const userManagementRefreshBtn = document.getElementById('user-management-refresh');
    const userManagementActions = document.getElementById('user-management-actions');
    const userManagementAddButton = document.getElementById('user-management-add');
    const userManagementForm = document.getElementById('user-management-form');
    const userManagementCancelLink = document.getElementById('user-management-cancel');
    const userFormTitle = document.getElementById('user-form-title');
    const userFormUserId = document.getElementById('user-form-userid');
    const userFormUsername = document.getElementById('user-form-username');
    const userFormLevel = document.getElementById('user-form-level');
    const userFormName = document.getElementById('user-form-name');
    const userFormSurname = document.getElementById('user-form-surname');
    const userFormEmail = document.getElementById('user-form-email');
    const userFormTel = document.getElementById('user-form-tel');
    const userFormPassword = document.getElementById('user-form-password');
    const userFormPasswordConfirm = document.getElementById('user-form-password-confirm');
    const userFormSchoolSelect = document.getElementById('user-form-school');
    const userFormSubmitBtn = document.getElementById('user-form-submit-btn');
    const userFormSubmitLabel = userFormSubmitBtn ? userFormSubmitBtn.querySelector('span:last-child') : null;
    const userFormCancelBtn = document.getElementById('user-form-cancel-btn');
    const schoolManagementContent = document.getElementById('school-management-content');
    const schoolManagementStatus = document.getElementById('school-management-status');
    const schoolManagementRefreshBtn = document.getElementById('school-management-refresh');

    // Form elements
    const form = document.getElementById('registration-form');
    const formSteps = document.querySelectorAll('.form-step');
    const stepIndicators = document.querySelectorAll('.step-indicator');
    const activityCategorySelect = document.getElementById('form-activity-category');
    const activitySelect = document.getElementById('form-activity');
    const levelSelect = document.getElementById('form-level');
    const schoolInput = document.getElementById('form-school');
    const schoolOptionsList = document.getElementById('school-options');
    const logoInput = document.getElementById('form-logo');
    const logoStatus = document.getElementById('logo-status');
    const formLogoPreview = document.getElementById('form-logo-preview');
    const formLogoPlaceholder = document.getElementById('form-logo-placeholder');
    const teamPhotoInput = document.getElementById('form-team-photo');
    const teamPhotoPreview = document.getElementById('team-photo-preview');
    const teamPhotoPlaceholder = document.getElementById('team-photo-placeholder');
    const teamPhotoStatus = document.getElementById('team-photo-status');
    const memberReqText = document.getElementById('member-requirements');
    const teacherFields = document.getElementById('teacher-fields');
    const studentFields = document.getElementById('student-fields');
    const submitButton = document.getElementById('form-submit-button');

    // Upload elements
    const uploadButton = document.getElementById('upload-button');
    const fileInput = document.getElementById('file-input');
    const uploadTeamIdSelect = document.getElementById('upload-team-id');
    const uploadFileTypeSelect = document.getElementById('upload-file-type');
    const uploadStatusDiv = document.getElementById('upload-status');
    const teamSearchInput = document.getElementById('team-search');
    const authSignupForm = document.getElementById('auth-signup-form');
    const authLoginForm = document.getElementById('auth-login-form');
    const authSchoolSelect = document.getElementById('auth-school-select');
    const signupStatus = document.getElementById('signup-status');
    const loginStatus = document.getElementById('login-status');
    const signupNameInput = document.getElementById('signup-name');
    const signupSurnameInput = document.getElementById('signup-surname');
    const signupTelInput = document.getElementById('signup-tel');
    const signupEmailInput = document.getElementById('signup-email');
    const signupAvatarInput = document.getElementById('signup-avatar');
    const signupAvatarPreview = document.getElementById('signup-avatar-preview');
    const signupAvatarPlaceholder = document.getElementById('signup-avatar-placeholder');
    const signupAvatarStatus = document.getElementById('signup-avatar-status');
    const signupUsernameInput = document.getElementById('signup-username');
    const signupPasswordInput = document.getElementById('signup-password');
    const signupConfirmPasswordInput = document.getElementById('signup-confirm-password');
    const loginUsernameInput = document.getElementById('login-username');
    const loginPasswordInput = document.getElementById('login-password');
    const loginFormWrapper = document.getElementById('login-form-wrapper');
    const loginSubmitButton = document.getElementById('login-submit-button');
    const loginProgressIndicator = document.getElementById('login-progress-indicator');
    const signupFormContainer = document.getElementById('signup-form-container');
    const toggleSignupFormBtn = document.getElementById('toggle-signup-form');
    const toggleSignupFormText = document.getElementById('toggle-signup-form-text');
    const toggleSignupFormIcon = document.getElementById('toggle-signup-form-icon');
    const signupCard = document.getElementById('signup-card');
    const authUserPanel = document.getElementById('auth-user-panel');
    const authUserSummary = document.getElementById('auth-user-summary');
    const authUserSchool = document.getElementById('auth-user-school');
    const authUserEmail = document.getElementById('auth-user-email');
    const authUserAvatar = document.getElementById('auth-user-avatar');
    const authUserAvatarPlaceholder = document.getElementById('auth-user-avatar-placeholder');
    const logoutButton = document.getElementById('logout-button');
    const registrationFieldset = document.getElementById('registration-fieldset');
    const registrationLockNotice = document.getElementById('registration-lock-notice');
    const contactNameInput = document.getElementById('contact-name');
    const contactPhoneInput = document.getElementById('contact-phone');
    const contactEmailInput = document.getElementById('contact-email');
    const profileGuestNotice = document.getElementById('profile-guest-notice');
    const profileContent = document.getElementById('profile-content');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileAvatarFallback = document.getElementById('profile-avatar-fallback');
    const profileNameDisplay = document.getElementById('profile-name');
    const profileUsernameDisplay = document.getElementById('profile-username');
    const profileEmailDisplay = document.getElementById('profile-email');
    const profilePhoneDisplay = document.getElementById('profile-phone');
    const profileSchoolDisplay = document.getElementById('profile-school');
    const profileClusterDisplay = document.getElementById('profile-cluster');
    const profileSchoolIdDisplay = document.getElementById('profile-school-id');
    const profileSchoolClusterDisplay = document.getElementById('profile-school-cluster');
    const profileStatsActivities = document.getElementById('profile-stats-activities');
    const profileStatsTeams = document.getElementById('profile-stats-teams');
    const profileStatsStudents = document.getElementById('profile-stats-students');
    const profileStatsTeachers = document.getElementById('profile-stats-teachers');
    const profileLogoutButton = document.getElementById('profile-logout-btn');
    const profileRoleBadge = document.getElementById('profile-role-badge');
    const profileRoleLabel = document.getElementById('profile-role-label');
    const profileDetailUsername = document.getElementById('profile-detail-username');
    const profileDetailLevel = document.getElementById('profile-detail-level');
    const profileDetailEmail = document.getElementById('profile-detail-email');
    const profileDetailTel = document.getElementById('profile-detail-tel');
    const profileDetailSchool = document.getElementById('profile-detail-school');
    const profileDetailCluster = document.getElementById('profile-detail-cluster');
    const profilePermissionNote = document.getElementById('profile-permission-note');
    const profileTeamList = document.getElementById('profile-team-list');
    const profileForm = document.getElementById('profile-form');
    const profileFormStatus = document.getElementById('profile-form-status');
    const profileNameInput = document.getElementById('profile-name-input');
    const profileSurnameInput = document.getElementById('profile-surname-input');
    const profileEmailInput = document.getElementById('profile-email-input');
    const profilePhoneInput = document.getElementById('profile-phone-input');
    const profilePasswordInput = document.getElementById('profile-password-input');
    const profilePasswordConfirmInput = document.getElementById('profile-password-confirm-input');
    const profileSchoolSelect = document.getElementById('profile-school-select');
    const profileFormSubmitButton = document.getElementById('profile-form-submit');
    const teamManagePanel = document.getElementById('team-manage-panel');
    const teamManageTitle = document.getElementById('team-manage-title');
    const teamManageStatusPill = document.getElementById('team-manage-status-pill');
    const teamManageStatusHint = document.getElementById('team-manage-status-hint');
    const teamManageClusterLabel = document.getElementById('team-manage-cluster');
    const teamManageLockNotice = document.getElementById('team-manage-lock');
    const teamManageNameInput = document.getElementById('team-manage-name');
    const teamManageStatusSelect = document.getElementById('team-manage-status');
    const teamManageContactNameInput = document.getElementById('team-manage-contact-name');
    const teamManageContactPhoneInput = document.getElementById('team-manage-contact-phone');
    const teamManageContactEmailInput = document.getElementById('team-manage-contact-email');
    const teamManageTeachersContainer = document.getElementById('team-manage-teachers');
    const teamManageStudentsContainer = document.getElementById('team-manage-students');
    const teamManageFeedback = document.getElementById('team-manage-feedback');
    const teamManageSaveButton = document.getElementById('team-manage-save');
    const teamManageDeleteButton = document.getElementById('team-manage-delete');
    const teamAddTeacherBtn = document.getElementById('team-add-teacher-btn');
    const teamAddStudentBtn = document.getElementById('team-add-student-btn');
    const teamManageLoadingOverlay = document.getElementById('team-manage-loading');
    const teamManageLogoPreview = document.getElementById('team-manage-logo-preview');
    const teamManageLogoPlaceholder = document.getElementById('team-manage-logo-placeholder');
    const teamManageLogoStatus = document.getElementById('team-manage-logo-status');
    const teamManageLogoInput = document.getElementById('team-manage-logo-input');
    const teamManagePhotoPreview = document.getElementById('team-manage-photo-preview');
    const teamManagePhotoPlaceholder = document.getElementById('team-manage-photo-placeholder');
    const teamManagePhotoStatus = document.getElementById('team-manage-photo-status');
    const teamManagePhotoInput = document.getElementById('team-manage-photo-input');
    const teamManagePhotoOpen = document.getElementById('team-manage-photo-open');

    // --- Utility functions ---
    function showLoading() {
        loadingOverlay.style.display = 'flex';
    }
    function hideLoading() {
        loadingOverlay.style.display = 'none';
    }
    function handleError(error) {
        hideLoading();
        const message = error && error.message ? error.message : 'ไม่ทราบสาเหตุ';
        console.error(error);
        Swal.fire({
            icon: 'error',
            title: 'เกิดข้อผิดพลาด',
            text: message
        });
    }
    function formatDeadline(deadlineIso, fallbackText = 'ไม่ระบุ') {
        if (!deadlineIso) return fallbackText;
        const parsed = new Date(deadlineIso);
        if (Number.isNaN(parsed.getTime())) return fallbackText;
        const options = { dateStyle: 'long', timeStyle: 'short', hour12: false };
        return parsed.toLocaleString('th-TH', options);
    }
    function calculateRemainingTeams(activity) {
        if (!activity) return null;
        const maxTeams = typeof activity.maxTeams === 'number' && activity.maxTeams > 0 ? activity.maxTeams : null;
        if (maxTeams === null) return null;
        const currentTeams = Number(activity.currentTeams || 0);
        const remaining = activity.remainingTeams ?? (maxTeams - currentTeams);
        return Math.max(remaining, 0);
    }
    function safeJsonParse(value, fallback = {}) {
        if (value === null || value === undefined || value === '') return fallback;
        if (typeof value === 'object') return value;
        try { return JSON.parse(value); } catch { return fallback; }
    }

    function showAuthStatus(target, message = '', type = 'info') {
        if (!target) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500',
            warning: 'text-amber-600'
        };
        target.textContent = message || '';
        target.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500', 'text-amber-600');
        target.classList.add(classMap[type] || classMap.info);
    }

    function setSignupFormVisibility(show) {
        if (!signupFormContainer || !toggleSignupFormBtn) return;
        signupFormContainer.classList.toggle('hidden', !show);
        toggleSignupFormBtn.setAttribute('aria-expanded', show ? 'true' : 'false');
        if (toggleSignupFormText) {
            toggleSignupFormText.textContent = show ? 'ซ่อนฟอร์มสมัครสมาชิก' : 'เปิดฟอร์มสมัครสมาชิก';
        }
        if (toggleSignupFormIcon) {
            toggleSignupFormIcon.textContent = show ? 'expand_less' : 'expand_more';
        }
    }

    function toggleSignupFormVisibility(event) {
        if (event) event.preventDefault();
        if (!signupFormContainer) return;
        const willShow = signupFormContainer.classList.contains('hidden');
        setSignupFormVisibility(willShow);
    }

    function setCurrentUser(user, { persist = true } = {}) {
        currentUser = user ? { ...user } : null;
        if (persist) {
            try {
                if (currentUser) {
                    localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(currentUser));
                } else {
                    localStorage.removeItem(AUTH_STORAGE_KEY);
                }
            } catch (error) {
                console.warn('Persist user session failed', error);
            }
        }
        updateAuthUI();
        updateRegistrationAccess();
        applyUserSchoolToForm();
        if (currentUser) {
            applyUserContactToForm();
        } else {
            applyUserContactToForm({ force: true });
        }
        if (Array.isArray(ALL_TEAMS) && ALL_TEAMS.length > 0) {
            renderTeamTable(ALL_TEAMS);
            populateUploadTeamSelect(ALL_TEAMS);
        }
        if (currentUser && (!Array.isArray(ALL_TEAMS) || ALL_TEAMS.length === 0)) {
            loadRegisteredTeams();
        }
        updateProfileSection();
        updateReportManagementVisibility();
    }

    function restoreUserSession() {
        try {
            const raw = localStorage.getItem(AUTH_STORAGE_KEY);
            if (!raw) return;
            const parsed = JSON.parse(raw);
            if (parsed && parsed.username) {
                setCurrentUser(parsed, { persist: false });
            }
        } catch (error) {
            console.warn('Restore user session failed', error);
        }
    }

    function clearUserSession() {
        setCurrentUser(null);
    }

    function setLoginFormDisabled(disabled) {
        if (!authLoginForm) return;
        const elements = authLoginForm.querySelectorAll('input, button');
        elements.forEach(el => {
            el.disabled = disabled;
            if (disabled) {
                el.classList.add('opacity-60', 'cursor-not-allowed');
            } else {
                el.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        });
    }

    function setLoginBusyState(isBusy) {
        if (loginProgressIndicator) {
            loginProgressIndicator.classList.toggle('hidden', !isBusy);
        }
        if (!loginSubmitButton) return;
        if (!loginSubmitButton.dataset.defaultLabel) {
            loginSubmitButton.dataset.defaultLabel = loginSubmitButton.innerHTML;
        }
        if (isBusy) {
            loginSubmitButton.innerHTML = `
                <span class="inline-flex items-center justify-center gap-2 w-full">
                    <span class="h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                    กำลังเข้าสู่ระบบ...
                </span>
            `;
        } else {
            loginSubmitButton.innerHTML = loginSubmitButton.dataset.defaultLabel || 'เข้าสู่ระบบ';
        }
    }

    function getSchoolDisplayNameById(schoolId) {
        const info = getSchoolInfoById(schoolId);
        return info ? info.name : '';
    }

    function getSchoolInfoById(schoolId) {
        if (!schoolId) return null;
        const normalized = normalizeText(schoolId);
        if (SCHOOL_LOOKUP_BY_ID instanceof Map && SCHOOL_LOOKUP_BY_ID.size > 0) {
            const match = SCHOOL_LOOKUP_BY_ID.get(normalized);
            if (match) return match;
        }
        if (!Array.isArray(SCHOOL_OPTIONS) || SCHOOL_OPTIONS.length === 0) return null;
        return SCHOOL_OPTIONS.find(school => {
            if (!school) return false;
            const idMatch = school.id && normalizeText(school.id) === normalized;
            const nameMatch = school.name && normalizeText(school.name) === normalized;
            return idMatch || nameMatch;
        }) || null;
    }

    function getSchoolClusterName(info) {
        if (!info) return '';
        const directName = info.clusterName || info.cluster || '';
        if (directName) return directName;
        const clusterId = info.clusterId || info.schoolClusterId || info.SchoolClusterID || '';
        if (!clusterId) return '';
        const normalized = normalizeText(clusterId);
        return SCHOOL_CLUSTER_LOOKUP.get(normalized) || clusterId;
    }

    function getSchoolClusterId(info) {
        if (!info) return '';
        return info.clusterId || info.cluster || '';
    }

    function updateSchoolClusterLookup(schools) {
        SCHOOL_CLUSTER_LOOKUP.clear();
        if (!Array.isArray(schools)) return;
        schools.forEach(school => {
            if (!school) return;
            const clusterIdRaw = (school.clusterId || school.schoolClusterId || school.SchoolClusterID || '').toString();
            const normalized = normalizeText(clusterIdRaw);
            if (!normalized) return;
            const label = school.clusterName || school.cluster || '';
            if (label) {
                SCHOOL_CLUSTER_LOOKUP.set(normalized, label);
            }
        });
    }

    function getSchoolInfoByName(name) {
        if (!name || !(SCHOOL_LOOKUP_BY_NAME instanceof Map)) return null;
        const normalized = normalizeText(name);
        if (!normalized) return null;
        return SCHOOL_LOOKUP_BY_NAME.get(normalized) || null;
    }

    function applyUserSchoolToForm() {
        if (!schoolInput) return;
        const level = getCurrentUserLevel();
        const enforceReadonly = Boolean(currentUser && currentUser.schoolId) && !['admin', 'area', 'group_admin'].includes(level);
        if (enforceReadonly) {
            const schoolName = getSchoolDisplayNameById(currentUser.schoolId) || currentUser.schoolId;
            schoolInput.value = schoolName;
        }
        schoolInput.readOnly = enforceReadonly;
        schoolInput.classList.toggle('bg-slate-100', enforceReadonly);
        schoolInput.classList.toggle('cursor-not-allowed', enforceReadonly);
        if (!enforceReadonly && !currentUser) {
            schoolInput.value = '';
        }
    }

    function applyUserContactToForm({ force = false } = {}) {
        if (!contactNameInput || !contactPhoneInput || !contactEmailInput) return;
        if (!currentUser) {
            if (force) {
                [contactNameInput, contactPhoneInput, contactEmailInput].forEach(input => {
                    if (!input) return;
                    input.value = '';
                    input.dataset.autofilled = 'false';
                });
            }
            return;
        }
        const fullName = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || '';
        const mappings = [
            { input: contactNameInput, value: fullName },
            { input: contactPhoneInput, value: currentUser.tel || currentUser.phone || '' },
            { input: contactEmailInput, value: currentUser.email || '' }
        ];
        mappings.forEach(({ input, value }) => {
            if (!input || !value) return;
            const isEmpty = !(input.value || '').trim();
            const autofillState = input.dataset.autofilled;
            const wasAutofilled = autofillState === 'true';
            const neverAutofilled = autofillState === undefined;
            if (force || wasAutofilled || (neverAutofilled && isEmpty)) {
                input.value = value;
                input.dataset.autofilled = 'true';
            }
        });
    }

    function markContactFieldManual(event) {
        if (event && event.target) {
            event.target.dataset.autofilled = 'false';
        }
    }

    function handleStartRegistration(event) {
        if (event) event.preventDefault();
        if (currentUser) {
            navigateTo('section-form');
            return;
        }
        navigateTo('section-auth');
        setSignupFormVisibility(false);
        loginUsernameInput?.focus();
        showAuthStatus(loginStatus, 'กรุณาเข้าสู่ระบบก่อนลงทะเบียน', 'info');
    }

    function showNavAuthStatus(target, message = '', type = 'info') {
        if (!target) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        target.textContent = message;
        target.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        target.classList.add(classMap[type] || classMap.info);
    }

    function toggleNavSignupForm() {
        if (!navSignupForm) {
            openAuthFromProfile('signup');
            return;
        }
        navSignupFormVisible = !navSignupFormVisible;
        navSignupForm.classList.toggle('hidden', !navSignupFormVisible);
        if (navSignupToggleIcon) navSignupToggleIcon.textContent = navSignupFormVisible ? 'expand_less' : 'expand_more';
        if (navSignupToggleLabel) navSignupToggleLabel.textContent = navSignupFormVisible ? 'ปิดฟอร์มสมัคร' : 'เปิดฟอร์มสมัคร';
    }

    function setNavLoginBusyState(isBusy) {
        navAuthBusyState.login = isBusy;
        if (navLoginSubmitButton) {
            navLoginSubmitButton.disabled = isBusy;
            navLoginSubmitButton.classList.toggle('opacity-60', isBusy);
        }
        if (navLoginUsernameInput) navLoginUsernameInput.disabled = isBusy;
        if (navLoginPasswordInput) navLoginPasswordInput.disabled = isBusy;
    }

    function resetNavLoginForm() {
        if (navLoginForm) navLoginForm.reset();
        showNavAuthStatus(navLoginStatus, '');
    }

    function handleNavLoginSubmit(event) {
        if (event) event.preventDefault();
        if (navAuthBusyState.login) return;
        const username = (navLoginUsernameInput?.value || '').trim();
        const password = (navLoginPasswordInput?.value || '').trim();
        if (!username || !password) {
            showNavAuthStatus(navLoginStatus, 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'error');
            return;
        }
        setNavLoginBusyState(true);
        showNavAuthStatus(navLoginStatus, 'กำลังตรวจสอบ...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setNavLoginBusyState(false);
                if (response && response.success && response.user) {
                    showNavAuthStatus(navLoginStatus, 'เข้าสู่ระบบสำเร็จ', 'success');
                    resetNavLoginForm();
                    setCurrentUser(response.user);
                    closeProfileMenu();
                    navigateTo('section-form');
                } else {
                    showNavAuthStatus(navLoginStatus, (response && response.error) || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
                }
            })
            .withFailureHandler(error => {
                setNavLoginBusyState(false);
                showNavAuthStatus(navLoginStatus, error.message || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
            })
            .loginUser({ username, password });
    }

    function setNavSignupBusyState(isBusy) {
        navAuthBusyState.signup = isBusy;
        if (navSignupSubmitButton) {
            navSignupSubmitButton.disabled = isBusy;
            navSignupSubmitButton.classList.toggle('opacity-60', isBusy);
        }
        [
            navSignupNameInput,
            navSignupSurnameInput,
            navSignupUsernameInput,
            navSignupPasswordInput,
            navSignupConfirmInput,
            navSignupEmailInput,
            navSignupTelInput,
            navSignupSchoolSelect
        ].forEach(input => {
            if (input) input.disabled = isBusy;
        });
    }

    function resetNavSignupForm() {
        if (navSignupForm) navSignupForm.reset();
        showNavAuthStatus(navSignupStatus, '');
    }

    function handleNavSignupSubmit(event) {
        if (event) event.preventDefault();
        if (navAuthBusyState.signup) return;
        const username = (navSignupUsernameInput?.value || '').trim();
        const password = navSignupPasswordInput?.value || '';
        const confirmPassword = navSignupConfirmInput?.value || '';
        const schoolId = navSignupSchoolSelect ? navSignupSchoolSelect.value : '';
        const email = (navSignupEmailInput?.value || '').trim();
        if (!username || !password) {
            showNavAuthStatus(navSignupStatus, 'กรุณากรอกข้อมูลให้ครบ', 'error');
            return;
        }
        if (password !== confirmPassword) {
            showNavAuthStatus(navSignupStatus, 'รหัสผ่านไม่ตรงกัน', 'error');
            return;
        }
        if (!schoolId) {
            showNavAuthStatus(navSignupStatus, 'กรุณาเลือกโรงเรียน', 'error');
            return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNavAuthStatus(navSignupStatus, 'รูปแบบอีเมลไม่ถูกต้อง', 'error');
            return;
        }
        const payload = {
            username,
            password,
            name: (navSignupNameInput?.value || '').trim(),
            surname: (navSignupSurnameInput?.value || '').trim(),
            tel: (navSignupTelInput?.value || '').trim(),
            schoolId,
            email
        };
        setNavSignupBusyState(true);
        showNavAuthStatus(navSignupStatus, 'กำลังสมัครสมาชิก...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setNavSignupBusyState(false);
                if (response && response.success && response.user) {
                    showNavAuthStatus(navSignupStatus, 'สมัครเรียบร้อย กำลังเข้าสู่ระบบ...', 'success');
                    resetNavSignupForm();
                    setCurrentUser(response.user);
                    closeProfileMenu();
                    navigateTo('section-form');
                } else {
                    showNavAuthStatus(navSignupStatus, (response && response.error) || 'สมัครไม่สำเร็จ', 'error');
                }
            })
            .withFailureHandler(error => {
                setNavSignupBusyState(false);
                showNavAuthStatus(navSignupStatus, error.message || 'สมัครไม่สำเร็จ', 'error');
            })
            .registerNormalUser(payload);
    }

    function normalizeText(value) {
        return (value || '').toString().trim().toLowerCase();
    }

    function getCurrentUserLevel() {
        return normalizeText(currentUser?.level || '');
    }

    function getRoleDisplayName(level) {
        const normalized = normalizeText(level);
        const map = {
            admin: 'Admin',
            school_admin: 'School Admin',
            group_admin: 'Group Admin',
            area: 'Area',
            score: 'Score',
            user: 'ผู้ใช้ทั่วไป'
        };
        return map[normalized] || (level || 'User');
    }

    function canEditAvatarFromNav() {
        return getCurrentUserLevel() === 'user';
    }

    function setNavProfileAvatarStatus(message = '', type = 'info') {
        if (!navProfileAvatarStatus) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        navProfileAvatarStatus.textContent = message || navProfileAvatarStatus.dataset.defaultStatus || '';
        navProfileAvatarStatus.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        navProfileAvatarStatus.classList.add(classMap[type] || classMap.info);
    }

    function resetNavProfileAvatarUI() {
        PROFILE_AVATAR_FILE_DATA = null;
        if (navProfileAvatarInput) {
            navProfileAvatarInput.value = '';
            navProfileAvatarInput.disabled = !canEditAvatarFromNav();
        }
        if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.disabled = true;
            navProfileAvatarSubmit.classList.remove('opacity-60');
        }
        setNavProfileAvatarStatus(navProfileAvatarStatus?.dataset.defaultStatus || '', 'info');
    }

    function setNavProfileAvatarBusy(isBusy) {
        if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.disabled = isBusy || !PROFILE_AVATAR_FILE_DATA;
            navProfileAvatarSubmit.classList.toggle('opacity-60', isBusy);
        }
        if (navProfileAvatarInput) {
            navProfileAvatarInput.disabled = isBusy || !canEditAvatarFromNav();
        }
    }

    function closeProfileMenu() {
        if (!navProfileMenu) return;
        navProfileMenu.classList.add('hidden');
        navProfileButton?.setAttribute('aria-expanded', 'false');
        isProfileMenuOpen = false;
    }

    function openProfileMenu() {
        if (!navProfileMenu) {
            navigateTo('section-profile', navProfileButton);
            return;
        }
        refreshProfileMenuState();
        navProfileMenu.classList.remove('hidden');
        navProfileButton?.setAttribute('aria-expanded', 'true');
        isProfileMenuOpen = true;
    }

    function handleNavProfileButton(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (currentUser) {
            goToProfileSection();
            return;
        }
        closeProfileMenu();
        navigateTo('section-auth', navProfileButton);
        setSignupFormVisibility(false);
        loginUsernameInput?.focus();
        showAuthStatus(loginStatus, 'กรุณาเข้าสู่ระบบเพื่อดำเนินการต่อ', 'info');
    }

    function toggleProfileMenu(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (isProfileMenuOpen) {
            closeProfileMenu();
        } else {
            openProfileMenu();
        }
    }

    function goToProfileSection() {
        closeProfileMenu();
        if (!currentUser) {
            openAuthFromProfile('login');
            return;
        }
        navigateTo('section-profile', navProfileButton);
    }

    function goToAdminSection() {
        closeProfileMenu();
        if (!isAppAdmin) return;
        navigateTo('section-admin');
    }

    function openAuthFromProfile(mode = 'login') {
        closeProfileMenu();
        navigateTo('section-auth');
        if (mode === 'signup') {
            setSignupFormVisibility(true);
            signupNameInput?.focus();
        } else {
            setSignupFormVisibility(false);
            loginUsernameInput?.focus();
        }
    }

    function handleNavProfileLogout(event) {
        if (event) event.preventDefault();
        closeProfileMenu();
        handleLogout();
    }

    function handleProfileSectionLogout(event) {
        if (event) event.preventDefault();
        handleLogout();
    }

    function refreshProfileMenuState() {
        if (!navProfileMenu) return;
        const isLoggedIn = Boolean(currentUser);
        navProfileMenuGuest?.classList.toggle('hidden', isLoggedIn);
        navProfileMenuUser?.classList.toggle('hidden', !isLoggedIn);
        if (!isLoggedIn) {
            resetNavProfileAvatarUI();
            closeProfileMenu();
            return;
        }
        const fullName = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || '-';
        if (navProfileMenuName) navProfileMenuName.textContent = fullName;
        if (navProfileMenuRole) navProfileMenuRole.textContent = getRoleDisplayName(currentUser.level);
        const schoolName = getSchoolDisplayNameById(currentUser.schoolId || currentUser.SchoolID || '') || currentUser.schoolName || '-';
        if (navProfileMenuSchool) navProfileMenuSchool.textContent = '\u0e42\u0e23\u0e07\u0e40\u0e23\u0e35\u0e22\u0e19: ' + (schoolName || '-');
        const avatarUrl = getUserAvatarUrl(currentUser, 96);
        if (navProfileMenuAvatar && navProfileMenuAvatarFallback) {
            if (avatarUrl) {
                navProfileMenuAvatar.src = avatarUrl;
                navProfileMenuAvatar.classList.remove('hidden');
                navProfileMenuAvatarFallback.classList.add('hidden');
            } else {
                navProfileMenuAvatar.src = '';
                navProfileMenuAvatar.classList.add('hidden');
                navProfileMenuAvatarFallback.classList.remove('hidden');
            }
        }
        const canEdit = canEditAvatarFromNav();
        if (navProfileAvatarEditor) navProfileAvatarEditor.classList.toggle('hidden', !canEdit);
        if (navProfileApprovalHint) navProfileApprovalHint.classList.toggle('hidden', !canEdit);
        if (navProfileAvatarInput) navProfileAvatarInput.disabled = !canEdit;
        if (!canEdit) {
            resetNavProfileAvatarUI();
        } else if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.disabled = !PROFILE_AVATAR_FILE_DATA;
        }
        if (navProfileAdminLink) {
            navProfileAdminLink.classList.toggle('hidden', !isAppAdmin);
        }
    }

    function handleGlobalProfileMenuClick(event) {
        if (!isProfileMenuOpen) return;
        if (!navProfileWrapper) {
            closeProfileMenu();
            return;
        }
        if (!navProfileWrapper.contains(event.target)) {
            closeProfileMenu();
        }
    }

    function handleProfileMenuKeydown(event) {
        if (event.key === 'Escape') {
            closeProfileMenu();
            if (teamManagePanel && !teamManagePanel.classList.contains('hidden')) {
                closeTeamManager();
            }
        }
    }

    function handleNavProfileAvatarSelect(event) {
        if (!canEditAvatarFromNav()) {
            setNavProfileAvatarStatus('สิทธิ์ของคุณไม่สามารถแก้ไขรูปได้', 'error');
            resetNavProfileAvatarUI();
            return;
        }
        const file = event.target?.files?.[0];
        if (!file) {
            resetNavProfileAvatarUI();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            setNavProfileAvatarStatus(`ไฟล์ใหญ่กว่า ${MAX}MB`, 'error');
            resetNavProfileAvatarUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            setNavProfileAvatarStatus('รองรับเฉพาะไฟล์ .jpg หรือ .png', 'error');
            resetNavProfileAvatarUI();
            return;
        }
        setNavProfileAvatarStatus(`กำลังประมวลผล: ${file.name}`, 'info');
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            PROFILE_AVATAR_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            setNavProfileAvatarStatus(`อัปโหลดแล้ว: ${file.name}`, 'success');
            if (navProfileAvatarSubmit) {
                navProfileAvatarSubmit.disabled = false;
            }
        };
        reader.onerror = () => {
            setNavProfileAvatarStatus('ไม่สามารถอ่านไฟล์ได้', 'error');
            resetNavProfileAvatarUI();
        };
        reader.readAsDataURL(file);
    }

    function handleNavProfileAvatarSubmit(event) {
        if (event) event.preventDefault();
        if (!currentUser) {
            setNavProfileAvatarStatus('กรุณาเข้าสู่ระบบก่อน', 'error');
            return;
        }
        if (!canEditAvatarFromNav()) {
            setNavProfileAvatarStatus('สิทธิ์ของคุณไม่สามารถแก้ไขรูปได้', 'error');
            return;
        }
        if (!PROFILE_AVATAR_FILE_DATA) {
            setNavProfileAvatarStatus('กรุณาเลือกรูปก่อนส่งคำขอ', 'error');
            return;
        }
        const payload = {
            userid: getCurrentUserId(),
            name: (currentUser.name || '').trim(),
            surname: (currentUser.surname || '').trim(),
            email: (currentUser.email || '').trim(),
            tel: (currentUser.tel || currentUser.phone || '').trim(),
            schoolId: (currentUser.schoolId || currentUser.SchoolID || '').toString().trim(),
            avatarFileData: PROFILE_AVATAR_FILE_DATA
        };
        if (!payload.userid) {
            setNavProfileAvatarStatus('ไม่พบรหัสผู้ใช้', 'error');
            return;
        }
        if (!payload.name || !payload.surname || !payload.email || !payload.tel) {
            setNavProfileAvatarStatus('กรุณากรอกข้อมูลโปรไฟล์ให้ครบก่อน', 'error');
            return;
        }
        setNavProfileAvatarBusy(true);
        setNavProfileAvatarStatus('กำลังส่งคำขอ...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setNavProfileAvatarBusy(false);
                if (response && response.success && response.user) {
                    setCurrentUser(response.user);
                    resetNavProfileAvatarUI();
                    setNavProfileAvatarStatus('ส่งคำขอแล้ว กรุณารอการอนุมัติ', 'success');
                } else {
                    setNavProfileAvatarStatus((response && response.error) || 'ไม่สามารถอัปเดตรูปได้', 'error');
                }
            })
            .withFailureHandler(error => {
                setNavProfileAvatarBusy(false);
                setNavProfileAvatarStatus(error.message || 'ไม่สามารถอัปเดตรูปได้', 'error');
            })
            .updateUserProfile(payload);
    }

    function updateNavProfile() {
        if (!navProfileButton) return;
        const avatarUrl = getUserAvatarUrl(currentUser, 72);
        if (navProfileAvatar) {
            if (avatarUrl) {
                navProfileAvatar.src = avatarUrl;
                navProfileAvatar.classList.remove('hidden');
                navProfileAvatarFallback?.classList.add('hidden');
            } else {
                navProfileAvatar.src = '';
                navProfileAvatar.classList.add('hidden');
                navProfileAvatarFallback?.classList.remove('hidden');
            }
        }
        if (navProfileLabel) {
            navProfileLabel.textContent = currentUser ? 'โปรไฟล์' : 'เข้าสู่ระบบ';
        }
        refreshProfileMenuState();
    }

    function updateAuthUI() {
        const isLoggedIn = Boolean(currentUser);
        if (authUserPanel) {
            authUserPanel.classList.toggle('hidden', !isLoggedIn);
        }
        if (authUserSummary) {
            const fullName = currentUser
                ? `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || ''
                : '';
            authUserSummary.textContent = isLoggedIn ? `ยินดีต้อนรับ ${fullName}` : '';
        }
        if (authUserSchool) {
            const schoolText = currentUser
                ? (getSchoolDisplayNameById(currentUser.schoolId) || currentUser.schoolId || '')
                : '';
            authUserSchool.textContent = schoolText ? `โรงเรียน: ${schoolText}` : '';
        }
        if (authUserEmail) {
            const emailText = currentUser?.email || '';
            authUserEmail.textContent = emailText ? `อีเมล: ${emailText}` : '';
            authUserEmail.classList.toggle('hidden', !emailText);
        }
        if (authUserAvatar && authUserAvatarPlaceholder) {
            const avatarUrl = getUserAvatarUrl(currentUser, 96);
            if (avatarUrl) {
                authUserAvatar.src = avatarUrl;
                authUserAvatar.classList.remove('hidden');
                authUserAvatarPlaceholder.classList.add('hidden');
            } else {
                authUserAvatar.src = '';
                authUserAvatar.classList.add('hidden');
                authUserAvatarPlaceholder.classList.remove('hidden');
            }
        }
        if (loginFormWrapper) {
            loginFormWrapper.classList.toggle('hidden', isLoggedIn);
        }
        if (signupCard) {
            signupCard.classList.toggle('hidden', isLoggedIn);
        }
        setLoginFormDisabled(isLoggedIn);
        if (!isLoggedIn) {
            setLoginBusyState(false);
        }
        updateNavProfile();
        updateProfileSection();
        if (logoutButton) {
            logoutButton.disabled = !isLoggedIn;
        }
    }

    function updateRegistrationAccess() {
        const locked = !currentUser;
        if (registrationFieldset) {
            registrationFieldset.disabled = locked;
        }
        if (registrationLockNotice) {
            registrationLockNotice.classList.toggle('hidden', !locked);
        }
        if (locked) {
            setSubmitButtonState(true);
        } else {
            updateFormBasedOnActivity(activitySelect.value || '');
        }
    }


    function updateProfileSection() {
        if (!profileContent || !profileGuestNotice) return;
        const isLoggedIn = Boolean(currentUser);
        profileContent.classList.toggle('hidden', !isLoggedIn);
        profileGuestNotice.classList.toggle('hidden', isLoggedIn);
        if (profileLogoutButton) {
            profileLogoutButton.disabled = !isLoggedIn;
            profileLogoutButton.classList.toggle('opacity-60', !isLoggedIn);
        }
        updateTeamScopeBanner();
        if (!isLoggedIn) {
            showProfileFormStatus('');
            if (profilePermissionNote) profilePermissionNote.textContent = '';
            return;
        }

        const fullName = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim() || currentUser.username || '-';
        if (profileNameDisplay) profileNameDisplay.textContent = fullName;
        if (profileUsernameDisplay) profileUsernameDisplay.textContent = currentUser.username ? `ชื่อผู้ใช้: ${currentUser.username}` : '';
        if (profileEmailDisplay) profileEmailDisplay.textContent = currentUser.email ? `อีเมล: ${currentUser.email}` : 'อีเมล: -';
        if (profilePhoneDisplay) profilePhoneDisplay.textContent = currentUser.tel ? `โทร: ${currentUser.tel}` : 'โทร: -';
        if (profileRoleLabel) profileRoleLabel.textContent = getRoleDisplayName(currentUser.level);
        if (profileDetailUsername) profileDetailUsername.textContent = currentUser.username || '-';
        if (profileDetailLevel) profileDetailLevel.textContent = getRoleDisplayName(currentUser.level);
        if (profileDetailEmail) profileDetailEmail.textContent = currentUser.email || '-';
        if (profileDetailTel) profileDetailTel.textContent = currentUser.tel || currentUser.phone || '-';

        const avatarUrl = getUserAvatarUrl(currentUser, 160);
        if (profileAvatar && profileAvatarFallback) {
            if (avatarUrl) {
                profileAvatar.src = avatarUrl;
                profileAvatar.classList.remove('hidden');
                profileAvatarFallback.classList.add('hidden');
            } else {
                profileAvatar.src = '';
                profileAvatar.classList.add('hidden');
                profileAvatarFallback.classList.remove('hidden');
            }
        }

        const schoolInfo = getSchoolInfoById(currentUser.schoolId || currentUser.SchoolID || '');
        const schoolName = getSchoolDisplayNameById(currentUser.schoolId || currentUser.SchoolID || '') || currentUser.schoolId || currentUser.SchoolID || '-';
        currentUser.schoolName = schoolName === '-' ? '' : schoolName;
        currentUser.schoolCluster = schoolInfo?.cluster || currentUser.schoolCluster || '';
        if (profileSchoolDisplay) profileSchoolDisplay.textContent = schoolName;
        if (profileClusterDisplay) profileClusterDisplay.textContent = schoolInfo?.cluster ? `สังกัด: ${schoolInfo.cluster}` : 'สังกัด: -';
        if (profileSchoolIdDisplay) profileSchoolIdDisplay.textContent = schoolInfo?.id || currentUser.schoolId || currentUser.SchoolID || '-';
        if (profileSchoolClusterDisplay) profileSchoolClusterDisplay.textContent = schoolInfo?.cluster || '-';
        if (profileDetailSchool) profileDetailSchool.textContent = schoolName;
        if (profileDetailCluster) profileDetailCluster.textContent = schoolInfo?.cluster || '-';

        fillProfileFormFromUser();
        applyProfileEditPermissions();

        const hasTeamData = lastTeamsFetch > 0 || (Array.isArray(ALL_TEAMS) && ALL_TEAMS.length > 0);
        if (!hasTeamData) {
            if (profileStatsActivities) profileStatsActivities.textContent = '...';
            if (profileStatsTeams) profileStatsTeams.textContent = '...';
            if (profileStatsStudents) profileStatsStudents.textContent = '...';
            if (profileStatsTeachers) profileStatsTeachers.textContent = '...';
        } else {
            const stats = getUserTeamStats();
            if (profileStatsActivities) profileStatsActivities.textContent = stats.activities.toString();
            if (profileStatsTeams) profileStatsTeams.textContent = stats.teams.toString();
            if (profileStatsStudents) profileStatsStudents.textContent = stats.students.toString();
            if (profileStatsTeachers) profileStatsTeachers.textContent = stats.teachers.toString();
        }
        renderProfileTeams();
        refreshProfileMenuState();
        updateReportManagementVisibility();
    }

    function fillProfileFormFromUser() {
        if (!currentUser) return;
        if (profileNameInput) profileNameInput.value = currentUser.name || '';
        if (profileSurnameInput) profileSurnameInput.value = currentUser.surname || '';
        if (profileEmailInput) profileEmailInput.value = currentUser.email || '';
        if (profilePhoneInput) profilePhoneInput.value = currentUser.tel || currentUser.phone || '';
        if (profileSchoolSelect) profileSchoolSelect.value = currentUser.schoolId || currentUser.SchoolID || '';
    }

    function applyProfileEditPermissions() {
        if (!profileForm) return;
        const isLoggedIn = Boolean(currentUser);
        const level = getCurrentUserLevel();
        const canEditSchool = level === 'admin' || level === 'area';
        const generalFields = [
            profileNameInput,
            profileSurnameInput,
            profileEmailInput,
            profilePhoneInput,
            profilePasswordInput,
            profilePasswordConfirmInput
        ];
        generalFields.forEach(field => {
            if (!field) return;
            field.disabled = !isLoggedIn;
            field.classList.toggle('opacity-60', !isLoggedIn);
        });
        if (profileSchoolSelect) {
            profileSchoolSelect.disabled = !canEditSchool;
            profileSchoolSelect.classList.toggle('opacity-60', !canEditSchool);
            profileSchoolSelect.classList.toggle('cursor-not-allowed', !canEditSchool);
        }
        if (profileFormSubmitButton) {
            profileFormSubmitButton.disabled = !isLoggedIn;
            profileFormSubmitButton.classList.toggle('opacity-60', !isLoggedIn);
        }
        if (profilePermissionNote) {
            let note = '';
            if (isLoggedIn) {
                note = canEditSchool
                    ? 'คุณสามารถแก้ไขข้อมูลทั้งหมด รวมถึงโรงเรียนได้'
                    : 'คุณสามารถแก้ไขข้อมูลทั้งหมด ยกเว้นโรงเรียน (เฉพาะ Admin/Area ที่เปลี่ยนโรงเรียนได้)';
            }
            profilePermissionNote.textContent = note;
        }
    }

    function setProfileFormBusy(isBusy) {
        if (!profileForm) return;
        const elements = profileForm.querySelectorAll('input, select, button');
        elements.forEach(el => {
            el.disabled = isBusy;
        });
        if (profileFormSubmitButton) {
            profileFormSubmitButton.classList.toggle('opacity-60', isBusy);
        }
    }

    function showProfileFormStatus(message = '', type = 'info') {
        if (!profileFormStatus) return;
        const classMap = {
            success: 'text-emerald-600',
            error: 'text-red-600',
            info: 'text-slate-500'
        };
        profileFormStatus.textContent = message || '';
        profileFormStatus.classList.remove('text-emerald-600', 'text-red-600', 'text-slate-500');
        profileFormStatus.classList.add(classMap[type] || classMap.info);
    }

    function handleProfileFormSubmit(event) {
        event.preventDefault();
        if (!currentUser) {
            showProfileFormStatus('กรุณาเข้าสู่ระบบก่อน', 'error');
            return;
        }
        const payload = {
            userid: getCurrentUserId(),
            name: (profileNameInput?.value || '').trim(),
            surname: (profileSurnameInput?.value || '').trim(),
            email: (profileEmailInput?.value || '').trim(),
            tel: (profilePhoneInput?.value || '').trim(),
            schoolId: (profileSchoolSelect?.value || '').trim()
        };
        const newPassword = (profilePasswordInput?.value || '').trim();
        const confirmPassword = (profilePasswordConfirmInput?.value || '').trim();
        if (!payload.name || !payload.surname) {
            showProfileFormStatus('กรุณากรอกชื่อและนามสกุล', 'error');
            return;
        }
        if (!payload.email) {
            showProfileFormStatus('กรุณากรอกอีเมล', 'error');
            return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(payload.email)) {
            showProfileFormStatus('รูปแบบอีเมลไม่ถูกต้อง', 'error');
            return;
        }
        if (!payload.tel) {
            showProfileFormStatus('กรุณากรอกเบอร์โทรศัพท์', 'error');
            return;
        }
        if (newPassword || confirmPassword) {
            if (newPassword.length < 6) {
                showProfileFormStatus('รหัสผ่านใหม่ต้องมีอย่างน้อย 6 ตัวอักษร', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showProfileFormStatus('รหัสผ่านใหม่และยืนยันไม่ตรงกัน', 'error');
                return;
            }
            payload.newPassword = newPassword;
        }

        setProfileFormBusy(true);
        showProfileFormStatus('กำลังบันทึก...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                setProfileFormBusy(false);
                if (response && response.success) {
                    if (response.user) {
                        setCurrentUser(response.user);
                    }
                    if (profilePasswordInput) profilePasswordInput.value = '';
                    if (profilePasswordConfirmInput) profilePasswordConfirmInput.value = '';
                    showProfileFormStatus('อัปเดตข้อมูลเรียบร้อย', 'success');
                } else {
                    showProfileFormStatus((response && response.error) || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                }
            })
            .withFailureHandler(error => {
                setProfileFormBusy(false);
                showProfileFormStatus(error.message || 'ไม่สามารถบันทึกข้อมูลได้', 'error');
            })
            .updateUserProfile(payload);
    }    function requireLoginForRegistration() {
        if (currentUser) return true;
        Swal.fire({
            icon: 'info',
            title: 'ต้องเข้าสู่ระบบ',
            text: 'กรุณาเข้าสู่ระบบก่อนสมัครกิจกรรม'
        }).then(() => navigateTo('section-auth'));
        return false;
    }

    function getCurrentUserId() {
        if (!currentUser) return '';
        return currentUser.userid || currentUser.userId || currentUser.id || '';
    }

    function getUserSchoolNameForFilter() {
        if (!currentUser) return '';
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        const display = getSchoolDisplayNameById(schoolId) || currentUser.schoolName || schoolId || '';
        return normalizeText(display);
    }

    function getUserClusterForFilter() {
        if (!currentUser) return '';
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        if (schoolId) {
            const schoolInfo = getSchoolInfoById(schoolId);
            const clusterId = getSchoolClusterId(schoolInfo);
            if (clusterId) return normalizeText(clusterId);
        }
        if (currentUser.schoolCluster) return normalizeText(currentUser.schoolCluster);
        const schoolInfoByName = getSchoolInfoByName(currentUser.schoolName || '');
        const clusterId = getSchoolClusterId(schoolInfoByName);
        return normalizeText(clusterId);
    }
    function getCurrentUserClusterLabel() {
        if (!currentUser) return '';
        const schoolId = currentUser.schoolId || currentUser.SchoolID || '';
        const schoolInfo = getSchoolInfoById(schoolId) || getSchoolInfoByName(currentUser.schoolName || '');
        return getSchoolClusterName(schoolInfo);
    }

    function buildActorPayload() {
        if (!currentUser) return null;
        return {
            userId: currentUser.userid || currentUser.userId || currentUser.id || '',
            username: currentUser.username || '',
            level: currentUser.level || '',
            schoolId: currentUser.schoolId || currentUser.SchoolID || '',
            schoolName: currentUser.schoolName || '',
            cluster: currentUser.schoolCluster || '',
            clusterId: currentUser.schoolClusterId || ''
        };
    }

    function filterTeamsForCurrentUser(teams) {
        if (!Array.isArray(teams) || !teams.length || !currentUser) return [];
        const dataset = [...teams];
        const role = getCurrentUserLevel();
        const userId = getCurrentUserId();
        if (role === 'school_admin') {
            const schoolName = getUserSchoolNameForFilter();
            if (!schoolName) return [];
            return dataset.filter(team => normalizeText(team.school) === schoolName);
        }
        if (role === 'group_admin') {
            const cluster = getUserClusterForFilter();
            if (cluster) {
                const clusterTeams = dataset.filter(team => normalizeText(getTeamCluster(team)) === cluster);
                if (clusterTeams.length) {
                    return clusterTeams;
                }
            }
            const schoolName = getUserSchoolNameForFilter();
            if (!schoolName) return [];
            return dataset.filter(team => normalizeText(team.school) === schoolName);
        }
        if (role === 'admin' || role === 'area' || role === 'score') {
            return dataset;
        }
        if (!userId) return [];
        return dataset.filter(team => (team.createdByUserId || '') === userId);
    }

    function getTeamClusterId(team) {
        if (!team) return '';
        const schoolInfo = getSchoolInfoByName(team.school) || getSchoolInfoById(team.schoolId || '');
        if (schoolInfo) {
            const clusterId = getSchoolClusterId(schoolInfo);
            if (clusterId) return normalizeText(clusterId);
        }
        if (team.schoolClusterId) return normalizeText(team.schoolClusterId);
        if (team.schoolCluster) return normalizeText(team.schoolCluster);
        return '';
    }

    function getTeamClusterLabel(team) {
        if (!team) return '';
        const schoolInfo = getSchoolInfoByName(team.school) || getSchoolInfoById(team.schoolId || '');
        if (schoolInfo) {
            const clusterName = getSchoolClusterName(schoolInfo);
            if (clusterName) return clusterName;
        }
        return team.schoolClusterName || team.schoolCluster || '';
    }

    function getTeamCluster(team) {
        return getTeamClusterId(team);
    }

    function isTeamLockedForEdit(team) {
        const status = (team?.status || '').toString().trim().toLowerCase();
        return status === 'print';
    }

    function canManageTeam(team) {
        if (!currentUser || !team) return false;
        const level = getCurrentUserLevel();
        if (!level) return false;
        if (['admin', 'area', 'score'].includes(level)) return true;
        const userId = getCurrentUserId();
        if (team.createdByUserId && userId && (team.createdByUserId === userId)) return true;
        const userSchool = getUserSchoolNameForFilter();
        if (level === 'school_admin' && userSchool && normalizeText(team.school) === userSchool) return true;
        const userCluster = getUserClusterForFilter();
        if (level === 'group_admin' && userCluster && normalizeText(getTeamCluster(team)) === userCluster) return true;
        return false;
    }

    function canEditTeamStatusClient() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function canEditTeamImagesClient() {
        return Boolean(currentUser);
    }

    function getTeamScopeDescription() {
        const role = getCurrentUserLevel();
        if (role === 'school_admin') {
            const schoolName = getSchoolDisplayNameById(currentUser?.schoolId || currentUser?.SchoolID) || currentUser?.schoolName || '';
            return schoolName
                ? `School Admin: แสดงทุกทีมในโรงเรียน ${schoolName}`
                : 'School Admin: แสดงทุกทีมในโรงเรียนของคุณ';
        }
        if (role === 'group_admin') {
            const clusterLabel = getCurrentUserClusterLabel();
            return clusterLabel
                ? `Group Admin: แสดงทุกทีมในเครือข่าย ${clusterLabel}`
                : 'Group Admin: แสดงทุกทีมในเครือข่ายของคุณ';
        }
        if (role === 'admin' || role === 'area' || role === 'score') {
            return 'ผู้ดูแลระบบ: แสดงทุกทีมในระบบ';
        }
        return 'ผู้ใช้ทั่วไป: เห็นเฉพาะทีมที่คุณสร้าง';
    }

    function updateTeamScopeBanner() {
        if (!teamScopeBanner || !teamScopeText) return;
        if (!currentUser) {
            teamScopeBanner.classList.add('hidden');
            teamScopeText.textContent = '';
            return;
        }
        teamScopeBanner.classList.remove('hidden');
        teamScopeText.textContent = getTeamScopeDescription();
    }

    function getUserTeamStats() {
        const teams = filterTeamsForCurrentUser(ALL_TEAMS);
        if (!teams.length) {
            return { activities: 0, teams: 0, students: 0, teachers: 0 };
        }
        const uniqueActivities = new Set();
        let students = 0;
        let teachers = 0;
        teams.forEach(team => {
            if (team.activity) uniqueActivities.add(team.activity);
            const members = safeJsonParse(team.members, { teachers: [], students: [] });
            teachers += Array.isArray(members.teachers) ? members.teachers.length : 0;
            students += Array.isArray(members.students) ? members.students.length : 0;
        });
        return {
            activities: uniqueActivities.size,
            teams: teams.length,
            students,
            teachers
        };
    }

    function renderProfileTeams() {
        if (!profileTeamList) return;
        if (!currentUser) {
            profileTeamList.innerHTML = '<p class="text-slate-500">เข้าสู่ระบบเพื่อดูทีมของคุณ</p>';
            return;
        }
        const teams = filterTeamsForCurrentUser(ALL_TEAMS);
        if (!Array.isArray(teams) || teams.length === 0) {
            profileTeamList.innerHTML = '<p class="text-slate-500">ยังไม่มีข้อมูลทีม</p>';
            return;
        }
        const html = teams.map(team => {
            const members = safeJsonParse(team.members, { teachers: [], students: [] });
            const teachers = Array.isArray(members.teachers) ? members.teachers : [];
            const students = Array.isArray(members.students) ? members.students : [];
            const contact = safeJsonParse(team.contact, {});
            const activityObj = ALL_ACTIVITIES.find(a => a.id === team.activity);
            const activityName = activityObj ? activityObj.name : (team.activity || '-');
            const canManage = canManageTeam(team);
            const locked = isTeamLockedForEdit(team);
            const manageDisabled = canManage ? '' : 'disabled';
            const manageLabel = locked ? 'ดูข้อมูล' : 'จัดการทีม';
            return `
                <div class="rounded-2xl border border-slate-200 p-4 space-y-3">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                        <div>
                            <p class="text-sm font-semibold text-slate-900">${escapeHtmlClient(team.teamName || '-')}</p>
                            <p class="text-xs text-slate-500">รหัสทีม: ${escapeHtmlClient(team.teamId || '-')} | กิจกรรม: ${escapeHtmlClient(activityName)}</p>
                            <div class="mt-1 text-xs text-slate-500">สถานะ: ${getStatusBadge(team.status)}</div>
                        </div>
                        <div class="text-xs text-slate-500 md:text-right">
                            <p class="font-semibold text-slate-600">ผู้ประสานงาน</p>
                            <p>${escapeHtmlClient(contact.name || '-')}</p>
                            <p>${escapeHtmlClient(contact.phone || '')}</p>
                            <p>${escapeHtmlClient(contact.email || '')}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="rounded-xl border border-slate-100 bg-slate-50 p-3">
                            <p class="text-xs font-semibold text-slate-600 mb-1">ครู (${teachers.length})</p>
                            <ul class="space-y-1 text-xs text-slate-500">
                                ${teachers.length ? teachers.map(t => `<li>• ${escapeHtmlClient(t.name || '-')} ${t.phone ? `(${escapeHtmlClient(t.phone)})` : ''}</li>`).join('') : '<li>ไม่มีข้อมูล</li>'}
                            </ul>
                        </div>
                        <div class="rounded-xl border border-slate-100 bg-slate-50 p-3">
                            <p class="text-xs font-semibold text-slate-600 mb-1">นักเรียน (${students.length})</p>
                            <ul class="space-y-1 text-xs text-slate-500">
                                ${students.length ? students.map(s => `<li>• ${escapeHtmlClient(s.name || '-')} ${s.class ? `(${escapeHtmlClient(s.class)})` : ''}</li>`).join('') : '<li>ไม่มีข้อมูล</li>'}
                            </ul>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-2 border-t border-slate-100 pt-3">
                        <p class="text-[11px] text-slate-500">${locked ? 'สถานะ Print: เปิดอ่านอย่างเดียว' : (canManage ? 'คุณสามารถจัดการทีมนี้' : 'กรุณาเข้าสู่ระบบเพื่อจัดการทีม')}</p>
                        <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold ${manageDisabled ? 'text-slate-400 cursor-not-allowed bg-slate-50' : 'text-sky-600 hover:bg-sky-50'}"
                            ${manageDisabled}
                            onclick="openTeamManager('${team.teamId}')">
                            <span class="material-symbols-outlined text-base">construction</span>
                            <span>${manageLabel}</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        profileTeamList.innerHTML = html;
    }

    function populateSchoolSelectElement(selectEl, schools, {
        placeholderText = '-- เลือกโรงเรียน --',
        keepPreviousValue = true,
        ensureValue = ''
    } = {}) {
        if (!selectEl) return;
        const previousValue = keepPreviousValue ? (selectEl.value || '') : '';
        selectEl.innerHTML = `<option value="">${placeholderText}</option>`;
        if (Array.isArray(schools) && schools.length) {
            schools.forEach(school => {
                if (!school || !school.name) return;
                const option = document.createElement('option');
                option.value = school.id || school.name;
                option.textContent = school.id ? `[${school.id}] ${school.name}` : school.name;
                option.dataset.schoolName = school.name;
                option.dataset.schoolId = school.id || '';
                option.dataset.schoolCluster = school.cluster || '';
                selectEl.appendChild(option);
            });
        }
        const targetValue = ensureValue || previousValue;
        if (targetValue) {
            const hasOption = Array.from(selectEl.options).some(opt => opt.value === targetValue);
            if (!hasOption) {
                const fallbackOption = document.createElement('option');
                fallbackOption.value = targetValue;
                fallbackOption.textContent = targetValue;
                selectEl.appendChild(fallbackOption);
            }
            selectEl.value = targetValue;
        }
    }


    function handleSignupSubmit(event) {
        event.preventDefault();
        if (!authSignupForm) return;
        const username = (signupUsernameInput?.value || '').trim();
        const password = signupPasswordInput?.value || '';
        const confirmPassword = signupConfirmPasswordInput?.value || '';
        const schoolId = authSchoolSelect ? authSchoolSelect.value : '';
        const email = (signupEmailInput?.value || '').trim();
        if (!username || !password) {
            showAuthStatus(signupStatus, 'กรุณากรอกชื่อผู้ใช้และรหัสผ่านให้ครบถ้วน', 'error');
            return;
        }
        if (password !== confirmPassword) {
            showAuthStatus(signupStatus, 'รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน', 'error');
            return;
        }
        if (!schoolId) {
            showAuthStatus(signupStatus, 'กรุณาเลือกโรงเรียนจากรายการ', 'error');
            return;
        }
        if (!email) {
            showAuthStatus(signupStatus, 'กรุณากรอกอีเมล', 'error');
            return;
        }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showAuthStatus(signupStatus, 'รูปแบบอีเมลไม่ถูกต้อง', 'error');
            return;
        }
        const payload = {
            username,
            password,
            name: (signupNameInput?.value || '').trim(),
            surname: (signupSurnameInput?.value || '').trim(),
            tel: (signupTelInput?.value || '').trim(),
            schoolId,
            email
        };
        if (USER_AVATAR_FILE_DATA) {
            payload.avatarFileData = USER_AVATAR_FILE_DATA;
        }
        showAuthStatus(signupStatus, 'กำลังสมัครสมาชิก...', 'info');
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.success) {
                    showAuthStatus(signupStatus, 'สมัครสมาชิกสำเร็จ! สามารถเข้าสู่ระบบได้ทันที', 'success');
                    authSignupForm.reset();
                    if (authSchoolSelect) authSchoolSelect.value = '';
                    resetSignupAvatarUI();
                    setSignupFormVisibility(false);
                } else {
                    showAuthStatus(signupStatus, (response && response.error) || 'ไม่สามารถสมัครสมาชิกได้', 'error');
                }
            })
            .withFailureHandler(error => {
                showAuthStatus(signupStatus, error.message || 'เกิดข้อผิดพลาดในการสมัครสมาชิก', 'error');
            })
            .registerNormalUser(payload);
    }

    function handleLoginSubmit(event) {
        event.preventDefault();
        if (!authLoginForm) return;
        const username = (loginUsernameInput?.value || '').trim();
        const password = loginPasswordInput?.value || '';
        if (!username || !password) {
            showAuthStatus(loginStatus, 'กรุณากรอกชื่อผู้ใช้และรหัสผ่าน', 'error');
            return;
        }
        showAuthStatus(loginStatus, 'กำลังเข้าสู่ระบบ...', 'info');
        setLoginFormDisabled(true);
        setLoginBusyState(true);
        google.script.run
            .withSuccessHandler(response => {
                setLoginBusyState(false);
                if (response && response.success) {
                    const displayName = response.user?.name || response.user?.username || username;
                    if (response.user) {
                        setCurrentUser(response.user);
                        authLoginForm.reset();
                    }
                    showAuthStatus(loginStatus, `เข้าสู่ระบบสำเร็จ ยินดีต้อนรับ ${displayName}`, 'success');
                    navigateTo('section-form');
                } else {
                    setLoginFormDisabled(false);
                    showAuthStatus(loginStatus, (response && response.error) || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
                }
            })
            .withFailureHandler(error => {
                setLoginBusyState(false);
                setLoginFormDisabled(false);
                showAuthStatus(loginStatus, error.message || 'เข้าสู่ระบบไม่สำเร็จ', 'error');
            })
            .loginUser({ username, password });
    }

    function handleLogout(event) {
        if (event) event.preventDefault();
        if (!currentUser) return;
        setLoginBusyState(false);
        clearUserSession();
        if (authLoginForm) authLoginForm.reset();
        setLoginFormDisabled(false);
        resetNavProfileAvatarUI();
        closeProfileMenu();
        closeTeamManager();
        showAuthStatus(loginStatus, 'ออกจากระบบเรียบร้อย', 'info');
    }

    function initializeAuthSection() {
        if (authSignupForm) {
            authSignupForm.addEventListener('submit', handleSignupSubmit);
        }
        if (authLoginForm) {
            authLoginForm.addEventListener('submit', handleLoginSubmit);
        }
        if (logoutButton) {
            logoutButton.addEventListener('click', handleLogout);
        }
        if (toggleSignupFormBtn) {
            toggleSignupFormBtn.addEventListener('click', toggleSignupFormVisibility);
            setSignupFormVisibility(false);
        }
        updateAuthUI();
        updateRegistrationAccess();
    }
    function isActivityClosed(activity) {
        if (!activity) return false;
        const maxTeams = typeof activity.maxTeams === 'number' && activity.maxTeams > 0 ? activity.maxTeams : null;
        const remaining = calculateRemainingTeams(activity);
        const limitReached = maxTeams !== null ? remaining <= 0 : false;
        const deadlineIso = activity.registrationDeadline || null;
        const deadlinePassed = activity.deadlinePassed !== undefined
            ? activity.deadlinePassed
            : (deadlineIso ? Date.now() > new Date(deadlineIso).getTime() : false);
        return Boolean(activity.isClosed) || limitReached || deadlinePassed;
    }
    function setSubmitButtonState(disabled) {
        if (!submitButton) return;
        const effectiveDisabled = disabled || (registrationFieldset && registrationFieldset.disabled);
        submitButton.disabled = effectiveDisabled;
        if (effectiveDisabled) {
            submitButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
            submitButton.classList.add('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
        } else {
            submitButton.classList.remove('bg-slate-300', 'text-slate-500', 'cursor-not-allowed');
            submitButton.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
        }
    }
    function validateStep(stepNumber) {
        const stepIndex = stepNumber - 1;
        if (!formSteps[stepIndex]) return true;
        const inputs = formSteps[stepIndex].querySelectorAll('input, select, textarea');
        for (const input of inputs) {
            if (input.hasAttribute('required') && !input.checkValidity()) {
                const label = input.id ? form.querySelector(`label[for="${input.id}"]`) : null;
                const fieldName = label ? label.textContent.replace('*', '').trim() : (input.getAttribute('placeholder') || input.name || 'ช่องนี้');
                input.classList.add('ring-2', 'ring-red-300', 'border-red-400');
                const removeError = () => {
                    input.classList.remove('ring-2', 'ring-red-300', 'border-red-400');
                    input.removeEventListener('input', removeError);
                    input.removeEventListener('change', removeError);
                };
                input.addEventListener('input', removeError);
                input.addEventListener('change', removeError);
                Swal.fire({
                    icon: 'warning',
                    title: 'ข้อมูลไม่ครบ',
                    text: `กรุณากรอก ${fieldName} ให้ครบถ้วน`
                }).then(() => input.focus());
                return false;
            }
        }
        return true;
    }
    function escapeHtmlClient(value) {
        if (value === null || value === undefined) return '';
        return value.toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    function buildClassLevelControlHtml(type, index, selectedValue = '', { disabled = false, scope = 'form', managedIndex = null } = {}) {
        const normalized = selectedValue ? selectedValue.toString() : '';
        const isCustom = normalized && !CLASS_LEVEL_OPTIONS.includes(normalized);
        const selectOptions = CLASS_LEVEL_OPTIONS.map(level => {
            const sel = level === normalized ? 'selected' : '';
            return `<option value="${level}" ${sel}>${level}</option>`;
        }).join('');
        const selectDisabled = disabled ? 'disabled' : '';
        const customDisabled = disabled || !isCustom ? 'disabled' : '';
        const customClasses = isCustom ? '' : 'hidden';
        const customValue = isCustom ? escapeHtmlClient(normalized) : '';
        const managedAttr = managedIndex !== null ? ` data-managed-index="${managedIndex}"` : '';
        return `
            <div class="space-y-2" data-class-select-wrapper="${type}-${index}-${scope}">
                <select
                    class="w-full rounded-lg border border-slate-200 px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-sky-500"
                    data-class-level-select="true"
                    data-member-type="${type}"
                    data-member-index="${index}"
                    data-class-scope="${scope}"
                    ${managedAttr}
                    ${selectDisabled}
                    required
                >
                    <option value="">เลือกระดับชั้น</option>
                    ${selectOptions}
                    <option value="custom" ${isCustom ? 'selected' : ''}>อื่นๆ (พิมพ์เอง)</option>
                </select>
                <input type="text"
                    class="w-full rounded-lg border border-slate-200 px-2 py-1 text-xs ${customClasses}"
                    data-class-level-custom="true"
                    data-member-type="${type}"
                    data-member-index="${index}"
                    data-class-scope="${scope}"
                    ${managedAttr}
                    placeholder="ระบุระดับ/ห้อง"
                    value="${customValue}"
                    ${customDisabled}
                >
            </div>
        `;
    }
    function getSelectedClassLevelValue(type, index, scope = 'form') {
        const select = document.querySelector(`[data-class-level-select="true"][data-member-type="${type}"][data-member-index="${index}"][data-class-scope="${scope}"]`);
        if (!select) return '';
        if (select.value === 'custom') {
            const customInput = document.querySelector(`[data-class-level-custom="true"][data-member-type="${type}"][data-member-index="${index}"][data-class-scope="${scope}"]`);
            return (customInput?.value || '').trim();
        }
        return (select.value || '').trim();
    }
    function toggleClassLevelCustomInput(select) {
        if (!select) return;
        const type = select.dataset.memberType || 'student';
        const index = select.dataset.memberIndex || '1';
        const scope = select.dataset.classScope || 'form';
        const customInput = document.querySelector(`[data-class-level-custom="true"][data-member-type="${type}"][data-member-index="${index}"][data-class-scope="${scope}"]`);
        if (!customInput) return;
        const isCustom = select.value === 'custom';
        customInput.classList.toggle('hidden', !isCustom);
        customInput.disabled = (!isCustom) || select.disabled;
        customInput.required = isCustom && !select.disabled;
        if (!isCustom) {
            customInput.value = '';
        } else {
            customInput.focus();
        }
    }
    function generateMemberKey(type) {
        return `${type}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 7)}`;
    }
    function ensureMemberKey(member, type) {
        if (!member) return generateMemberKey(type);
        if (!member._key) {
            member._key = generateMemberKey(type);
        }
        return member._key;
    }
    function getManagedMemberPreviewUrl(memberKey, fallbackUrl = '') {
        const pending = TEAM_MANAGE_MEMBER_PHOTO_DATA[memberKey];
        if (pending && pending.dataUrl) {
            return pending.dataUrl;
        }
        return fallbackUrl;
    }
    function sanitizeDigits(value) {
        return (value || '').toString().replace(/\D+/g, '');
    }
    function handleNumericInputEvent(event) {
        const target = event.target;
        if (target && target.dataset && target.dataset.onlyDigits === 'true') {
            const cleaned = sanitizeDigits(target.value);
            if (target.value !== cleaned) {
                target.value = cleaned;
                const len = cleaned.length;
                try {
                    target.setSelectionRange(len, len);
                } catch (err) {
                    /* ignore */
                }
            }
        }
    }
    function getOpenActivities() {
        return ALL_ACTIVITIES.filter(a => !isActivityClosed(a));
    }
    function getAllCategories(activities = ALL_ACTIVITIES) {
        if (!Array.isArray(activities)) return [];
        const set = new Set();
        activities.forEach(a => { if (a && a.category) set.add(a.category); });
        return Array.from(set).sort((a, b) => a.localeCompare(b, 'th'));
    }

    // --- Home cards ---
    function renderHomeActivityCards(activities) {
        if (!homeActivityContainer) return;
        if (!activities || activities.length === 0) {
            homeActivityContainer.innerHTML = '';
            return;
        }
        const canEditActivity = canEditActivities();
        const cardsHtml = activities.map(act => {
            const levels = Array.isArray(act.levels) ? act.levels : [];
            const levelsHtml = levels.map(l => `<span class="text-xs font-medium bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${l}</span>`).join(' ');
            const remainingTeams = calculateRemainingTeams(act);
            const hasLimit = typeof act.maxTeams === 'number' && act.maxTeams > 0;
            const availabilityText = hasLimit
                ? `เหลือ ${typeof remainingTeams === 'number' ? Math.max(remainingTeams, 0) : 0} ทีม จาก ${act.maxTeams}`
                : 'ไม่จำกัดทีม';
            const deadlineText = formatDeadline(act.registrationDeadline, 'ไม่ระบุ');
            const currentTeams = act.currentTeams || 0;
            const categoryLabel = act.category || 'ไม่ระบุหมวดหมู่';
            const isClosed = isActivityClosed(act);
            const statusClass = isClosed
                ? 'text-rose-600 bg-rose-50 border border-rose-200'
                : 'text-emerald-600 bg-emerald-50 border border-emerald-200';
            const statusText = isClosed ? 'ปิดรับสมัคร' : 'เปิดรับสมัคร';
            const statusBadge = `<span class="inline-flex items-center text-xs font-semibold px-2.5 py-1 rounded-full border ${statusClass}">${statusText}</span>`;
            const actionButton = isClosed
                ? `<button type="button" class="w-full bg-slate-200 text-slate-500 font-semibold px-4 py-2 rounded-lg border border-slate-200 cursor-not-allowed" disabled>ปิดรับสมัครแล้ว</button>`
                : `<button type="button" class="w-full bg-sky-500 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-sky-600 transition-colors" onclick="selectActivityForForm('${act.id}')">เลือกกิจกรรม</button>`;
            const closingHint = isClosed && deadlineText
                ? `<p class="text-xs text-rose-500">สิ้นสุดเมื่อ ${deadlineText}</p>`
                : '';
            const showCountdown = !isClosed && act.registrationDeadline && isDeadlineApproaching(act.registrationDeadline);
            const countdownHtml = showCountdown
                ? `<div class="flex items-center gap-1 text-xs font-semibold text-rose-600" data-deadline-countdown data-activity-id="${act.id}" data-deadline="${act.registrationDeadline}">
                        <span class="material-symbols-outlined text-base">hourglass_bottom</span>
                        <span>กำลังนับเวลา...</span>
                   </div>`
                : '';
            const adminActions = canEditActivity
                ? `<button type="button"
                        class="w-full border border-slate-200 text-slate-600 font-semibold px-4 py-2 rounded-lg hover:bg-white transition-colors mt-2"
                        onclick="openActivityEditDialog('${act.id}')">
                        <span class="inline-flex items-center gap-1 justify-center">
                            <span class="material-symbols-outlined text-base">edit</span>
                            แก้ไขกิจกรรม
                        </span>
                   </button>`
                : '';
            return `
                <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col h-full">
                    <div class="p-5 space-y-4 flex-1">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <h3 class="text-lg font-semibold text-slate-900 leading-tight">${act.name}</h3>
                                <p class="text-sm text-slate-500">${categoryLabel}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        <div class="flex flex-wrap gap-2">${levelsHtml}</div>
                        <div class="text-sm text-slate-600 space-y-1">
                            <p><span class="font-medium text-slate-700">รูปแบบ:</span> ${act.mode || '-'}</p>
                            <p><span class="font-medium text-slate-700">โควต้า:</span> ${availabilityText}</p>
                            <p><span class="font-medium text-slate-700">ส่งแล้ว:</span> ${currentTeams}</p>
                            <p><span class="font-medium text-slate-700">ปิดรับสมัคร:</span> ${deadlineText}</p>
                            ${closingHint}
                            ${countdownHtml}
                        </div>
                    </div>
                    <div class="border-t border-slate-200 bg-slate-50 p-4">
                        <div class="space-y-2">
                            ${actionButton}
                            ${adminActions}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        homeActivityContainer.innerHTML = cardsHtml;
        initHomeDeadlineCountdowns();
    }

    function isDeadlineApproaching(deadlineIso, thresholdHours = DEADLINE_WARNING_HOURS) {
        if (!deadlineIso) return false;
        const target = new Date(deadlineIso).getTime();
        if (isNaN(target)) return false;
        const now = Date.now();
        if (target <= now) return false;
        const hoursDiff = (target - now) / (1000 * 60 * 60);
        return hoursDiff <= thresholdHours;
    }

    function formatDuration(durationMs) {
        if (!durationMs || durationMs <= 0) return '0 ชม.';
        const totalSeconds = Math.floor(durationMs / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        if (days > 0) {
            return `${days} วัน ${hours} ชม.`;
        }
        if (hours > 0) {
            return `${hours} ชม. ${minutes} นาที`;
        }
        return `${minutes} นาที`;
    }

    function initHomeDeadlineCountdowns() {
        if (!homeActivityContainer) return;
        homeCountdownElements = Array.from(homeActivityContainer.querySelectorAll('[data-deadline-countdown]'));
        if (!homeCountdownElements.length) {
            stopHomeCountdownInterval();
            return;
        }
        updateHomeCountdownElements();
        if (!homeCountdownInterval) {
            homeCountdownInterval = setInterval(updateHomeCountdownElements, 1000);
        }
    }

    function stopHomeCountdownInterval() {
        if (homeCountdownInterval) {
            clearInterval(homeCountdownInterval);
            homeCountdownInterval = null;
        }
    }

    function updateHomeCountdownElements() {
        if (!homeCountdownElements || homeCountdownElements.length === 0) {
            stopHomeCountdownInterval();
            return;
        }
        const now = Date.now();
        homeCountdownElements.forEach(el => {
            const deadline = el.dataset.deadline;
            if (!deadline) {
                el.classList.add('hidden');
                return;
            }
            const target = new Date(deadline).getTime();
            if (isNaN(target)) {
                el.classList.add('hidden');
                return;
            }
            const diff = target - now;
            if (diff <= 0) {
                el.classList.remove('text-rose-600');
                el.classList.add('text-slate-500');
                el.innerHTML = `<span class="material-symbols-outlined text-base">event_busy</span><span>ปิดรับสมัครแล้ว</span>`;
                return;
            }
            el.classList.remove('hidden');
            el.innerHTML = `<span class="material-symbols-outlined text-base">hourglass_bottom</span><span>เหลือเวลา ${formatDuration(diff)}</span>`;
        });
    }

    function updateHomeActivities({ resetVisibleCount = false } = {}) {
        if (!homeActivityContainer || !homeActivityMeta) return;
        if (resetVisibleCount) homeActivityState.visibleCount = homeActivityState.pageSize;

        const activities = Array.isArray(ALL_ACTIVITIES) ? [...ALL_ACTIVITIES] : [];
        const searchTerm = (homeActivityState.search || '').trim().toLowerCase();
        const selectedCategory = (homeActivityState.category || '').trim();
        let filtered = activities;

        if (selectedCategory) {
            filtered = filtered.filter(a => (a.category || '').toLowerCase() === selectedCategory.toLowerCase());
        }
        if (searchTerm) {
            filtered = filtered.filter(act => {
                const levels = Array.isArray(act.levels) ? act.levels.join(' ') : '';
                const blob = [act.name || '', act.category || '', levels, act.mode || ''].join(' ').toLowerCase();
                return blob.includes(searchTerm);
            });
        }

        const totalCount = filtered.length;
        const openCount = filtered.filter(a => !isActivityClosed(a)).length;
        const closedCount = totalCount - openCount;

        if (totalCount === 0) {
            const keyword = (homeActivityState.search || '').trim();
            const categorySuffix = selectedCategory ? `หมวด "${selectedCategory}"` : '';
            const keywordText = keyword ? `คำค้น "${keyword}"` : '';
            const extraText = [categorySuffix, keywordText].filter(Boolean).join(' ');
            const baseText = activities.length === 0
                ? 'ยังไม่มีกิจกรรมให้แสดง'
                : 'ไม่มีกิจกรรมที่ตรงเงื่อนไข';
            homeActivityMeta.textContent = `${baseText}${extraText ? ' | ' + extraText : ''}`;
            renderHomeActivityCards([]);
            homeActivityLoadMoreBtn?.classList.add('hidden');
            homeActivityEmpty?.classList.remove('hidden');
            return;
        }

        homeActivityEmpty?.classList.add('hidden');

        const sorted = filtered.slice().sort((a, b) => {
            const closedDiff = Number(isActivityClosed(a)) - Number(isActivityClosed(b));
            if (closedDiff !== 0) return closedDiff;
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB, 'th');
        });

        const itemsToRender = sorted.slice(0, homeActivityState.visibleCount);
        renderHomeActivityCards(itemsToRender);

        const summaryParts = [`ทั้งหมด ${totalCount} รายการ`, `เปิด ${openCount}`, `ปิด ${closedCount}`];
        const filterTags = [];
        if (selectedCategory) filterTags.push(`หมวด ${selectedCategory}`);
        if (homeActivityState.search) filterTags.push(`คำค้น "${homeActivityState.search.trim()}"`);
        const filterText = filterTags.length ? ` | ${filterTags.join(' ? ')}` : '';
        homeActivityMeta.textContent = `พบกิจกรรม ${summaryParts.join(' / ')}${filterText}`;

        if (homeActivityLoadMoreBtn) {
            if (sorted.length > itemsToRender.length) {
                homeActivityLoadMoreBtn.classList.remove('hidden');
            } else {
                homeActivityLoadMoreBtn.classList.add('hidden');
            }
        }
    }

    function openActivityEditDialog(activityId) {
        if (!canEditActivities()) return;
        const activity = ALL_ACTIVITIES.find(act => act.id === activityId);
        if (!activity) {
            Swal.fire({ icon: 'error', title: 'ไม่พบกิจกรรม', text: 'ไม่สามารถแก้ไขกิจกรรมนี้ได้' });
            return;
        }
        const levelsValue = Array.isArray(activity.levels) ? activity.levels.join(', ') : '';
        const deadlineValue = activity.registrationDeadline
            ? new Date(activity.registrationDeadline).toISOString().slice(0, 16)
            : '';
        Swal.fire({
            title: `แก้ไขกิจกรรม`,
            html: `
                <div class="space-y-3 text-left">
                    <label class="block text-xs font-medium text-slate-600">ชื่อกิจกรรม</label>
                    <input id="activity-edit-name" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.name || '')}" required>
                    <label class="block text-xs font-medium text-slate-600">หมวดหมู่</label>
                    <input id="activity-edit-category" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.category || '')}">
                    <label class="block text-xs font-medium text-slate-600">ระดับที่รับ (คั่นด้วย ,)</label>
                    <input id="activity-edit-levels" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(levelsValue)}" placeholder="เช่น ม.1, ม.2">
                    <label class="block text-xs font-medium text-slate-600">รูปแบบการจัด (ออนไลน์/ออนไซต์)</label>
                    <input id="activity-edit-mode" type="text" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.mode || '')}">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600">ครูที่ต้องการ</label>
                            <input id="activity-edit-req-teachers" type="number" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.reqTeachers || '')}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600">นักเรียนที่ต้องการ</label>
                            <input id="activity-edit-req-students" type="number" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.reqStudents || '')}">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-600">จำนวนทีมสูงสุด</label>
                            <input id="activity-edit-max-teams" type="number" min="0" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${escapeHtmlClient(activity.maxTeams ?? '')}" placeholder="0 = ไม่จำกัด">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600">ปิดรับสมัคร</label>
                            <input id="activity-edit-deadline" type="datetime-local" class="w-full border border-slate-300 rounded-lg px-3 py-2" value="${deadlineValue}">
                        </div>
                    </div>
                </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            preConfirm: () => {
                const nameInput = document.getElementById('activity-edit-name');
                const reqTeacherInput = document.getElementById('activity-edit-req-teachers');
                const reqStudentInput = document.getElementById('activity-edit-req-students');
                if (!nameInput.value.trim()) {
                    Swal.showValidationMessage('กรุณากรอกชื่อกิจกรรม');
                    return false;
                }
                return {
                    id: activityId,
                    name: nameInput.value.trim(),
                    category: document.getElementById('activity-edit-category').value.trim(),
                    levels: document.getElementById('activity-edit-levels').value.split(',').map(v => v.trim()).filter(Boolean),
                    mode: document.getElementById('activity-edit-mode').value.trim(),
                    reqTeachers: reqTeacherInput.value,
                    reqStudents: reqStudentInput.value,
                    maxTeams: document.getElementById('activity-edit-max-teams').value,
                    registrationDeadline: document.getElementById('activity-edit-deadline').value
                };
            }
        }).then(result => {
            if (result.isConfirmed && result.value) {
                submitActivityEdit(result.value);
            }
        });
    }

    function submitActivityEdit(formData) {
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถแก้ไขกิจกรรมได้' });
            return;
        }
        Swal.fire({
            title: 'กำลังบันทึก...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });
        const payload = { ...formData, actor };
        google.script.run
            .withSuccessHandler(res => {
                Swal.close();
                if (res && res.success) {
                    Swal.fire({ icon: 'success', title: 'อัปเดตกิจกรรมสำเร็จ', timer: 1600, showConfirmButton: false });
                    loadInitialData(true);
                } else {
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: (res && res.error) || 'ไม่สามารถอัปเดตกิจกรรมได้' });
                }
            })
            .withFailureHandler(error => {
                Swal.close();
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: error.message || 'ไม่สามารถอัปเดตกิจกรรมได้' });
            })
            .updateActivityDetails(payload);
    }

    function handleHomeActivitySearchInput(e) {
        const value = e.target.value || '';
        if (homeSearchDebounce) clearTimeout(homeSearchDebounce);
        homeSearchDebounce = setTimeout(() => {
            homeActivityState.search = value;
            updateHomeActivities({ resetVisibleCount: true });
        }, 250);
    }
    function handleHomeActivityLoadMore() {
        homeActivityState.visibleCount += homeActivityState.pageSize;
        updateHomeActivities();
    }

    function handleHomeCategoryClick(e) {
        const { category } = e.currentTarget.dataset;
        homeActivityState.category = (homeActivityState.category === category) ? '' : category;
        updateHomeCategoryUI();
        updateHomeActivities({ resetVisibleCount: true });
    }

    function updateHomeCategoryUI() {
        if (!homeCategoryFilter) return;
        const buttons = homeCategoryFilter.querySelectorAll('button[data-category]');
        buttons.forEach(btn => {
            if (homeActivityState.category === btn.dataset.category) {
                btn.classList.add('bg-sky-500', 'text-white', 'border-transparent');
                btn.classList.remove('bg-white', 'border-slate-300', 'text-slate-600');
            } else {
                btn.classList.remove('bg-sky-500', 'text-white', 'border-transparent');
                btn.classList.add('bg-white', 'border-slate-300', 'text-slate-600');
            }
        });
    }

    function renderHomeCategoryFilter(categories) {
        if (!homeCategoryFilter) return;
        if (!categories || categories.length === 0) {
            homeCategoryFilter.innerHTML = '';
            homeActivityState.category = '';
            return;
        }
        if (homeActivityState.category && !categories.includes(homeActivityState.category)) {
            homeActivityState.category = '';
        }
        const buttonsHtml = [
            `<button type="button" data-category="" class="px-3 py-1.5 text-sm font-medium rounded-full border bg-white border-slate-300 text-slate-600 hover:bg-slate-100 transition-colors">ทั้งหมด</button>`
        ].concat(categories.map(c =>
            `<button type="button" data-category="${c}" class="px-3 py-1.5 text-sm font-medium rounded-full border bg-white border-slate-300 text-slate-600 hover:bg-slate-100 transition-colors">${c}</button>`
        )).join('');
        homeCategoryFilter.innerHTML = buttonsHtml;
        homeCategoryFilter.querySelectorAll('button[data-category]').forEach(btn => {
            btn.addEventListener('click', handleHomeCategoryClick);
        });
        updateHomeCategoryUI();
    }

    // --- Activities Filter section ---
    function renderGroupedActivityCards(activities) {
        const container = activityContainer;
        const loading = activityLoading;
        if (!container || !loading) return;

        if (!Array.isArray(activities) || activities.length === 0) {
            loading.innerText = 'ไม่พบกิจกรรมที่ตรงกับเงื่อนไข';
            loading.style.display = 'block';
            container.innerHTML = '';
            return;
        }

        loading.style.display = 'none';
        const grouped = activities.reduce((acc, act) => {
            const cat = act.category || 'ไม่ระบุหมวดหมู่';
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(act);
            return acc;
        }, {});

        let html = '';
        for (const category of Object.keys(grouped).sort()) {
            html += `<h2 class="text-2xl font-bold mb-3 px-2 mt-6 text-slate-800">${category}</h2>`;
            html += `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">`;
            grouped[category].forEach(act => {
                const levels = Array.isArray(act.levels) ? act.levels : [];
                const levelsHtml = levels.map(l => `<span class="text-xs font-medium bg-slate-200 text-slate-700 px-2 py-1 rounded-full">${l}</span>`).join(' ');
                const isClosed = isActivityClosed(act);
                const remainingTeams = calculateRemainingTeams(act);
                const hasLimit = typeof act.maxTeams === 'number' && act.maxTeams > 0;
                const limitText = hasLimit
                    ? `รับ ${act.maxTeams} ทีม (เหลือ ${typeof remainingTeams === 'number' ? remainingTeams : '-'} ทีม)`
                    : 'ไม่จำกัดทีม';
                const deadlineText = formatDeadline(act.registrationDeadline);
                const statusBadge = isClosed
                    ? '<span class="inline-flex items-center text-xs font-semibold text-rose-600 bg-rose-100 px-3 py-1 rounded-full">ปิดรับสมัคร</span>'
                    : '<span class="inline-flex items-center text-xs font-semibold text-emerald-600 bg-emerald-100 px-3 py-1 rounded-full">เปิดรับสมัคร</span>';
                const buttonClasses = isClosed
                    ? 'w-full bg-slate-300 text-slate-500 font-semibold px-5 py-2 rounded-lg shadow-sm cursor-not-allowed'
                    : 'w-full bg-sky-500 text-white font-semibold px-5 py-2 rounded-lg shadow-sm hover:bg-sky-600 transition-colors';
                const buttonAction = isClosed ? '' : `onclick="selectActivityForForm('${act.id}')"`;
                const buttonDisabled = isClosed ? 'disabled' : '';
                const buttonLabel = isClosed ? 'ปิดรับสมัคร' : 'สมัครทีม';
                const currentTeamsText = `ทีมที่ลงแล้ว: ${act.currentTeams || 0}`;
                html += `
                    <div class="activity-card bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden flex flex-col">
                        <div class="p-5 flex-grow space-y-3">
                            <div class="flex items-center justify-between gap-2">
                                <h3 class="text-xl font-bold text-slate-900">${act.name}</h3>
                                ${statusBadge}
                            </div>
                            <div class="flex flex-wrap gap-2">${levelsHtml}</div>
                            <div class="text-sm font-semibold ${act.mode === 'Onsite' ? 'text-blue-600' : 'text-purple-600'}">${act.mode}</div>
                            <div class="text-sm text-slate-600 space-y-1">
                                <p><span class="font-medium text-slate-700">จำนวนทีม:</span> ${limitText}</p>
                                <p><span class="font-medium text-slate-700">ปิดรับสมัคร:</span> ${deadlineText}</p>
                                <p><span class="font-medium text-slate-700">${currentTeamsText}</span></p>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4">
                            <button class="${buttonClasses}" ${buttonAction} ${buttonDisabled}>${buttonLabel}</button>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        container.innerHTML = html;
    }

    function populateActivityFilters(activities) {
        const categorySelect = document.getElementById('filter-category');
        const nameSelect = document.getElementById('filter-activity-name');
        const previousCategory = categorySelect.value;
        const previousName = nameSelect.value;

        categorySelect.innerHTML = '<option value="">-- เลือกหมวดหมู่กิจกรรม --</option>';
        nameSelect.innerHTML = '<option value="">-- เลือกกิจกรรม --</option>';

        const categories = [...new Set(activities.map(a => a.category))].filter(Boolean);
        categories.forEach(cat => categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`);
        activities.forEach(act => nameSelect.innerHTML += `<option value="${act.name}">${act.name}</option>`);

        if (!categorySelect.dataset.initialized) {
            categorySelect.addEventListener('change', updateActivityView);
            categorySelect.dataset.initialized = 'true';
        }
        if (!nameSelect.dataset.initialized) {
            nameSelect.addEventListener('change', updateActivityView);
            nameSelect.dataset.initialized = 'true';
        }

        if (previousCategory && categories.includes(previousCategory)) categorySelect.value = previousCategory;
        if (previousName && activities.some(a => a.name === previousName)) nameSelect.value = previousName;
    }

    function updateActivityView() {
        const catFilter = document.getElementById('filter-category').value;
        const nameFilter = document.getElementById('filter-activity-name').value;
        let filtered = ALL_ACTIVITIES;
        if (catFilter) filtered = filtered.filter(a => a.category === catFilter);
        if (nameFilter) filtered = filtered.filter(a => a.name === nameFilter);
        renderGroupedActivityCards(filtered);
    }

    function populateFormActivitySelect(activities) {
        activitySelect.innerHTML = '<option value="">-- เลือกกิจกรรม --</option>';
        activitySelect.disabled = activities.length === 0;
        activities.forEach(act => {
            const closed = isActivityClosed(act);
            const labelSuffix = closed ? ' - ปิดรับสมัคร' : '';
            const categoryLabel = act.category || 'ไม่ระบุหมวดหมู่';
            activitySelect.innerHTML += `<option value="${act.id}" data-closed="${closed}">${act.name} (${categoryLabel})${labelSuffix}</option>`;
        });
    }

    function populateFormCategorySelect(categories) {
        if (!activityCategorySelect) return;
        const prev = activityCategorySelect.value;
        activityCategorySelect.innerHTML = '<option value="">-- เลือกหมวดหมู่ --</option>';
        categories.forEach(c => activityCategorySelect.innerHTML += `<option value="${c}">${c}</option>`);
        if (prev && categories.includes(prev)) activityCategorySelect.value = prev;
        else activityCategorySelect.value = '';
    }

    function refreshActivityTeamCounts() {
        if (!Array.isArray(ALL_ACTIVITIES) || ALL_ACTIVITIES.length === 0) return;
        const prevId = activitySelect.value;
        const counts = {};
        ALL_TEAMS.forEach(t => {
            if (!t.activity) return;
            counts[t.activity] = (counts[t.activity] || 0) + 1;
        });
        ALL_ACTIVITIES = ALL_ACTIVITIES.map(activity => {
            const updated = { ...activity };
            const maxTeams = typeof updated.maxTeams === 'number' && updated.maxTeams > 0 ? updated.maxTeams : null;
            updated.currentTeams = counts[activity.id] || 0;
            if (maxTeams !== null) {
                updated.remainingTeams = Math.max(maxTeams - updated.currentTeams, 0);
                updated.isFull = updated.remainingTeams === 0;
            } else {
                updated.remainingTeams = null;
                updated.isFull = false;
            }
            const deadlineIso = updated.registrationDeadline || null;
            const deadlinePassed = deadlineIso ? Date.now() > new Date(deadlineIso).getTime() : !!updated.deadlinePassed;
            updated.deadlinePassed = deadlinePassed;
            updated.isClosed = updated.isFull || deadlinePassed;
            return updated;
        });

        const categories = getAllCategories(ALL_ACTIVITIES);
        populateFormCategorySelect(categories);
        renderHomeCategoryFilter(categories);
        const formActs = getFormActivities();
        populateFormActivitySelect(formActs);

        if (prevId) {
            const selected = ALL_ACTIVITIES.find(a => a.id === prevId);
            const still = formActs.some(a => a.id === prevId);
            if (selected && !isActivityClosed(selected) && still) {
                activitySelect.value = prevId;
            } else {
                activitySelect.value = '';
            }
        }

        updateFormBasedOnActivity(activitySelect.value || '');
        updateHomeActivities();
        updateActivityView();
    }

    function getStatusBadge(status) {
        if (status === 'Approved') {
            return '<span class="px-2 py-1 text-xs font-semibold rounded-full badge-green">Approved</span>';
        }
        if (status === 'Rejected') {
            return '<span class="px-2 py-1 text-xs font-semibold rounded-full badge-red">Rejected</span>';
        }
        return '<span class="px-2 py-1 text-xs font-semibold rounded-full badge-yellow">Pending</span>';
    }

    // --- Team Photos helpers ---
    function buildDriveThumbUrl(fileId, size) {
        if (!fileId) return null;
        const s = size || 256;
        return 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(fileId) + '&sz=w' + s;
    }
    function getUserAvatarUrl(user, size = 128) {
        if (!user) return '';
        if (user.avatarFileId) return buildDriveThumbUrl(user.avatarFileId, size);
        if (user.avatarUrl) return user.avatarUrl;
        return '';
    }
    function getMemberPhotoUrl(member) {
        if (!member || typeof member !== 'object') return null;
        if (member.photoUrl) return member.photoUrl;
        if (member.photoURL) return member.photoURL;
        if (member.photoDriveId) return buildDriveThumbUrl(member.photoDriveId, 256);
        if (member.photoId) return buildDriveThumbUrl(member.photoId, 256);
        return null;
    }
    function renderMemberCard(member, index, labelPrefix) {
        const name = escapeHtmlClient(member.name || `${labelPrefix} ${index}`);
        const phone = escapeHtmlClient(member.phone || member.tel || '');
        const cls = escapeHtmlClient(member.class || member.room || '');
        const role = escapeHtmlClient(member.role || '');
        const photoUrl = getMemberPhotoUrl(member);
        const photoBlock = photoUrl
            ? `<img src="${photoUrl}" alt="${name}" class="w-14 h-14 rounded-full object-cover border border-slate-200" loading="lazy">`
            : `<div class="w-14 h-14 rounded-full bg-slate-100 border border-dashed border-slate-300 flex items-center justify-center text-slate-400">
                    <span class="material-symbols-outlined text-base">person</span>
               </div>`;
        return `
            <div class="flex items-center gap-3 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2">
                ${photoBlock}
                <div class="text-xs leading-snug">
                    <div class="font-semibold text-slate-800">${name}</div>
                    ${role ? `<div class="text-slate-500">${role}</div>` : ''}
                    ${cls ? `<div class="text-slate-500">ชั้น: ${cls}</div>` : ''}
                    ${phone ? `<div class="text-slate-500">โทร: ${phone}</div>` : ''}
                </div>
            </div>
        `;
    }

    // --- Modal: รูปทีม + รายละเอียดกิจกรรม/รูปประจำทีม ---
    function openTeamPhotoModal(teamId) {
        const modal = document.getElementById('team-photo-modal');
        const content = document.getElementById('team-photo-modal-content');
        if (!modal || !content) return;
        const team = ALL_TEAMS.find(t => t.teamId === teamId);
        if (!team) {
            Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูลทีม', text: 'ไม่พบทีมที่ต้องการแสดงรูป' });
            return;
        }

        const activityObj = ALL_ACTIVITIES.find(a => a.id === team.activity) || {};
        const activityName = activityObj.name || 'ไม่ระบุกิจกรรม';
        const category = activityObj.category || 'ไม่ระบุหมวดหมู่';
        const mode = activityObj.mode || '-';
        const deadlineText = formatDeadline(activityObj.registrationDeadline, 'ไม่ระบุ');
        const remainingTeams = calculateRemainingTeams(activityObj);
        const maxTeams = (typeof activityObj.maxTeams === 'number' && activityObj.maxTeams > 0) ? activityObj.maxTeams : null;
        const limitText = maxTeams
            ? `รับ ${maxTeams} ทีม (เหลือ ${typeof remainingTeams === 'number' ? remainingTeams : '-'} ทีม)`
            : 'ไม่จำกัดทีม';
        const levelLabel = team.level || (Array.isArray(activityObj.levels) ? activityObj.levels.join(', ') : '-');

        const members = safeJsonParse(team.members, { teachers: [], students: [] });
        const teachers = Array.isArray(members.teachers) ? members.teachers : [];
        const students = Array.isArray(members.students) ? members.students : [];

        const logoUrl = team.logoUrl ? buildDriveThumbUrl(team.logoUrl, 256) : null;
        const teamPhotoUrl =
            team.teamPhotoUrl ||
            members.teamPhotoUrl ||
            (members.teamPhotoId ? buildDriveThumbUrl(members.teamPhotoId, 512) : null);

        const hasTeacherPhoto = teachers.some(t => getMemberPhotoUrl(t));
        const hasStudentPhoto = students.some(s => getMemberPhotoUrl(s));

        const headerHtml = `
            <div>
                <div class="text-xs text-slate-500 mb-1">รหัสทีม ${escapeHtmlClient(team.teamId || '')}</div>
                <div class="text-xl font-semibold text-slate-900">
                    ${escapeHtmlClient(team.teamName || '-')}
                </div>
                <div class="text-sm text-slate-600">
                    ${escapeHtmlClient(team.school || '')}
                </div>
            </div>
        `;

        const logoHtml = logoUrl ? `
            <div class="flex flex-col items-center gap-2">
                <div class="w-24 h-24 rounded-2xl overflow-hidden border border-slate-200 bg-white flex items-center justify-center">
                    <img src="${logoUrl}" alt="โลโก้ทีม" class="w-full h-full object-cover" loading="lazy">
                </div>
                <div class="text-xs text-slate-500 uppercase tracking-wide">โลโก้ทีม</div>
            </div>
        ` : '';

        const activityDetailHtml = `
            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                <div class="p-3 rounded-xl bg-sky-50 border border-sky-100">
                    <div class="text-xs font-semibold text-sky-600 mb-1 uppercase">รายละเอียดกิจกรรม</div>
                    <div class="font-semibold text-slate-900">${escapeHtmlClient(activityName)}</div>
                    <div class="text-slate-600">หมวดกิจกรรม: ${escapeHtmlClient(category)}</div>
                    <div class="text-slate-600">ระดับที่สมัคร: ${escapeHtmlClient(levelLabel)}</div>
                    <div class="text-slate-600">รูปแบบการแข่งขัน: ${escapeHtmlClient(mode)}</div>
                </div>
                <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
                    <div class="text-xs font-semibold text-slate-500 mb-1 uppercase">สถานะการรับสมัครกิจกรรม</div>
                    <div class="text-slate-600">จำนวนทีม: ${escapeHtmlClient(limitText)}</div>
                    <div class="text-slate-600">ปิดรับสมัคร: ${escapeHtmlClient(deadlineText)}</div>
                </div>
            </div>
        `;

        const teamPhotoBlock = teamPhotoUrl ? `
            <div class="mt-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-semibold text-slate-600">รูปภาพทีม (รวมสมาชิก)</div>
                    <div class="text-xs px-2 py-0.5 rounded-full bg-sky-50 text-sky-600 border border-sky-100">
                        รูปประจำทีมอย่างเป็นทางการ
                    </div>
                </div>
                <div class="w-full rounded-2xl overflow-hidden border border-slate-200 bg-slate-50">
                    <img src="${teamPhotoUrl}" alt="รูปทีม" class="w-full object-contain max-h-72 bg-slate-50" loading="lazy">
                </div>
                <div class="mt-2 flex items-start gap-2 text-xs text-slate-500">
                    <span class="material-symbols-outlined text-base text-sky-500 leading-none">info</span>
                    <div>
                        รูปนี้ใช้เป็น <span class="font-semibold">รูปประจำทีม</span> สำหรับแสดงบนรายชื่อทีม, หน้ารายงานผล,
                        ป้ายชื่อ/บัตรประจำตัว และสื่อประชาสัมพันธ์ของงานแข่งขัน
                    </div>
                </div>
            </div>
        ` : '';

        let teachersHtml = '';
        if (teachers.length) {
            teachersHtml = `
                <div class="mt-4">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-base text-slate-500">school</span>
                        <div class="text-sm font-semibold text-slate-600">
                            ครูผู้ควบคุม (${teachers.length} คน)
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${teachers.map((t, i) => renderMemberCard(t, i + 1, 'ครู')).join('')}
                    </div>
                </div>
            `;
        }

        let studentsHtml = '';
        if (students.length) {
            studentsHtml = `
                <div class="mt-4">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="material-symbols-outlined text-base text-slate-500">group</span>
                        <div class="text-sm font-semibold text-slate-600">
                            นักเรียน (${students.length} คน)
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        ${students.map((s, i) => renderMemberCard(s, i + 1, 'นักเรียน')).join('')}
                    </div>
                </div>
            `;
        }

        const noPhoto = !logoUrl && !teamPhotoUrl && !hasTeacherPhoto && !hasStudentPhoto;
        const noPhotoHtml = noPhoto ? `
            <div class="mt-4 p-3 rounded-xl bg-slate-50 border border-dashed border-slate-300 text-xs text-slate-500 flex items-center gap-2">
                <span class="material-symbols-outlined text-slate-400 text-base">info</span>
                ยังไม่มีรูปทีม/รูปสมาชิกที่บันทึกไว้ในระบบสำหรับทีมนี้
            </div>
        ` : '';

        content.innerHTML = `
            <div class="flex items-start justify-between gap-4">
                ${headerHtml}
                ${logoHtml}
            </div>
            ${activityDetailHtml}
            ${teamPhotoBlock}
            ${teachersHtml}
            ${studentsHtml}
            ${noPhotoHtml}
        `;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeTeamPhotoModal() {
        const modal = document.getElementById('team-photo-modal');
        if (!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    document.addEventListener('click', (e) => {
        const modal = document.getElementById('team-photo-modal');
        if (!modal || modal.classList.contains('hidden')) return;
        if (e.target === modal) closeTeamPhotoModal();
    });

    // --- Team table ---
    function applyTeamFilters(teams, activityMap) {
        if (!teamSearchTerm) return [...teams];
        const keyword = teamSearchTerm;
        return teams.filter(team => {
            const activityObj = activityMap.get(team.activity) || {};
            const contact = safeJsonParse(team.contact, {});
            const values = [
                team.teamId,
                team.teamName,
                team.school,
                team.level,
                activityObj.name,
                activityObj.category,
                contact.name,
                contact.phone,
                contact.email,
                team.status
            ];
            return values.some(v => (v || '').toString().toLowerCase().includes(keyword));
        });
    }

    function applyTeamLogoFallbacks() {
        if (!teamTableBody) return;
        const images = teamTableBody.querySelectorAll('img[data-team-logo="true"]');
        images.forEach(img => {
            img.addEventListener('error', () => {
                const wrapper = img.closest('.team-logo-wrapper');
                if (wrapper) {
                    wrapper.innerHTML = '<span class="material-symbols-outlined text-lg text-slate-400">image_not_supported</span>';
                    wrapper.classList.remove('bg-white');
                    wrapper.classList.add('bg-slate-100', 'flex', 'items-center', 'justify-center', 'text-slate-400');
                }
            }, { once: true });
        });
    }

    function renderTeamTableSkeleton(rows = 3) {
        if (!teamTableBody) return;
        const skeletonRow = `
            <tr class="animate-pulse">
                <td colspan="8" class="p-4">
                    <div class="space-y-2">
                        <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                        <div class="h-3 bg-slate-100 rounded w-full"></div>
                        <div class="h-3 bg-slate-100 rounded w-2/3"></div>
                    </div>
                </td>
            </tr>
        `;
        teamTableBody.innerHTML = Array.from({ length: rows }).map(() => skeletonRow).join('');
    }

    function showProfileTeamsLoadingState() {
        if (!profileTeamList || !currentUser) return;
        profileTeamList.innerHTML = `
            <div class="rounded-2xl border border-slate-200 p-4 bg-white animate-pulse space-y-2">
                <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                <div class="h-3 bg-slate-100 rounded w-2/3"></div>
                <div class="h-3 bg-slate-100 rounded w-full"></div>
            </div>
            <p class="text-xs text-slate-500 mt-2">กำลังตรวจสอบทีมของคุณ...</p>
        `;
    }

    function renderTeamTable(teams) {
        if (!teamTableBody) return;
        const userId = getCurrentUserId();
        if (!userId) {
            teamTableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-slate-500">กรุณาเข้าสู่ระบบเพื่อดูทีมของคุณ</td></tr>';
            return;
        }
        if (!Array.isArray(teams) || teams.length === 0) {
            teamTableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-slate-500">ยังไม่มีทีมที่ลงทะเบียนในระบบ</td></tr>';
            return;
        }

        const activityMap = new Map(ALL_ACTIVITIES.map(act => [act.id, act]));
        const userTeams = filterTeamsForCurrentUser(teams);
        if (userTeams.length === 0) {
            teamTableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-slate-500">ไม่มีทีมในสิทธิ์ของคุณ</td></tr>';
            return;
        }

        const filteredTeams = applyTeamFilters(userTeams, activityMap);

        if (filteredTeams.length === 0) {
            teamTableBody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-slate-500">ไม่พบทีมของคุณที่ตรงกับคำค้นหา</td></tr>';
            return;
        }

        const role = getCurrentUserLevel();
        const groupingMode = ['admin', 'area', 'group_admin'].includes(role) ? 'cluster' : 'category';
        const groupedByKey = new Map();
        filteredTeams.forEach(team => {
            const activityObj = activityMap.get(team.activity);
            const clusterLabel = getTeamClusterLabel(team) || 'ไม่ระบุเครือข่าย';
            const categoryLabel = activityObj && activityObj.category ? activityObj.category : 'ไม่ระบุหมวดหมู่';
            const bucket = groupingMode === 'cluster' ? clusterLabel : categoryLabel;
            if (!groupedByKey.has(bucket)) groupedByKey.set(bucket, []);
            groupedByKey.get(bucket).push({ team, activityObj });
        });

        const sortedGroups = Array.from(groupedByKey.keys()).sort((a, b) => a.localeCompare(b, 'th'));

        let html = '';
        sortedGroups.forEach(group => {
            html += `
                <tr class="bg-slate-100">
                    <td colspan="8" class="p-3 text-sm font-semibold text-slate-700">${escapeHtmlClient(groupingMode === 'cluster' ? `เครือข่าย: ${group}` : `หมวดหมู่: ${group}`)}</td>
                </tr>
            `;
            groupedByKey.get(group).forEach(({ team, activityObj }) => {
                const members = safeJsonParse(team.members, { teachers: [], students: [] });
                const teachers = Array.isArray(members.teachers) ? members.teachers : [];
                const students = Array.isArray(members.students) ? members.students : [];
                const numTeachers = teachers.length;
                const numStudents = students.length;
                const activityName = activityObj ? activityObj.name : (team.activity || 'N/A');
                const category = activityObj && activityObj.category ? activityObj.category : 'ไม่ระบุหมวดหมู่';
                const requiredTeachers = team.requiredTeachers || (activityObj ? activityObj.reqTeachers : '-');
                const requiredStudents = team.requiredStudents || (activityObj ? activityObj.reqStudents : '-');
                const contact = safeJsonParse(team.contact, {});
                const canManage = canManageTeam(team);
                const teamLocked = isTeamLockedForEdit(team);
                const manageDisabledAttr = canManage ? '' : 'disabled';
                const manageBtnClass = canManage
                    ? 'inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-sky-600 hover:bg-sky-50'
                    : 'inline-flex items-center gap-1 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-400 cursor-not-allowed bg-slate-50';
                const manageLabel = teamLocked ? 'ดูข้อมูล' : 'จัดการ';

                let logoHtml = `
                    <div class="team-logo-wrapper w-9 h-9 rounded-full border border-slate-200 bg-slate-100 flex items-center justify-center mr-3 text-slate-400">
                        <span class="material-symbols-outlined text-lg">image_not_supported</span>
                    </div>
                `;
                if (team.logoUrl) {
                    const publicLogoUrl = buildDriveThumbUrl(team.logoUrl, 80);
                    logoHtml = `
                        <div class="team-logo-wrapper w-9 h-9 rounded-full border border-slate-200 bg-white overflow-hidden mr-3 flex items-center justify-center">
                            <img src="${publicLogoUrl}" alt="โลโก้ทีม ${escapeHtmlClient(team.teamName || '')}" class="w-full h-full object-cover" loading="lazy" referrerpolicy="no-referrer" data-team-logo="true">
                        </div>
                    `;
                }

                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-3 text-sm text-slate-700 font-semibold whitespace-nowrap">
                            ${escapeHtmlClient(team.teamId || '')}
                        </td>
                        <td class="p-3 text-sm text-slate-700">
                            <div class="font-medium text-slate-800">${escapeHtmlClient(activityName)}</div>
                            <div class="text-xs text-slate-500">${escapeHtmlClient(category || '')}</div>
                        </td>
                        <td class="p-3 text-sm text-slate-700">
                            <div class="flex items-center">
                                ${logoHtml}
                                <div>
                                    <div class="font-medium text-slate-800">${escapeHtmlClient(team.teamName || '-')}</div>
                                    <div class="text-xs text-slate-500">${escapeHtmlClient(team.school || '-')}</div>
                                    <div class="text-[11px] text-amber-600">เครือข่าย: ${escapeHtmlClient(getTeamClusterLabel(team) || 'ไม่ระบุ')}</div>
                                    <button type="button"
                                        class="mt-1 inline-flex items-center gap-1 text-[10px] text-sky-600 hover:text-sky-800"
                                        onclick="openTeamPhotoModal('${team.teamId}')">
                                        <span class="material-symbols-outlined text-[14px] leading-none">image</span>
                                        สมาชิก
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(requiredTeachers)} / <strong>${numTeachers}</strong>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(requiredStudents)} / <strong>${numStudents}</strong>
                        </td>
                        <td class="p-3 text-sm text-slate-600">
                            ${escapeHtmlClient(team.level || '-')}
                        </td>
                        <td class="p-3 text-sm">
                            ${getStatusBadge(team.status)}
                        </td>
                        <td class="p-3 text-sm">
                            <button type="button" class="${manageBtnClass}"
                                ${manageDisabledAttr}
                                onclick="openTeamManager('${team.teamId}')">
                                <span class="material-symbols-outlined text-base">settings</span>
                                <span>${manageLabel}</span>
                            </button>
                            ${teamLocked ? '<p class="text-[11px] text-amber-600 mt-1">สถานะ Print: เปิดอ่านอย่างเดียว</p>' : ''}
                        </td>
                    </tr>
                `;
            });
        });

        teamTableBody.innerHTML = html;
        applyTeamLogoFallbacks();
    }

    function updateTeamManageStatusPill(status) {
        if (!teamManageStatusPill) return;
        const normalized = (status || '').toString().trim().toLowerCase();
        const classMap = {
            approved: 'bg-emerald-50 border-emerald-200 text-emerald-700',
            print: 'bg-slate-100 border-slate-200 text-slate-600',
            rejected: 'bg-red-50 border-red-200 text-red-600',
            pending: 'bg-amber-50 border-amber-200 text-amber-700'
        };
        const classes = classMap[normalized] || 'bg-slate-50 border-slate-200 text-slate-600';
        teamManageStatusPill.className = `px-2 py-1 text-xs font-semibold rounded-full border ${classes}`;
        teamManageStatusPill.textContent = status || '-';
    }

    function openTeamManager(teamId) {
        if (!teamManagePanel) return;
        const team = ALL_TEAMS.find(t => t.teamId === teamId);
        if (!team) {
            Swal.fire({ icon: 'error', title: 'ไม่พบทีม', text: 'ไม่สามารถเปิดการจัดการทีมได้' });
            return;
        }
        const contact = safeJsonParse(team.contact, {});
        const members = safeJsonParse(team.members, { teachers: [], students: [] });
        activeManagedTeam = { ...team, contact };
        resetTeamManageLogoUI();
        resetTeamManagePhotoUI();
        resetTeamManageMemberPhotoData();
        managedTeamMembers = {
            teachers: Array.isArray(members.teachers) ? members.teachers.map(t => {
                const entry = {
                    prefix: t.prefix || '',
                    name: t.name || '',
                    phone: t.phone || t.tel || '',
                    role: t.role || '',
                    class: t.class || t.room || '',
                    photoDriveId: t.photoDriveId || t.photoId || ''
                };
                ensureMemberKey(entry, 'teacher');
                return entry;
            }) : [],
            students: Array.isArray(members.students) ? members.students.map(s => {
                const entry = {
                    prefix: s.prefix || '',
                    name: s.name || '',
                    class: s.class || s.room || '',
                    role: s.role || '',
                    photoDriveId: s.photoDriveId || s.photoId || ''
                };
                ensureMemberKey(entry, 'student');
                return entry;
            }) : []
        };
        teamManageEditable = canManageTeam(team) && !isTeamLockedForEdit(team);
        teamManageStatusEditable = teamManageEditable && canEditTeamStatusClient();
        teamManageImageEditable = teamManageEditable && canEditTeamImagesClient();
        if (teamManageTitle) teamManageTitle.textContent = `${team.teamId || ''} • ${team.teamName || '-'}`;
        if (teamManageClusterLabel) teamManageClusterLabel.textContent = `เครือข่าย: ${getTeamClusterLabel(team) || 'ไม่ระบุ'}`;
        if (teamManageNameInput) teamManageNameInput.value = team.teamName || '';
        if (teamManageStatusSelect) {
            teamManageStatusSelect.value = team.status || 'Pending';
            teamManageStatusSelect.disabled = !teamManageStatusEditable;
        }
        if (teamManageContactNameInput) teamManageContactNameInput.value = contact.name || '';
        if (teamManageContactPhoneInput) teamManageContactPhoneInput.value = contact.phone || '';
        if (teamManageContactEmailInput) teamManageContactEmailInput.value = contact.email || '';
        if (teamManageLockNotice) teamManageLockNotice.classList.toggle('hidden', teamManageEditable);
        const logoUrl = team.logoUrl ? buildDriveThumbUrl(team.logoUrl, 200) : '';
        if (logoUrl && teamManageLogoPreview) {
            teamManageLogoPreview.src = logoUrl;
            teamManageLogoPreview.classList.remove('hidden');
            teamManageLogoPlaceholder?.classList.add('hidden');
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = 'ใช้โลโก้เดิมอยู่ (อัปโหลดใหม่เพื่อเปลี่ยน)';
                teamManageLogoStatus.style.color = '#64748b';
            }
        }
        const teamPhotoId = team.teamPhotoId || team.teamPhotoUrl;
        const photoUrl = teamPhotoId ? (team.teamPhotoUrl || buildDriveThumbUrl(teamPhotoId, 320)) : '';
        if (photoUrl && teamManagePhotoPreview) {
            teamManagePhotoPreview.src = photoUrl;
            teamManagePhotoPreview.classList.remove('hidden');
            teamManagePhotoPlaceholder?.classList.add('hidden');
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = 'ใช้รูปทีมเดิมอยู่ (อัปโหลดใหม่เพื่อเปลี่ยน)';
                teamManagePhotoStatus.style.color = '#64748b';
            }
        }
        if (teamManageLogoInput) teamManageLogoInput.disabled = !teamManageImageEditable;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = !teamManageImageEditable;
        if (teamManagePhotoOpen) {
            teamManagePhotoOpen.disabled = !teamPhotoId;
            teamManagePhotoOpen.dataset.teamId = team.teamId || '';
        }
        updateTeamManageStatusPill(team.status || 'Pending');
        updateTeamManageControlsState();
        renderTeamManageMembers();
        if (teamManageFeedback) {
            teamManageFeedback.textContent = teamManageEditable ? 'ปรับปรุงข้อมูลแล้วกดบันทึก' : 'ทีมนี้ถูกล็อก ไม่สามารถแก้ไขได้';
        }
        teamManagePanel.classList.remove('hidden');
        teamManagePanel.classList.add('flex');
    }

    function closeTeamManager() {
        if (!teamManagePanel) return;
        teamManagePanel.classList.add('hidden');
        teamManagePanel.classList.remove('flex');
        activeManagedTeam = null;
        managedTeamMembers = { teachers: [], students: [] };
        teamManageEditable = false;
        teamManageStatusEditable = false;
        teamManageImageEditable = false;
        resetTeamManageLogoUI();
        resetTeamManagePhotoUI();
        resetTeamManageMemberPhotoData();
        if (teamManageLogoInput) teamManageLogoInput.disabled = true;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = true;
        if (teamManagePhotoOpen) {
            teamManagePhotoOpen.disabled = true;
            delete teamManagePhotoOpen.dataset.teamId;
        }
        if (teamManageClusterLabel) {
            teamManageClusterLabel.textContent = 'เครือข่าย: -';
        }
        if (teamManageFeedback) {
            teamManageFeedback.textContent = 'ปรับปรุงข้อมูลให้ถูกต้องก่อนบันทึก';
        }
    }

    function updateTeamManageControlsState() {
        const disabled = !teamManageEditable;
        [teamManageNameInput, teamManageContactNameInput, teamManageContactPhoneInput, teamManageContactEmailInput].forEach(el => {
            if (el) el.disabled = disabled;
        });
        if (teamManageStatusSelect) {
            teamManageStatusSelect.disabled = disabled || !teamManageStatusEditable;
        }
        if (teamManageSaveButton) {
            teamManageSaveButton.disabled = disabled;
            teamManageSaveButton.classList.toggle('opacity-60', disabled);
        }
        if (teamManageDeleteButton) {
            teamManageDeleteButton.disabled = disabled;
            teamManageDeleteButton.classList.toggle('opacity-60', disabled);
        }
        if (teamAddTeacherBtn) teamAddTeacherBtn.disabled = disabled;
        if (teamAddStudentBtn) teamAddStudentBtn.disabled = disabled;
        if (teamManageLogoInput) teamManageLogoInput.disabled = disabled || !teamManageImageEditable;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = disabled || !teamManageImageEditable;
        if (teamManagePhotoOpen) {
            const previewSrc = teamManagePhotoPreview ? teamManagePhotoPreview.src : '';
            teamManagePhotoOpen.disabled = !activeManagedTeam || (!activeManagedTeam.teamPhotoId && !previewSrc);
        }
        updateTeamManageStatusHint(teamManageStatusEditable);
    }

    function updateTeamManageStatusHint(canEdit) {
        if (!teamManageStatusHint) return;
        teamManageStatusHint.textContent = canEdit
            ? 'คุณสามารถเปลี่ยนสถานะทีมนี้ได้'
            : 'สิทธิ์ Admin/Area เท่านั้นที่สามารถแก้สถานะ';
    }

    function renderTeamManageMembers() {
        const editable = teamManageEditable;
        if (teamManageTeachersContainer) {
            teamManageTeachersContainer.innerHTML = managedTeamMembers.teachers.length
                ? managedTeamMembers.teachers.map((teacher, index) => renderManagedTeacherCard(teacher, index, editable)).join('')
                : '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลครู</p>';
        }
        if (teamManageStudentsContainer) {
            teamManageStudentsContainer.innerHTML = managedTeamMembers.students.length
                ? managedTeamMembers.students.map((student, index) => renderManagedStudentCard(student, index, editable)).join('')
                : '<p class="text-xs text-slate-500">ยังไม่มีข้อมูลนักเรียน</p>';
        }
        attachMemberPhotoListeners();
        updateMemberAddButtonsState();
        document.querySelectorAll('[data-class-level-select="true"]').forEach(select => toggleClassLevelCustomInput(select));
    }

    function renderManagedTeacherCard(teacher, index, editable) {
        const displayIndex = index + 1;
        const memberKey = ensureMemberKey(teacher, 'teacher');
        const previewId = `teacher-manage-${memberKey}-preview`;
        const placeholderId = `teacher-manage-${memberKey}-placeholder`;
        const statusId = `teacher-manage-${memberKey}-status`;
        const photoUrl = getManagedMemberPreviewUrl(memberKey, getMemberPhotoUrl(teacher));
        const removeButton = editable
            ? `<button type="button" class="text-[11px] text-red-500 hover:text-red-600" onclick="removeManagedMember('teacher', ${index})">ลบครูคนนี้</button>`
            : '';
        return `
            <div class="rounded-lg border border-slate-200 bg-white p-3 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2 text-xs">
                    <input type="text"
                        list="teacher-prefix-options"
                        class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="คำนำหน้า"
                        value="${escapeHtmlClient(teacher.prefix || '')}"
                        ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('teacher', ${index}, 'prefix', this.value)">
                    <input type="text" class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="ชื่อ-สกุล" value="${escapeHtmlClient(teacher.name || '')}" ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('teacher', ${index}, 'name', this.value)">
                    <input type="text" class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="เบอร์โทร" value="${escapeHtmlClient(teacher.phone || '')}" ${editable ? '' : 'disabled'}
                        data-only-digits="true" inputmode="numeric" pattern="[0-9]*"
                        oninput="updateManagedMember('teacher', ${index}, 'phone', this.value)">
                    ${buildClassLevelControlHtml('teacher', displayIndex, teacher.class || '', { scope: 'manage', disabled: !editable, managedIndex: index })}
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                        ${photoUrl ? `<img id="${previewId}" src="${photoUrl}" alt="Teacher ${displayIndex}" class="w-full h-full object-cover">`
                            : `<img id="${previewId}" alt="Teacher ${displayIndex}" class="hidden w-full h-full object-cover">
                               <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>`}
                        ${photoUrl ? `<span id="${placeholderId}" class="hidden"></span>` : ''}
                    </div>
                    <div class="flex-1 space-y-1">
                        <input type="file"
                            data-member-photo="true"
                            data-member-type="teacher"
                            data-member-index="${displayIndex}"
                            data-photo-scope="manage"
                            data-member-key="${memberKey}"
                            data-preview-target="${previewId}"
                            data-placeholder-target="${placeholderId}"
                            data-status-target="${statusId}"
                            class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200"
                            accept="image/png,image/jpeg"
                            ${editable ? '' : 'disabled'}>
                        <p id="${statusId}" class="text-[11px] text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)">
                            ${photoUrl ? 'ใช้รูปเดิมอยู่' : 'อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)'}
                        </p>
                    </div>
                </div>
                ${removeButton}
            </div>
        `;
    }
    function getManagedMemberLimit(type) {
        if (!activeManagedTeam) return null;
        const activity = ALL_ACTIVITIES.find(a => a.id === activeManagedTeam.activity);
        if (type === 'teachers') {
            return Number(activeManagedTeam.requiredTeachers || activity?.reqTeachers || 0) || null;
        }
        if (type === 'students') {
            return Number(activeManagedTeam.requiredStudents || activity?.reqStudents || 0) || null;
        }
        return null;
    }
    function updateMemberAddButtonsState() {
        const teacherLimit = getManagedMemberLimit('teachers');
        const studentLimit = getManagedMemberLimit('students');
        if (teamAddTeacherBtn) {
            const disabled = !teamManageEditable || (teacherLimit && managedTeamMembers.teachers.length >= teacherLimit);
            teamAddTeacherBtn.disabled = disabled;
            teamAddTeacherBtn.classList.toggle('opacity-50', disabled);
        }
        if (teamAddStudentBtn) {
            const disabled = !teamManageEditable || (studentLimit && managedTeamMembers.students.length >= studentLimit);
            teamAddStudentBtn.disabled = disabled;
            teamAddStudentBtn.classList.toggle('opacity-50', disabled);
        }
    }

    function renderManagedStudentCard(student, index, editable) {
        const displayIndex = index + 1;
        const memberKey = ensureMemberKey(student, 'student');
        const previewId = `student-manage-${memberKey}-preview`;
        const placeholderId = `student-manage-${memberKey}-placeholder`;
        const statusId = `student-manage-${memberKey}-status`;
        const photoUrl = getManagedMemberPreviewUrl(memberKey, getMemberPhotoUrl(student));
        const removeButton = editable
            ? `<button type="button" class="text-[11px] text-red-500 hover:text-red-600" onclick="removeManagedMember('student', ${index})">ลบนักเรียนคนนี้</button>`
            : '';
        return `
            <div class="rounded-lg border border-slate-200 bg-white p-3 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                    <input type="text"
                        list="student-prefix-options"
                        class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="คำนำหน้า"
                        value="${escapeHtmlClient(student.prefix || '')}"
                        ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('student', ${index}, 'prefix', this.value)">
                    <input type="text" class="rounded-lg border border-slate-200 px-2 py-1 focus:outline-none focus:ring-1 focus:ring-sky-500"
                        placeholder="ชื่อนักเรียน" value="${escapeHtmlClient(student.name || '')}" ${editable ? '' : 'disabled'}
                        oninput="updateManagedMember('student', ${index}, 'name', this.value)">
                    ${buildClassLevelControlHtml('student', displayIndex, student.class || '', { scope: 'manage', disabled: !editable, managedIndex: index })}
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                        ${photoUrl ? `<img id="${previewId}" src="${photoUrl}" alt="Student ${displayIndex}" class="w-full h-full object-cover">`
                            : `<img id="${previewId}" alt="Student ${displayIndex}" class="hidden w-full h-full object-cover">
                               <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>`}
                        ${photoUrl ? `<span id="${placeholderId}" class="hidden"></span>` : ''}
                    </div>
                    <div class="flex-1 space-y-1">
                        <input type="file"
                            data-member-photo="true"
                            data-member-type="student"
                            data-member-index="${displayIndex}"
                            data-photo-scope="manage"
                            data-member-key="${memberKey}"
                            data-preview-target="${previewId}"
                            data-placeholder-target="${placeholderId}"
                            data-status-target="${statusId}"
                            class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-sky-100 file:text-sky-700 hover:file:bg-sky-200"
                            accept="image/png,image/jpeg"
                            ${editable ? '' : 'disabled'}>
                        <p id="${statusId}" class="text-[11px] text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)">
                            ${photoUrl ? 'ใช้รูปเดิมอยู่' : 'อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)'}
                        </p>
                    </div>
                </div>
                ${removeButton}
            </div>
        `;
    }

    function resolveMemberCollectionKey(type) {
        if (!type) return '';
        const normalized = type.toString().toLowerCase();
        if (normalized === 'teacher' || normalized === 'teachers') return 'teachers';
        if (normalized === 'student' || normalized === 'students') return 'students';
        return normalized;
    }

    function addManagedMember(type) {
        if (!teamManageEditable) return;
        const key = resolveMemberCollectionKey(type);
        if (!managedTeamMembers[key]) return;
        const limit = getManagedMemberLimit(key);
        if (limit && managedTeamMembers[key].length >= limit) {
            if (teamManageFeedback) {
                teamManageFeedback.textContent = `จำนวน${key === 'teachers' ? 'ครู' : 'นักเรียน'}ครบตามเงื่อนไขแล้ว`;
            }
            return;
        }
        const template = key === 'teachers'
            ? { prefix: '', name: '', phone: '', role: '', class: '' }
            : { prefix: '', name: '', class: '', role: '' };
        ensureMemberKey(template, key === 'teachers' ? 'teacher' : 'student');
        managedTeamMembers[key].push(template);
        renderTeamManageMembers();
    }

    function updateManagedMember(type, index, field, value) {
        const key = resolveMemberCollectionKey(type);
        if (!managedTeamMembers[key] || !managedTeamMembers[key][index]) return;
        managedTeamMembers[key][index][field] = value;
    }

    function removeManagedMember(type, index) {
        if (!teamManageEditable) return;
        const key = resolveMemberCollectionKey(type);
        if (!managedTeamMembers[key]) return;
        const removed = managedTeamMembers[key][index];
        if (removed && removed._key) {
            delete TEAM_MANAGE_MEMBER_PHOTO_DATA[removed._key];
        }
        managedTeamMembers[key].splice(index, 1);
        renderTeamManageMembers();
    }

    function setTeamManageBusyState(isBusy) {
        if (teamManageSaveButton) {
            teamManageSaveButton.disabled = isBusy || !teamManageEditable;
            teamManageSaveButton.classList.toggle('opacity-60', isBusy || !teamManageEditable);
        }
        if (teamManageDeleteButton) {
            teamManageDeleteButton.disabled = isBusy || !teamManageEditable;
            teamManageDeleteButton.classList.toggle('opacity-60', isBusy || !teamManageEditable);
        }
        if (teamAddTeacherBtn) teamAddTeacherBtn.disabled = isBusy || !teamManageEditable;
        if (teamAddStudentBtn) teamAddStudentBtn.disabled = isBusy || !teamManageEditable;
        if (teamManageLogoInput) teamManageLogoInput.disabled = isBusy || !teamManageImageEditable;
        if (teamManagePhotoInput) teamManagePhotoInput.disabled = isBusy || !teamManageImageEditable;
        if (teamManageLoadingOverlay) {
            teamManageLoadingOverlay.classList.toggle('hidden', !isBusy);
        }
        if (teamManagePanel) {
            const memberInputs = teamManagePanel.querySelectorAll('input[data-member-photo="true"][data-photo-scope="manage"]');
            memberInputs.forEach(input => {
                input.disabled = isBusy || !teamManageEditable;
            });
        }
    }

    function buildManagedMemberPayload() {
        const teachers = managedTeamMembers.teachers.map((member, index) => {
            const key = ensureMemberKey(member, 'teacher');
            const entry = {
                prefix: (member.prefix || '').trim(),
                name: (member.name || '').trim(),
                phone: (member.phone || '').trim(),
                role: member.role || '',
                class: (member.class || '').trim()
            };
            if (member.photoDriveId) {
                entry.photoDriveId = member.photoDriveId;
            }
            const photo = TEAM_MANAGE_MEMBER_PHOTO_DATA[key];
            if (photo) entry.photoFileData = photo;
            return entry;
        });
        const students = managedTeamMembers.students.map((member, index) => {
            const key = ensureMemberKey(member, 'student');
            const entry = {
                prefix: (member.prefix || '').trim(),
                name: (member.name || '').trim(),
                class: (member.class || '').trim(),
                role: member.role || ''
            };
            if (member.photoDriveId) {
                entry.photoDriveId = member.photoDriveId;
            }
            const photo = TEAM_MANAGE_MEMBER_PHOTO_DATA[key];
            if (photo) entry.photoFileData = photo;
            return entry;
        });
        return { teachers, students };
    }

    function handleManagedClassLevelValue(type, displayIndex, memberIndex) {
        if (memberIndex === undefined || memberIndex === null) return;
        const numericIndex = Number(memberIndex);
        if (Number.isNaN(numericIndex)) return;
        const value = getSelectedClassLevelValue(type, displayIndex, 'manage');
        updateManagedMember(type, numericIndex, 'class', value);
    }

    function saveManagedTeam() {
        if (!activeManagedTeam || !teamManageEditable) return;
        const actorPayload = buildActorPayload();
        if (!actorPayload) {
            if (teamManageFeedback) {
                teamManageFeedback.textContent = 'กรุณาเข้าสู่ระบบก่อนบันทึก';
            }
            return;
        }
        const payload = {
            teamId: activeManagedTeam.teamId,
            teamName: (teamManageNameInput?.value || activeManagedTeam.teamName || '').trim(),
            contact: {
                name: (teamManageContactNameInput?.value || '').trim(),
                phone: (teamManageContactPhoneInput?.value || '').trim(),
                email: (teamManageContactEmailInput?.value || '').trim()
            },
            members: buildManagedMemberPayload(),
            actor: actorPayload
        };
        if (teamManageStatusEditable && teamManageStatusSelect) {
            const nextStatus = (teamManageStatusSelect.value || activeManagedTeam.status || 'Pending').trim();
            if (nextStatus) {
                payload.status = nextStatus;
            }
        }
        if (teamManageImageEditable) {
            if (teamManageLogoFileData) {
                payload.logoFileData = teamManageLogoFileData;
            }
            if (teamManagePhotoFileData) {
                payload.teamPhotoFileData = teamManagePhotoFileData;
            }
        }
        setTeamManageBusyState(true);
        if (teamManageFeedback) teamManageFeedback.textContent = 'กำลังบันทึก...';
        google.script.run
            .withSuccessHandler(response => {
                setTeamManageBusyState(false);
                if (response && response.success) {
                    if (teamManageFeedback) teamManageFeedback.textContent = 'บันทึกสำเร็จ';
                    loadRegisteredTeams(true);
                    closeTeamManager();
                } else if (teamManageFeedback) {
                    teamManageFeedback.textContent = (response && response.error) || 'บันทึกไม่สำเร็จ';
                }
            })
            .withFailureHandler(error => {
                setTeamManageBusyState(false);
                if (teamManageFeedback) teamManageFeedback.textContent = error.message || 'บันทึกไม่สำเร็จ';
            })
            .updateTeamMembers(payload);
    }

    function deleteActiveTeam() {
        if (!activeManagedTeam || !teamManageEditable) return;
        Swal.fire({
            icon: 'warning',
            title: 'ลบทีมนี้หรือไม่?',
            text: `ทีม ${activeManagedTeam.teamId} จะถูกลบถาวร`,
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonText: 'ยกเลิก',
            confirmButtonText: 'ลบทีม'
        }).then(result => {
            if (!result.isConfirmed) return;
            const actorPayload = buildActorPayload();
            if (!actorPayload) {
                if (teamManageFeedback) teamManageFeedback.textContent = 'กรุณาเข้าสู่ระบบก่อนลบทีม';
                return;
            }
            setTeamManageBusyState(true);
            if (teamManageFeedback) teamManageFeedback.textContent = 'กำลังลบทีม...';
            google.script.run
                .withSuccessHandler(response => {
                    setTeamManageBusyState(false);
                    if (response && response.success) {
                        Swal.fire({ icon: 'success', title: 'ลบทีมแล้ว', timer: 1600, showConfirmButton: false });
                        loadRegisteredTeams(true);
                        closeTeamManager();
                    } else if (teamManageFeedback) {
                        teamManageFeedback.textContent = (response && response.error) || 'ลบทีมไม่สำเร็จ';
                    }
                })
                .withFailureHandler(error => {
                    setTeamManageBusyState(false);
                    if (teamManageFeedback) teamManageFeedback.textContent = error.message || 'ลบทีมไม่สำเร็จ';
                })
                .deleteTeam({ teamId: activeManagedTeam.teamId, actor: actorPayload });
        });
    }

    // --- School options ---
    function getRegistrationSchoolList(schools) {
        if (!Array.isArray(schools)) return [];
        const level = getCurrentUserLevel();
        if (['admin', 'area'].includes(level)) {
            return schools;
        }
        const clusterFilter = getUserClusterForFilter();
        if (level === 'group_admin' && clusterFilter) {
            return schools.filter(school => normalizeText(school.clusterId) === clusterFilter || normalizeText(school.cluster) === clusterFilter);
        }
        const userSchoolId = normalizeText(currentUser?.schoolId || currentUser?.SchoolID || '');
        if (level === 'school_admin' && userSchoolId) {
            return schools.filter(school => normalizeText(school.id) === userSchoolId);
        }
        if (userSchoolId) {
            return schools.filter(school => normalizeText(school.id) === userSchoolId);
        }
        return schools;
    }

    function extractSchoolIdentifiers(value) {
        const raw = (value || '').toString().trim();
        if (!raw) return { id: '', name: '' };
        const idMatch = raw.match(/\[([^\]]+)\]/);
        const id = idMatch ? idMatch[1].trim() : '';
        const name = idMatch ? raw.replace(idMatch[0], '').trim() : raw;
        return { id, name };
    }

    function isSchoolAllowedForCurrentUser(schoolName) {
        if (!currentUser) return true;
        const level = getCurrentUserLevel();
        if (['admin', 'area'].includes(level)) return true;
        const allowedSchools = getRegistrationSchoolList(SCHOOL_OPTIONS);
        if (!allowedSchools.length) return true;
        const identifiers = extractSchoolIdentifiers(schoolName);
        const normalizedInputName = normalizeText(identifiers.name || schoolName);
        const normalizedInputId = normalizeText(identifiers.id);
        return allowedSchools.some(school => {
            const nameMatch = normalizeText(school.name) === normalizedInputName;
            const idMatch = normalizedInputId && normalizeText(school.id) === normalizedInputId;
            return nameMatch || idMatch;
        });
    }

    function applySchoolOptions(schools) {
        SCHOOL_LOOKUP_BY_NAME = new Map();
        SCHOOL_LOOKUP_BY_ID = new Map();
        if (Array.isArray(schools)) {
            schools.forEach(school => {
                const nameKey = normalizeText(school?.name);
                if (nameKey) {
                    SCHOOL_LOOKUP_BY_NAME.set(nameKey, school);
                }
                const idKey = normalizeText(school?.id);
                if (idKey) {
                    SCHOOL_LOOKUP_BY_ID.set(idKey, school);
                }
            });
        }
        updateSchoolClusterLookup(schools);
        if (schoolOptionsList) {
            schoolOptionsList.innerHTML = '';
            const registrationSchools = getRegistrationSchoolList(schools);
            registrationSchools.forEach(school => {
                if (!school || !school.name) return;
                const option = document.createElement('option');
                option.value = school.name;
                const parts = [];
                if (school.id) parts.push(`[${school.id}]`);
                parts.push(school.name);
                const clusterLabel = school.clusterName || school.cluster;
                if (clusterLabel) parts.push(`(${clusterLabel})`);
                option.label = parts.join(' ');
                option.dataset.schoolId = school.id || '';
                option.dataset.schoolCluster = school.clusterId || school.cluster || '';
                option.dataset.schoolClusterName = clusterLabel || '';
                schoolOptionsList.appendChild(option);
            });
        }
        const hasSchools = Array.isArray(schools) && schools.length > 0;
        populateSchoolSelectElement(authSchoolSelect, hasSchools ? schools : [], {
            placeholderText: hasSchools ? '-- เลือกโรงเรียน --' : '-- ไม่พบข้อมูลโรงเรียน --'
        });
        applyUserSchoolToForm();
        const ensureProfileValue = currentUser?.schoolId || currentUser?.SchoolID || '';
        populateSchoolSelectElement(profileSchoolSelect, schools, {
            placeholderText: '-- เลือกโรงเรียน --',
            ensureValue: ensureProfileValue
        });
        populateSchoolSelectElement(navSignupSchoolSelect, schools, {
            placeholderText: '-- เลือกโรงเรียน --'
        });
        refreshUserFormSchoolOptions();
        updateProfileSection();
        if (Array.isArray(ALL_TEAMS) && ALL_TEAMS.length > 0) {
            renderTeamTable(ALL_TEAMS);
            populateUploadTeamSelect(ALL_TEAMS);
        }
    }

    function loadSchoolOptions(force = false) {
        if (!schoolOptionsList && !authSchoolSelect && !profileSchoolSelect) return;
        const now = Date.now();
        if (!force && SCHOOL_OPTIONS.length > 0 && (now - lastSchoolFetch) < SCHOOL_FETCH_COOLDOWN_MS) {
            applySchoolOptions(SCHOOL_OPTIONS);
            return;
        }
        if (isLoadingSchools) return;
        isLoadingSchools = true;
        google.script.run
            .withSuccessHandler(schools => {
                isLoadingSchools = false;
                if (schools && !schools.error && Array.isArray(schools)) {
                    SCHOOL_OPTIONS = schools;
                    lastSchoolFetch = Date.now();
                    applySchoolOptions(SCHOOL_OPTIONS);
                }
            })
            .withFailureHandler(error => {
                isLoadingSchools = false;
                console.error('โหลดรายชื่อโรงเรียนผิดพลาด', error);
            })
            .getSchoolList();
    }

    // --- Navigation & steps ---
    function navigateTo(sectionId, clickedItem = null) {
        closeProfileMenu();
        sections.forEach(s => s.classList.remove('active'));
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
            targetSection.classList.add('active');
            window.scrollTo(0, 0);
        }
        navItems.forEach(i => i.classList.remove('active'));
        if (clickedItem) {
            clickedItem.classList.add('active');
        } else {
            const match = document.querySelector(`.nav-item[onclick*="'${sectionId}'"]`);
            if (match) match.classList.add('active');
        }
        if (sectionId === 'section-teams' && ALL_TEAMS.length === 0) loadRegisteredTeams();
        if (sectionId === 'section-report') {
            loadReportData();
            updateReportManagementVisibility();
            if (canViewUserManagement()) loadUserManagementData();
            if (canViewSchoolManagement()) loadSchoolManagementData();
        }
        if (sectionId === 'section-admin') loadFilesForReview();
    }

    function nextStep(stepNumber) {
        if (!requireLoginForRegistration()) return;
        const current = CURRENT_STEP;
        if (!validateStep(current)) return;
        CURRENT_STEP = stepNumber;
        updateFormStepUI();
    }
    function prevStep(stepNumber) {
        CURRENT_STEP = stepNumber;
        updateFormStepUI();
    }
    function updateFormStepUI() {
        formSteps.forEach((step, index) => {
            step.classList.toggle('active', (index + 1) === CURRENT_STEP);
        });
        stepIndicators.forEach((indicator, index) => {
            const circle = indicator.querySelector('div');
            const label = indicator.querySelector('p');
            if ((index + 1) < CURRENT_STEP) {
                circle.classList.add('bg-green-500', 'text-white');
                circle.classList.remove('bg-slate-300', 'text-slate-600', 'bg-sky-500');
                label.classList.add('text-green-600');
                label.classList.remove('text-slate-500', 'text-sky-600');
            } else if ((index + 1) === CURRENT_STEP) {
                circle.classList.add('bg-sky-500', 'text-white');
                circle.classList.remove('bg-slate-300', 'text-slate-600', 'bg-green-500');
                label.classList.add('text-sky-600');
                label.classList.remove('text-slate-500', 'text-green-600');
            } else {
                circle.classList.add('bg-slate-300', 'text-slate-600');
                circle.classList.remove('bg-sky-500', 'bg-green-500', 'text-white');
                label.classList.add('text-slate-500');
                label.classList.remove('text-sky-600', 'text-green-600');
            }
        });
        if (CURRENT_STEP === 2) {
            applyUserContactToForm();
        }
    }

    // --- Data loading ---
    function loadInitialData(force = false) {
        const now = Date.now();
        if (isLoadingActivities) return;
        if (!force && lastActivitiesFetch && (now - lastActivitiesFetch) < FETCH_COOLDOWN_MS) {
            updateHomeActivities();
            return;
        }
        isLoadingActivities = true;
        showLoading();
        google.script.run
            .withSuccessHandler(activities => {
                lastActivitiesFetch = Date.now();
                isLoadingActivities = false;
                onActivitiesLoaded(activities);
            })
            .withFailureHandler(error => {
                isLoadingActivities = false;
                handleError(error);
            })
            .getActivities();

        google.script.run
            .withSuccessHandler(isAdmin => {
                isAppAdmin = Boolean(isAdmin);
                refreshProfileMenuState();
            })
            .withFailureHandler(err => console.error("Admin check failed:", err))
            .isAdmin();
    }

    function onActivitiesLoaded(activities) {
        hideLoading();
        if (activities.error) {
            activityLoading.innerText = 'เกิดข้อผิดพลาด: ' + activities.error;
            return;
        }
        const previousActivityId = activitySelect.value;
        ALL_ACTIVITIES = activities;
        renderGroupedActivityCards(activities);
        populateActivityFilters(activities);
        const categories = getAllCategories(activities);
        renderHomeCategoryFilter(categories);
        populateFormCategorySelect(categories);
        populateFormActivitySelect(getFormActivities());
        updateHomeActivities({ resetVisibleCount: true });

        if (previousActivityId) {
            const selectedActivity = ALL_ACTIVITIES.find(a => a.id === previousActivityId);
            if (selectedActivity && !isActivityClosed(selectedActivity)) {
                activitySelect.value = previousActivityId;
                updateFormBasedOnActivity(previousActivityId);
            } else {
                activitySelect.value = '';
                updateFormBasedOnActivity('');
            }
        } else {
            updateFormBasedOnActivity('');
        }
        updateActivityView();
    }

    function loadRegisteredTeams(force = false) {
        const now = Date.now();
        if (isLoadingTeams) return;
        if (!force && lastTeamsFetch && (now - lastTeamsFetch) < FETCH_COOLDOWN_MS && ALL_TEAMS.length > 0) {
            renderTeamTable(ALL_TEAMS);
            return;
        }
        isLoadingTeams = true;
        renderTeamTableSkeleton();
        if (currentUser) {
            showProfileTeamsLoadingState();
        }
        showLoading();
        google.script.run
            .withSuccessHandler(teams => {
                lastTeamsFetch = Date.now();
                isLoadingTeams = false;
                onTeamsLoaded(teams);
            })
            .withFailureHandler(error => {
                isLoadingTeams = false;
                handleError(error);
            })
            .getRegisteredTeams();
    }

    function onTeamsLoaded(teams) {
        hideLoading();
        if (teams.error) {
            teamTableBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-red-500">เกิดข้อผิดพลาด: ${teams.error}</td></tr>`;
            return;
        }
        ALL_TEAMS = teams;
        renderTeamTable(teams);
        populateUploadTeamSelect(teams);
        refreshActivityTeamCounts();
        updateProfileSection();
    }

    function populateUploadTeamSelect(teams) {
        if (!uploadTeamIdSelect) return;
        const userId = getCurrentUserId();
        if (!userId) {
            uploadTeamIdSelect.innerHTML = '<option value="">-- กรุณาเข้าสู่ระบบเพื่อเลือกทีม --</option>';
            return;
        }
        const userTeams = filterTeamsForCurrentUser(teams);
        if (!userTeams.length) {
            uploadTeamIdSelect.innerHTML = '<option value="">-- ไม่มีทีมในสิทธิ์ของคุณ --</option>';
            return;
        }
        uploadTeamIdSelect.innerHTML = '<option value="">-- กรุณาเลือกรหัสทีม --</option>';
        userTeams.forEach(team => {
            const activityObj = ALL_ACTIVITIES.find(a => a.id === team.activity);
            const activityName = activityObj ? activityObj.name : team.activity;
            uploadTeamIdSelect.innerHTML += `<option value="${team.teamId}">${team.teamId} - ${activityName} (${team.teamName || 'N/A'})</option>`;
        });
    }

    function loadReportData(force = false) {
        const now = Date.now();
        if (!force && cachedReport && lastReportFetch && (now - lastReportFetch) < FETCH_COOLDOWN_MS) {
            onReportLoaded(cachedReport);
            return;
        }
        if (isLoadingReport) return;

        isLoadingReport = true;
        reportTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-500">กำลังโหลดข้อมูลรายงาน...</td></tr>';
        document.getElementById('report-total-teams').innerText = '...';
        document.getElementById('report-total-teachers').innerText = '...';
        document.getElementById('report-total-students').innerText = '...';
        document.getElementById('report-total-all').innerText = '...';

        showLoading();
        const actorPayload = buildActorPayload();
        google.script.run
            .withSuccessHandler(report => {
                isLoadingReport = false;
                if (report && !report.error) {
                    cachedReport = report;
                    lastReportFetch = Date.now();
                } else {
                    cachedReport = null;
                }
                onReportLoaded(report);
            })
            .withFailureHandler(error => {
                isLoadingReport = false;
                handleError(error);
            })
            .getReportData({ actor: actorPayload });
    }

    function onReportLoaded(report) {
        hideLoading();
        if (report.error) {
            reportTableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">เกิดข้อผิดพลาด: ${report.error}</td></tr>`;
            return;
        }
        document.getElementById('report-total-teams').innerText = report.totals.teams;
        document.getElementById('report-total-teachers').innerText = report.totals.teachers;
        document.getElementById('report-total-students').innerText = report.totals.students;
        document.getElementById('report-total-all').innerText = report.totals.allMembers;

        const activityCategoryMap = new Map();
        ALL_ACTIVITIES.forEach(a => {
            if (a && a.name) activityCategoryMap.set(a.name, a.category || 'ไม่ระบุหมวดหมู่');
        });

        const groupedSummary = {};
        for (const activityName in report.summary) {
            const data = report.summary[activityName];
            const category = activityCategoryMap.get(activityName) || 'ไม่ระบุหมวดหมู่';
            if (!groupedSummary[category]) groupedSummary[category] = [];
            groupedSummary[category].push({
                activityName,
                teams: data.teams,
                teachers: data.teachers,
                students: data.students
            });
        }

        const sortedCategories = Object.keys(groupedSummary).sort((a, b) => a.localeCompare(b, 'th'));
        let html = '';
        sortedCategories.forEach((category, index) => {
            const items = groupedSummary[category].sort((a, b) => a.activityName.localeCompare(b.activityName, 'th'));
            const categoryTotals = items.reduce((acc, item) => {
                acc.teams += item.teams;
                acc.teachers += item.teachers;
                acc.students += item.students;
                return acc;
            }, { teams: 0, teachers: 0, students: 0 });
            const categoryId = `report-accordion-${index}`;
            html += `
                <tr class="bg-slate-100 cursor-pointer" data-report-toggle="${categoryId}" tabindex="0" role="button">
                    <td class="p-3 text-sm font-semibold text-slate-700 flex items-center gap-2">
                        <span class="material-symbols-outlined text-base transition-transform duration-200">expand_more</span>
                        ${escapeHtmlClient(category)}
                    </td>
                    <td class="p-3 text-sm text-slate-600 font-semibold">${categoryTotals.teams}</td>
                    <td class="p-3 text-sm text-slate-600 font-semibold">${categoryTotals.teachers}</td>
                    <td class="p-3 text-sm text-slate-600 font-semibold">${categoryTotals.students}</td>
                    <td class="p-3 text-sm text-slate-600 font-semibold">${categoryTotals.teachers + categoryTotals.students}</td>
                </tr>
                <tr data-report-panel="${categoryId}" class="hidden">
                    <td colspan="5" class="p-0">
                        <div class="divide-y divide-slate-100 bg-white">
                            ${items.map(item => {
                                const totalMembers = item.teachers + item.students;
                                return `
                                    <div class="grid grid-cols-5 gap-2 px-3 py-2 text-xs text-slate-600">
                                        <div class="col-span-2 font-medium text-slate-700">${escapeHtmlClient(item.activityName)}</div>
                                        <div>${item.teams} ทีม</div>
                                        <div>ครู ${item.teachers}</div>
                                        <div>นร. ${item.students} (รวม ${totalMembers})</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </td>
                </tr>
            `;
        });
        reportTableBody.innerHTML = html || '<tr><td colspan="5" class="p-4 text-center text-slate-500">ไม่พบข้อมูล</td></tr>';
        const toggles = reportTableBody.querySelectorAll('[data-report-toggle]');
        toggles.forEach(toggle => {
            const handleToggle = () => {
                const id = toggle.dataset.reportToggle;
                const panel = reportTableBody.querySelector(`[data-report-panel="${id}"]`);
                const icon = toggle.querySelector('.material-symbols-outlined');
                if (panel) {
                    panel.classList.toggle('hidden');
                    if (icon) {
                        icon.classList.toggle('rotate-180');
                    }
                }
            };
            toggle.addEventListener('click', handleToggle);
            toggle.addEventListener('keydown', event => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    handleToggle();
                }
            });
        });
    }

    function canViewUserManagement() {
        const level = getCurrentUserLevel();
        return currentUser && ['admin', 'area', 'group_admin', 'school_admin'].includes(level);
    }

    function canViewSchoolManagement() {
        return canViewUserManagement();
    }

    function canEditActivities() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function canManageUsersClient() {
        return canViewUserManagement();
    }

    function canEditSchoolCluster() {
        const level = getCurrentUserLevel();
        return level === 'admin' || level === 'area';
    }

    function getAssignableSchoolsForUserForm() {
        if (Array.isArray(MANAGED_SCHOOLS) && MANAGED_SCHOOLS.length) {
            return MANAGED_SCHOOLS;
        }
        if (Array.isArray(SCHOOL_OPTIONS) && SCHOOL_OPTIONS.length) {
            return SCHOOL_OPTIONS;
        }
        return [];
    }

    function refreshUserFormSchoolOptions() {
        if (!userFormSchoolSelect) return;
        const schools = getAssignableSchoolsForUserForm();
        populateSchoolSelectElement(userFormSchoolSelect, schools, {
            placeholderText: schools.length ? '-- เลือกโรงเรียน --' : '-- ไม่พบข้อมูลโรงเรียน --'
        });
    }

    function updateUserManagementControls() {
        const canManage = Boolean(currentUser) && canManageUsersClient();
        if (userManagementActions) {
            userManagementActions.classList.toggle('hidden', !canManage);
        }
        if (!canManage) {
            hideUserManagementForm();
        }
    }

    function updateUserFormLevelOptions(selectedLevel = 'User') {
        if (!userFormLevel) return;
        const level = getCurrentUserLevel();
        const allowedMap = {
            admin: ['User', 'School_Admin', 'Group_Admin', 'Score', 'Area', 'Admin'],
            area: ['User', 'School_Admin', 'Group_Admin', 'Score', 'Area'],
            group_admin: ['User', 'School_Admin'],
            school_admin: ['User']
        };
        const allowed = allowedMap[level] || ['User'];
        Array.from(userFormLevel.options).forEach(option => {
            const value = option.value || option.text;
            option.disabled = !allowed.includes(value);
        });
        if (allowed.includes(selectedLevel)) {
            userFormLevel.value = selectedLevel;
        } else {
            userFormLevel.value = allowed[0] || 'User';
        }
    }

    function updateReportManagementVisibility() {
        if (!reportManagementWrapper) return;
        const shouldShow = Boolean(currentUser) && (canViewUserManagement() || canViewSchoolManagement());
        reportManagementWrapper.classList.toggle('hidden', !shouldShow);
        updateUserManagementControls();
        if (!shouldShow) {
            if (userManagementStatus) userManagementStatus.textContent = 'เฉพาะผู้ใช้ที่มีสิทธิ์';
            if (userManagementContent) userManagementContent.innerHTML = '';
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'เฉพาะผู้ใช้ที่มีสิทธิ์';
            if (schoolManagementContent) schoolManagementContent.innerHTML = '';
        }
    }

    function loadUserManagementData(force = false) {
        if (!canViewUserManagement()) {
            MANAGED_USERS = [];
            renderUserManagement([]);
            return;
        }
        if (isLoadingManagedUsers && !force) return;
        const actor = buildActorPayload();
        if (!actor) {
            if (userManagementStatus) userManagementStatus.textContent = 'กรุณาเข้าสู่ระบบ';
            return;
        }
        isLoadingManagedUsers = true;
        if (userManagementStatus) userManagementStatus.textContent = 'กำลังโหลดข้อมูลผู้ใช้...';
        userManagementContent && (userManagementContent.innerHTML = '');
        google.script.run
            .withSuccessHandler(res => {
                isLoadingManagedUsers = false;
                if (res && res.success) {
                    MANAGED_USERS = Array.isArray(res.users) ? res.users : [];
                    renderUserManagement(MANAGED_USERS);
                } else {
                    if (userManagementStatus) userManagementStatus.textContent = (res && res.error) || 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้';
                }
            })
            .withFailureHandler(error => {
                isLoadingManagedUsers = false;
                if (userManagementStatus) userManagementStatus.textContent = error.message || 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้';
            })
            .getManagedUsers({ actor });
    }

    function renderUserTableRows(users, { showActions = false } = {}) {
        return users.map(user => {
            const actionCell = showActions ? renderManagedUserActionsCell(user) : '';
            const fullName = `${user.name || ''} ${user.surname || ''}`.trim() || '-';
            return `
                <tr class="border-b last:border-0">
                    <td class="p-2 text-slate-700 font-semibold">${escapeHtmlClient(user.username || '-')}</td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(fullName)}</td>
                    <td class="p-2">
                        <span class="inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-xs font-semibold text-slate-600">
                            ${escapeHtmlClient(getRoleDisplayName(user.level))}
                        </span>
                    </td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(user.schoolName || '-')}</td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(user.cluster || '-')}</td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(user.tel || '-')}</td>
                    <td class="p-2 text-slate-600">${escapeHtmlClient(user.email || '-')}</td>
                    ${actionCell}
                </tr>
            `;
        }).join('');
    }

    function renderManagedUserActionsCell(user) {
        const recordId = (user?.userId || user?.userid || '').toString();
        if (!recordId) {
            return '<td class="p-2 text-right text-xs text-slate-400">-</td>';
        }
        const safeId = escapeHtmlClient(recordId);
        const isSelf = normalizeText(recordId) === normalizeText(getCurrentUserId());
        const editButton = `
            <button type="button"
                class="text-sky-600 hover:text-sky-800"
                data-user-action="edit-user"
                data-user-id="${safeId}">
                แก้ไข
            </button>`;
        const deleteButton = isSelf ? '' : `
            <button type="button"
                class="text-red-500 hover:text-red-600"
                data-user-action="delete-user"
                data-user-id="${safeId}">
                ลบ
            </button>`;
        return `
            <td class="p-2 text-right">
                <div class="flex justify-end gap-2 text-xs font-semibold">
                    ${editButton}
                    ${deleteButton}
                </div>
            </td>
        `;
    }

    function renderUserManagement(users) {
        if (!userManagementContent) return;
        if (!canViewUserManagement()) {
            if (userManagementStatus) userManagementStatus.textContent = 'เฉพาะผู้ดูแลระบบเท่านั้นที่เข้าถึงได้';
            userManagementContent.innerHTML = '';
            return;
        }
        if (isLoadingManagedUsers) {
            userManagementContent.innerHTML = `
                <div class="animate-pulse space-y-2">
                    <div class="h-4 bg-slate-200 rounded w-1/3"></div>
                    <div class="h-3 bg-slate-100 rounded w-full"></div>
                    <div class="h-3 bg-slate-100 rounded w-2/3"></div>
                </div>
            `;
            return;
        }
        if (!Array.isArray(users) || users.length === 0) {
            if (userManagementStatus) userManagementStatus.textContent = 'ไม่พบผู้ใช้ในสิทธิ์ของคุณ';
            userManagementContent.innerHTML = '<p class="text-slate-500 text-sm">ไม่มีข้อมูลผู้ใช้ให้แสดง</p>';
            return;
        }
        const level = getCurrentUserLevel();
        const showActions = canManageUsersClient();
        const actionHeader = showActions ? '<th class="p-2 text-left w-24">จัดการ</th>' : '';
        if (['admin', 'area'].includes(level)) {
            const groups = new Map();
            users.forEach(user => {
                const clusterLabel = user.cluster || 'ไม่ระบุเครือข่าย';
                if (!groups.has(clusterLabel)) groups.set(clusterLabel, []);
                groups.get(clusterLabel).push(user);
            });
            const html = Array.from(groups.entries()).map(([cluster, list]) => `
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <div class="px-3 py-2 bg-slate-50 text-sm font-semibold text-slate-700">เครือข่าย: ${escapeHtmlClient(cluster)}</div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm divide-y divide-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-2 text-left">ชื่อผู้ใช้</th>
                                    <th class="p-2 text-left">ชื่อ-สกุล</th>
                                    <th class="p-2 text-left">สิทธิ์</th>
                                    <th class="p-2 text-left">โรงเรียน</th>
                                    <th class="p-2 text-left">เครือข่าย</th>
                                    <th class="p-2 text-left">โทร</th>
                                    <th class="p-2 text-left">อีเมล</th>
                                    ${actionHeader}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${renderUserTableRows(list, { showActions })}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
            userManagementContent.innerHTML = html;
            if (userManagementStatus) userManagementStatus.textContent = `พบผู้ใช้ทั้งหมด ${users.length} คน (แยกตามเครือข่าย)`;
            return;
        }
        userManagementContent.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm divide-y divide-slate-200">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 text-left">ชื่อผู้ใช้</th>
                            <th class="p-2 text-left">ชื่อ-สกุล</th>
                            <th class="p-2 text-left">สิทธิ์</th>
                            <th class="p-2 text-left">โรงเรียน</th>
                            <th class="p-2 text-left">เครือข่าย</th>
                            <th class="p-2 text-left">โทร</th>
                            <th class="p-2 text-left">อีเมล</th>
                            ${actionHeader}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${renderUserTableRows(users, { showActions })}
                    </tbody>
                </table>
            </div>
        `;
        if (userManagementStatus) userManagementStatus.textContent = `พบผู้ใช้ทั้งหมด ${users.length} คน`;
    }

    function findManagedUserById(userId) {
        if (!userId || !Array.isArray(MANAGED_USERS)) return null;
        return MANAGED_USERS.find(user => (user.userId || '').toString() === userId.toString()) || null;
    }

    function openUserManagementForm(user = null) {
        if (!userManagementForm || !canManageUsersClient()) return;
        refreshUserFormSchoolOptions();
        userFormMode = user && (user.userId || user.userid) ? 'edit' : 'create';
        if (userFormTitle) {
            userFormTitle.textContent = userFormMode === 'edit'
                ? `แก้ไขผู้ใช้: ${user?.username || user?.userId || '-'}` : 'เพิ่มผู้ใช้ใหม่';
        }
        if (userFormUserId) userFormUserId.value = user?.userId || '';
        if (userFormUsername) userFormUsername.value = user?.username || '';
        if (userFormName) userFormName.value = user?.name || '';
        if (userFormSurname) userFormSurname.value = user?.surname || '';
        if (userFormEmail) userFormEmail.value = user?.email || '';
        if (userFormTel) userFormTel.value = user?.tel || '';
        if (userFormPassword) userFormPassword.value = '';
        if (userFormPasswordConfirm) userFormPasswordConfirm.value = '';
        const initialLevel = user?.level || 'User';
        updateUserFormLevelOptions(initialLevel);
        if (userFormSchoolSelect) {
            let targetSchoolId = user?.schoolId || '';
            if (!targetSchoolId && user?.schoolName) {
                const info = getSchoolInfoByName(user.schoolName);
                if (info?.id) targetSchoolId = info.id;
            }
            userFormSchoolSelect.value = targetSchoolId || '';
        }
        setUserFormSavingState(false);
        userManagementForm.classList.remove('hidden');
        if (typeof userManagementForm.scrollIntoView === 'function') {
            userManagementForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function resetUserManagementForm() {
        userFormMode = 'create';
        if (userManagementForm) userManagementForm.reset();
        if (userFormTitle) userFormTitle.textContent = 'เพิ่มผู้ใช้ใหม่';
        updateUserFormLevelOptions('User');
        setUserFormSavingState(false);
    }

    function hideUserManagementForm() {
        if (!userManagementForm) return;
        userManagementForm.classList.add('hidden');
        resetUserManagementForm();
    }

    function setUserFormSavingState(isSaving) {
        isSavingManagedUser = isSaving;
        if (userFormSubmitBtn) {
            userFormSubmitBtn.disabled = isSaving;
            userFormSubmitBtn.classList.toggle('opacity-60', isSaving);
        }
        if (userFormSubmitLabel) {
            userFormSubmitLabel.textContent = isSaving
                ? 'กำลังบันทึก...'
                : (userFormMode === 'edit' ? 'บันทึกการแก้ไข' : 'บันทึกผู้ใช้');
        }
    }

    function handleUserManagementFormSubmit(event) {
        event.preventDefault();
        if (isSavingManagedUser || !canManageUsersClient()) return;
        if (!userManagementForm || !userManagementForm.reportValidity()) {
            userManagementForm?.reportValidity();
            return;
        }
        const actor = buildActorPayload();
        if (!actor) {
            Swal.fire({ icon: 'error', title: 'ไม่พบข้อมูลผู้ใช้', text: 'กรุณาเข้าสู่ระบบอีกครั้ง' });
            return;
        }
        const password = (userFormPassword?.value || '').trim();
        const confirmPassword = (userFormPasswordConfirm?.value || '').trim();
        if ((password || confirmPassword) && password !== confirmPassword) {
            Swal.fire({ icon: 'warning', title: 'ยืนยันรหัสผ่านไม่ตรงกัน', text: 'กรุณาตรวจสอบรหัสผ่านอีกครั้ง' });
            return;
        }
        const schoolId = (userFormSchoolSelect?.value || '').trim();
        if (!schoolId) {
            Swal.fire({ icon: 'warning', title: 'กรุณาเลือกโรงเรียน', text: 'โปรดเลือกโรงเรียนสำหรับผู้ใช้นี้' });
            return;
        }
        const payload = {
            actor,
            user: {
                userId: (userFormUserId?.value || '').trim(),
                username: (userFormUsername?.value || '').trim(),
                level: userFormLevel?.value || 'User',
                name: (userFormName?.value || '').trim(),
                surname: (userFormSurname?.value || '').trim(),
                email: (userFormEmail?.value || '').trim(),
                tel: (userFormTel?.value || '').trim(),
                password,
                schoolId
            }
        };
        setUserFormSavingState(true);
        if (userManagementStatus) userManagementStatus.textContent = 'กำลังบันทึกข้อมูลผู้ใช้...';
        google.script.run
            .withSuccessHandler(res => {
                setUserFormSavingState(false);
                if (res && res.success) {
                    hideUserManagementForm();
                    if (userManagementStatus) userManagementStatus.textContent = 'บันทึกข้อมูลผู้ใช้สำเร็จ';
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1600, showConfirmButton: false });
                    loadUserManagementData(true);
                } else {
                    const message = (res && res.error) || 'ไม่สามารถบันทึกข้อมูลผู้ใช้ได้';
                    if (userManagementStatus) userManagementStatus.textContent = message;
                    Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
                }
            })
            .withFailureHandler(error => {
                setUserFormSavingState(false);
                const message = error.message || 'ไม่สามารถบันทึกข้อมูลผู้ใช้ได้';
                if (userManagementStatus) userManagementStatus.textContent = message;
                Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: message });
            })
            .saveManagedUser(payload);
    }

    function handleManagedUserEdit(userId) {
        const user = findManagedUserById(userId);
        if (!user) {
            Swal.fire({ icon: 'error', title: 'ไม่พบผู้ใช้', text: 'ไม่สามารถแก้ไขผู้ใช้นี้ได้' });
            return;
        }
        openUserManagementForm(user);
    }

    function handleManagedUserDelete(userId) {
        const user = findManagedUserById(userId);
        if (!user) {
            Swal.fire({ icon: 'error', title: 'ไม่พบผู้ใช้', text: 'ไม่สามารถลบผู้ใช้นี้ได้' });
            return;
        }
        Swal.fire({
            icon: 'warning',
            title: `ลบผู้ใช้ ${user.username || userId}?`,
            text: 'การลบไม่สามารถย้อนกลับได้',
            showCancelButton: true,
            confirmButtonText: 'ลบผู้ใช้',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#dc2626'
        }).then(result => {
            if (!result.isConfirmed) return;
            const actor = buildActorPayload();
            if (!actor) {
                Swal.fire({ icon: 'error', title: 'ไม่สามารถดำเนินการได้', text: 'กรุณาเข้าสู่ระบบอีกครั้ง' });
                return;
            }
            if (userManagementStatus) userManagementStatus.textContent = `กำลังลบผู้ใช้ ${user.username || userId}...`;
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.success) {
                        Swal.fire({ icon: 'success', title: 'ลบผู้ใช้แล้ว', timer: 1500, showConfirmButton: false });
                        loadUserManagementData(true);
                    } else {
                        const message = (res && res.error) || 'ไม่สามารถลบผู้ใช้ได้';
                        if (userManagementStatus) userManagementStatus.textContent = message;
                        Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: message });
                    }
                })
                .withFailureHandler(error => {
                    const message = error.message || 'ไม่สามารถลบผู้ใช้ได้';
                    if (userManagementStatus) userManagementStatus.textContent = message;
                    Swal.fire({ icon: 'error', title: 'ลบไม่สำเร็จ', text: message });
                })
                .deleteManagedUser({ userId, actor });
        });
    }

    function handleUserManagementContentClick(event) {
        const actionEl = event.target.closest('[data-user-action]');
        if (!actionEl) return;
        const action = actionEl.dataset.userAction;
        const userId = actionEl.dataset.userId;
        if (!userId) return;
        if (action === 'edit-user') {
            handleManagedUserEdit(userId);
        } else if (action === 'delete-user') {
            handleManagedUserDelete(userId);
        }
    }

    function loadSchoolManagementData(force = false) {
        if (!canViewSchoolManagement()) {
            MANAGED_SCHOOLS = [];
            renderSchoolManagement([]);
            refreshUserFormSchoolOptions();
            return;
        }
        if (isLoadingManagedSchools && !force) return;
        const actor = buildActorPayload();
        if (!actor) {
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'กรุณาเข้าสู่ระบบ';
            return;
        }
        isLoadingManagedSchools = true;
        if (schoolManagementStatus) schoolManagementStatus.textContent = 'กำลังโหลดข้อมูลโรงเรียน...';
        schoolManagementContent && (schoolManagementContent.innerHTML = '');
        google.script.run
            .withSuccessHandler(res => {
                isLoadingManagedSchools = false;
                if (res && res.success) {
                    MANAGED_SCHOOLS = Array.isArray(res.schools) ? res.schools : [];
                    refreshUserFormSchoolOptions();
                    renderSchoolManagement(MANAGED_SCHOOLS);
                } else {
                    if (schoolManagementStatus) schoolManagementStatus.textContent = (res && res.error) || 'ไม่สามารถโหลดข้อมูลโรงเรียนได้';
                }
            })
            .withFailureHandler(error => {
                isLoadingManagedSchools = false;
                if (schoolManagementStatus) schoolManagementStatus.textContent = error.message || 'ไม่สามารถโหลดข้อมูลโรงเรียนได้';
            })
            .getManagedSchools({ actor });
    }

    function renderSchoolManagement(schools) {
        if (!schoolManagementContent) return;
        if (!canViewSchoolManagement()) {
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'เฉพาะผู้ดูแลระบบเท่านั้นที่เข้าถึงได้';
            schoolManagementContent.innerHTML = '';
            return;
        }
        if (isLoadingManagedSchools) {
            schoolManagementContent.innerHTML = `
                <div class="animate-pulse space-y-2">
                    <div class="h-4 bg-slate-200 rounded w-1/4"></div>
                    <div class="h-3 bg-slate-100 rounded w-full"></div>
                </div>
            `;
            return;
        }
        if (!Array.isArray(schools) || schools.length === 0) {
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'ไม่พบโรงเรียนในสิทธิ์ของคุณ';
            schoolManagementContent.innerHTML = '<p class="text-slate-500 text-sm">ไม่มีข้อมูลโรงเรียนให้แสดง</p>';
            return;
        }
        const level = getCurrentUserLevel();
        const allowClusterEdit = canEditSchoolCluster();
        const actionHeader = allowClusterEdit ? '<th class="p-2 text-left w-28">จัดการ</th>' : '';
        if (['admin', 'area', 'group_admin'].includes(level)) {
            const groups = new Map();
            schools.forEach(school => {
                const cluster = school.cluster || 'ไม่ระบุเครือข่าย';
                if (!groups.has(cluster)) groups.set(cluster, []);
                groups.get(cluster).push(school);
            });
            const html = Array.from(groups.entries()).map(([cluster, list]) => `
                <div class="border border-slate-200 rounded-xl overflow-hidden">
                    <div class="px-3 py-2 bg-slate-50 text-sm font-semibold text-slate-700">เครือข่าย: ${escapeHtmlClient(cluster)}</div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm divide-y divide-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-2 text-left">รหัสโรงเรียน</th>
                                    <th class="p-2 text-left">ชื่อโรงเรียน</th>
                                    <th class="p-2 text-left">เครือข่าย</th>
                                    ${actionHeader}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${list.map(school => `
                                    <tr>
                                        <td class="p-2 text-slate-700 font-semibold">${escapeHtmlClient(school.id || '-')}</td>
                                        <td class="p-2 text-slate-600">${escapeHtmlClient(school.name || '-')}</td>
                                        <td class="p-2 text-slate-600">${escapeHtmlClient(school.cluster || '-')}</td>
                                        ${allowClusterEdit ? renderSchoolClusterActionCell(school) : ''}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `).join('');
            schoolManagementContent.innerHTML = html;
            if (schoolManagementStatus) schoolManagementStatus.textContent = `พบโรงเรียนทั้งหมด ${schools.length} แห่ง`;
            return;
        }
        schoolManagementContent.innerHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm divide-y divide-slate-200">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 text-left">รหัสโรงเรียน</th>
                            <th class="p-2 text-left">ชื่อโรงเรียน</th>
                            <th class="p-2 text-left">เครือข่าย</th>
                            ${actionHeader}
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${schools.map(school => `
                            <tr>
                                <td class="p-2 text-slate-700 font-semibold">${escapeHtmlClient(school.id || '-')}</td>
                                <td class="p-2 text-slate-600">${escapeHtmlClient(school.name || '-')}</td>
                                <td class="p-2 text-slate-600">${escapeHtmlClient(school.cluster || '-')}</td>
                                ${allowClusterEdit ? renderSchoolClusterActionCell(school) : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        if (schoolManagementStatus) schoolManagementStatus.textContent = `พบโรงเรียนทั้งหมด ${schools.length} แห่ง`;
    }

    function renderSchoolClusterActionCell(school) {
        const schoolId = (school?.id || '').toString();
        const safeId = escapeHtmlClient(schoolId);
        const safeCluster = escapeHtmlClient(school?.cluster || '');
        return `
            <td class="p-2 text-right">
                <button type="button"
                    class="text-xs text-sky-600 hover:text-sky-800"
                    data-school-action="edit-cluster"
                    data-school-id="${safeId}"
                    data-school-cluster="${safeCluster}">
                    เปลี่ยนเครือข่าย
                </button>
            </td>
        `;
    }

    function handleSchoolManagementContentClick(event) {
        const actionEl = event.target.closest('[data-school-action]');
        if (!actionEl) return;
        const action = actionEl.dataset.schoolAction;
        if (action !== 'edit-cluster') return;
        const schoolId = actionEl.dataset.schoolId;
        if (!schoolId) return;
        const currentCluster = actionEl.dataset.schoolCluster || '';
        promptSchoolClusterUpdate(schoolId, currentCluster);
    }

    function promptSchoolClusterUpdate(schoolId, currentCluster = '') {
        if (!canEditSchoolCluster() || !schoolId || isUpdatingSchoolCluster) return;
        Swal.fire({
            title: 'เปลี่ยนเครือข่ายโรงเรียน',
            input: 'text',
            inputLabel: 'ชื่อเครือข่ายใหม่',
            inputValue: currentCluster || '',
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก',
            inputPlaceholder: 'ตัวอย่าง: กลุ่มสาระ ICT'
        }).then(result => {
            if (!result.isConfirmed) return;
            const nextCluster = (result.value || '').trim();
            const actor = buildActorPayload();
            if (!actor) {
                Swal.fire({ icon: 'error', title: 'กรุณาเข้าสู่ระบบ', text: 'ไม่สามารถอัปเดตเครือข่ายได้' });
                return;
            }
            isUpdatingSchoolCluster = true;
            if (schoolManagementStatus) schoolManagementStatus.textContent = 'กำลังอัปเดตเครือข่าย...';
            google.script.run
                .withSuccessHandler(res => {
                    isUpdatingSchoolCluster = false;
                    if (res && res.success) {
                        Swal.fire({ icon: 'success', title: 'อัปเดตสำเร็จ', timer: 1500, showConfirmButton: false });
                        loadSchoolManagementData(true);
                        loadUserManagementData(true);
                    } else {
                        const message = (res && res.error) || 'ไม่สามารถอัปเดตเครือข่ายได้';
                        if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                        Swal.fire({ icon: 'error', title: 'อัปเดตไม่สำเร็จ', text: message });
                    }
                })
                .withFailureHandler(error => {
                    isUpdatingSchoolCluster = false;
                    const message = error.message || 'ไม่สามารถอัปเดตเครือข่ายได้';
                    if (schoolManagementStatus) schoolManagementStatus.textContent = message;
                    Swal.fire({ icon: 'error', title: 'อัปเดตไม่สำเร็จ', text: message });
                })
                .updateSchoolCluster({ schoolId, cluster: nextCluster, actor });
        });
    }

    function loadFilesForReview() {
        adminLoading.innerText = 'กำลังโหลดรายการ...';
        adminReviewList.innerHTML = '';
        showLoading();
        google.script.run
            .withSuccessHandler(onFilesLoaded)
            .withFailureHandler(handleError)
            .getFilesForReview();
    }

    function onFilesLoaded(files) {
        hideLoading();
        if (files.error) {
            adminLoading.innerText = 'เกิดข้อผิดพลาด: ' + files.error;
            return;
        }
        if (!files.length) {
            adminLoading.innerText = 'ไม่พบไฟล์ที่รอตรวจสอบ (หรือคุณไม่มีสิทธิ์)';
            return;
        }
        adminLoading.innerText = '';
        let html = '';
        files.forEach(file => {
            html += `
                <div class="p-4 border border-slate-200 rounded-lg flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <p class="font-semibold text-slate-800">Team: ${escapeHtmlClient(file.teamId)} | ${escapeHtmlClient(file.fileType)}</p>
                        <a href="${file.fileUrl}" target="_blank" class="text-sm text-sky-600 hover:underline break-all">ดูไฟล์ (${escapeHtmlClient(file.fileId)})</a>
                    </div>
                    <div class="flex gap-2">
                        <button class="bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-medium" onclick="approveFile('${file.fileId}')">อนุมัติ</button>
                        <button class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm font-medium" onclick="rejectFile('${file.fileId}')">? ไม่ผ่าน</button>
                    </div>
                </div>
            `;
        });
        adminReviewList.innerHTML = html;
    }

    // --- Logo & photo handlers ---
    function resetSignupAvatarUI() {
        USER_AVATAR_FILE_DATA = null;
        if (signupAvatarPreview) {
            signupAvatarPreview.src = '';
            signupAvatarPreview.classList.add('hidden');
        }
        if (signupAvatarPlaceholder) {
            signupAvatarPlaceholder.classList.remove('hidden');
        }
        if (signupAvatarStatus) {
            const defaultText = signupAvatarStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ขนาดไม่เกิน 2MB';
            signupAvatarStatus.textContent = defaultText;
            signupAvatarStatus.style.color = '#64748b';
        }
        if (signupAvatarInput) {
            signupAvatarInput.value = '';
        }
    }

    function handleSignupAvatarSelect(e) {
        const file = e.target.files[0];
        if (!file) {
            resetSignupAvatarUI();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            resetSignupAvatarUI();
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = `ไฟล์ใหญ่กว่า ${MAX}MB`;
                signupAvatarStatus.style.color = '#ef4444';
            }
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            resetSignupAvatarUI();
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = 'รองรับเฉพาะไฟล์ .jpg หรือ .png';
                signupAvatarStatus.style.color = '#ef4444';
            }
            return;
        }
        if (signupAvatarStatus) {
            signupAvatarStatus.textContent = `กำลังอัปโหลด: ${file.name}`;
            signupAvatarStatus.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            USER_AVATAR_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (signupAvatarPreview) {
                signupAvatarPreview.src = ev.target.result;
                signupAvatarPreview.classList.remove('hidden');
            }
            if (signupAvatarPlaceholder) {
                signupAvatarPlaceholder.classList.add('hidden');
            }
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = `อัปโหลดแล้ว: ${file.name}`;
                signupAvatarStatus.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            resetSignupAvatarUI();
            if (signupAvatarStatus) {
                signupAvatarStatus.textContent = 'ไม่สามารถอัปโหลดรูปได้';
                signupAvatarStatus.style.color = '#ef4444';
            }
        };
        reader.readAsDataURL(file);
    }
    function resetFormLogoPreview() {
        if (formLogoPreview) {
            formLogoPreview.src = '';
            formLogoPreview.classList.add('hidden');
        }
        if (formLogoPlaceholder) {
            formLogoPlaceholder.classList.remove('hidden');
        }
    }

    function handleLogoSelect(e) {
        const file = e.target.files[0];
        if (!file) {
            LOGO_FILE_DATA = null;
            logoStatus.innerText = "รองรับ .png, .jpg (ไม่เกิน 2MB)";
            logoStatus.style.color = '#64748b';
            resetFormLogoPreview();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            logoStatus.innerText = `? ไฟล์ใหญ่เกิน ${MAX}MB`;
            logoStatus.style.color = '#ef4444';
            e.target.value = '';
            LOGO_FILE_DATA = null;
            resetFormLogoPreview();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            logoStatus.innerText = '? รองรับ .jpg, .png เท่านั้น';
            logoStatus.style.color = '#ef4444';
            e.target.value = '';
            LOGO_FILE_DATA = null;
            resetFormLogoPreview();
            return;
        }
        logoStatus.innerText = `? กำลังเตรียมไฟล์: ${file.name}`;
        logoStatus.style.color = '#0ea5e9';
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            LOGO_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (formLogoPreview) {
                formLogoPreview.src = ev.target.result;
                formLogoPreview.classList.remove('hidden');
            }
            if (formLogoPlaceholder) {
                formLogoPlaceholder.classList.add('hidden');
            }
            logoStatus.innerText = `ไฟล์พร้อมแล้ว: ${file.name}`;
            logoStatus.style.color = '#22c55e';
        };
        reader.onerror = () => {
            logoStatus.innerText = '? อ่านไฟล์ไม่สำเร็จ';
            logoStatus.style.color = '#ef4444';
            LOGO_FILE_DATA = null;
            resetFormLogoPreview();
        };
        reader.readAsDataURL(file);
    }

    function resetTeamPhotoUI() {
        TEAM_PHOTO_FILE_DATA = null;
        if (teamPhotoPreview) {
            teamPhotoPreview.src = '';
            teamPhotoPreview.classList.add('hidden');
        }
        if (teamPhotoPlaceholder) teamPhotoPlaceholder.classList.remove('hidden');
        if (teamPhotoStatus) {
            const d = teamPhotoStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ไม่เกิน 3MB';
            teamPhotoStatus.innerText = d;
            teamPhotoStatus.style.color = '#64748b';
        }
        if (teamPhotoInput) teamPhotoInput.value = '';
    }

    function handleTeamPhotoSelect(e) {
        const file = e.target.files[0];
        if (!file) { resetTeamPhotoUI(); return; }
        const MAX = 3;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            teamPhotoStatus.innerText = `? ไฟล์ใหญ่เกิน ${MAX}MB`;
            teamPhotoStatus.style.color = '#ef4444';
            e.target.value = '';
            resetTeamPhotoUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            teamPhotoStatus.innerText = '? รองรับ .jpg, .png เท่านั้น';
            teamPhotoStatus.style.color = '#ef4444';
            e.target.value = '';
            resetTeamPhotoUI();
            return;
        }
        teamPhotoStatus.innerText = `? กำลังเตรียมไฟล์: ${file.name}`;
        teamPhotoStatus.style.color = '#0ea5e9';
        const reader = new FileReader();
        reader.onload = ev => {
            const dataUrl = ev.target.result;
            const base64 = dataUrl.split(',')[1];
            TEAM_PHOTO_FILE_DATA = { base64Data: base64, mimeType: file.type, fileName: file.name };
            teamPhotoPreview.src = dataUrl;
            teamPhotoPreview.classList.remove('hidden');
            teamPhotoPlaceholder.classList.add('hidden');
            teamPhotoStatus.innerText = `ไฟล์พร้อมแล้ว: ${file.name}`;
            teamPhotoStatus.style.color = '#22c55e';
        };
        reader.onerror = () => {
            teamPhotoStatus.innerText = '? อ่านไฟล์ไม่สำเร็จ';
            teamPhotoStatus.style.color = '#ef4444';
            resetTeamPhotoUI();
        };
        reader.readAsDataURL(file);
    }

    function resetTeamManageLogoUI() {
        teamManageLogoFileData = null;
        if (teamManageLogoPreview) {
            teamManageLogoPreview.src = '';
            teamManageLogoPreview.classList.add('hidden');
        }
        if (teamManageLogoPlaceholder) {
            teamManageLogoPlaceholder.classList.remove('hidden');
        }
        if (teamManageLogoStatus) {
            const defaultText = teamManageLogoStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ไม่เกิน 2MB (Admin/Area เท่านั้น)';
            teamManageLogoStatus.textContent = defaultText;
            teamManageLogoStatus.style.color = '#64748b';
        }
        if (teamManageLogoInput) teamManageLogoInput.value = '';
    }

    function resetTeamManagePhotoUI() {
        teamManagePhotoFileData = null;
        if (teamManagePhotoPreview) {
            teamManagePhotoPreview.src = '';
            teamManagePhotoPreview.classList.add('hidden');
        }
        if (teamManagePhotoPlaceholder) {
            teamManagePhotoPlaceholder.classList.remove('hidden');
        }
        if (teamManagePhotoStatus) {
            const defaultText = teamManagePhotoStatus.dataset.defaultStatus || 'รองรับ .png, .jpg ไม่เกิน 3MB (Admin/Area เท่านั้น)';
            teamManagePhotoStatus.textContent = defaultText;
            teamManagePhotoStatus.style.color = '#64748b';
        }
        if (teamManagePhotoInput) teamManagePhotoInput.value = '';
    }

    function handleTeamManageLogoSelect(event) {
        if (!teamManageImageEditable) {
            resetTeamManageLogoUI();
            return;
        }
        const file = event?.target?.files?.[0];
        if (!file) {
            resetTeamManageLogoUI();
            return;
        }
        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = `ไฟล์ใหญ่กว่า ${MAX}MB`;
                teamManageLogoStatus.style.color = '#ef4444';
            }
            resetTeamManageLogoUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = 'รองรับเฉพาะไฟล์ .jpg หรือ .png';
                teamManageLogoStatus.style.color = '#ef4444';
            }
            resetTeamManageLogoUI();
            return;
        }
        if (teamManageLogoStatus) {
            teamManageLogoStatus.textContent = `กำลังประมวลผล: ${file.name}`;
            teamManageLogoStatus.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            teamManageLogoFileData = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (teamManageLogoPreview) {
                teamManageLogoPreview.src = ev.target.result;
                teamManageLogoPreview.classList.remove('hidden');
            }
            if (teamManageLogoPlaceholder) teamManageLogoPlaceholder.classList.add('hidden');
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = `อัปโหลดแล้ว: ${file.name}`;
                teamManageLogoStatus.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            resetTeamManageLogoUI();
            if (teamManageLogoStatus) {
                teamManageLogoStatus.textContent = 'ไม่สามารถอ่านไฟล์ได้';
                teamManageLogoStatus.style.color = '#ef4444';
            }
        };
        reader.readAsDataURL(file);
    }

    function handleTeamManagePhotoSelect(event) {
        if (!teamManageImageEditable) {
            resetTeamManagePhotoUI();
            return;
        }
        const file = event?.target?.files?.[0];
        if (!file) {
            resetTeamManagePhotoUI();
            return;
        }
        const MAX = 3;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = `ไฟล์ใหญ่กว่า ${MAX}MB`;
                teamManagePhotoStatus.style.color = '#ef4444';
            }
            resetTeamManagePhotoUI();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = 'รองรับเฉพาะไฟล์ .jpg หรือ .png';
                teamManagePhotoStatus.style.color = '#ef4444';
            }
            resetTeamManagePhotoUI();
            return;
        }
        if (teamManagePhotoStatus) {
            teamManagePhotoStatus.textContent = `กำลังประมวลผล: ${file.name}`;
            teamManagePhotoStatus.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const base64 = ev.target.result.split(',')[1];
            teamManagePhotoFileData = { base64Data: base64, mimeType: file.type, fileName: file.name };
            if (teamManagePhotoPreview) {
                teamManagePhotoPreview.src = ev.target.result;
                teamManagePhotoPreview.classList.remove('hidden');
            }
            if (teamManagePhotoPlaceholder) teamManagePhotoPlaceholder.classList.add('hidden');
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = `อัปโหลดแล้ว: ${file.name}`;
                teamManagePhotoStatus.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            resetTeamManagePhotoUI();
            if (teamManagePhotoStatus) {
                teamManagePhotoStatus.textContent = 'ไม่สามารถอ่านไฟล์ได้';
                teamManagePhotoStatus.style.color = '#ef4444';
            }
        };
        reader.readAsDataURL(file);
    }

    function resetMemberPhotoData() {
        Object.keys(MEMBER_PHOTO_DATA).forEach(k => delete MEMBER_PHOTO_DATA[k]);
    }
    function resetTeamManageMemberPhotoData() {
        Object.keys(TEAM_MANAGE_MEMBER_PHOTO_DATA).forEach(k => delete TEAM_MANAGE_MEMBER_PHOTO_DATA[k]);
    }
    function getMemberPhotoStore(scope = 'form') {
        return scope === 'manage' ? TEAM_MANAGE_MEMBER_PHOTO_DATA : MEMBER_PHOTO_DATA;
    }

    function attachMemberPhotoListeners() {
        const inputs = document.querySelectorAll('input[data-member-photo="true"]');
        inputs.forEach(input => {
            input.removeEventListener('change', handleMemberPhotoSelect);
            input.addEventListener('change', handleMemberPhotoSelect);
        });
    }

    function handleMemberPhotoSelect(e) {
        const input = e.target;
        const file = input.files[0];
        const memberType = input.dataset.memberType || 'member';
        const memberIndex = input.dataset.memberIndex || '0';
        const previewId = input.dataset.previewTarget;
        const placeholderId = input.dataset.placeholderTarget;
        const statusId = input.dataset.statusTarget;
        const scope = input.dataset.photoScope || 'form';
        const memberKey = input.dataset.memberKey || `${memberType}-${memberIndex}`;
        const store = getMemberPhotoStore(scope);
        const previewEl = previewId ? document.getElementById(previewId) : null;
        const placeholderEl = placeholderId ? document.getElementById(placeholderId) : null;
        const statusEl = statusId ? document.getElementById(statusId) : null;
        const defaultStatus = statusEl ? (statusEl.dataset.defaultStatus || statusEl.textContent) : '';

        const showPlaceholder = () => {
            if (previewEl) {
                previewEl.src = '';
                previewEl.classList.add('hidden');
            }
            if (placeholderEl) placeholderEl.classList.remove('hidden');
        };
        const resetStatus = () => {
            if (statusEl && defaultStatus) {
                statusEl.innerText = defaultStatus;
                statusEl.style.color = '#64748b';
            }
        };

        if (!file) {
            delete store[memberKey];
            showPlaceholder();
            resetStatus();
            return;
        }

        const MAX = 2;
        const ALLOWED = ['image/jpeg', 'image/png'];
        if (file.size > MAX * 1024 * 1024) {
            if (statusEl) {
                statusEl.innerText = `? ไฟล์ใหญ่เกิน ${MAX}MB`;
                statusEl.style.color = '#ef4444';
            }
            input.value = '';
            delete store[memberKey];
            showPlaceholder();
            return;
        }
        if (!ALLOWED.includes(file.type)) {
            if (statusEl) {
                statusEl.innerText = '? รองรับ .jpg, .png เท่านั้น';
                statusEl.style.color = '#ef4444';
            }
            input.value = '';
            delete store[memberKey];
            showPlaceholder();
            return;
        }

        if (statusEl) {
            statusEl.innerText = `? กำลังเตรียมไฟล์: ${file.name}`;
            statusEl.style.color = '#0ea5e9';
        }
        const reader = new FileReader();
        reader.onload = ev => {
            const dataUrl = ev.target.result;
            const base64 = dataUrl.split(',')[1];
            store[memberKey] = { base64Data: base64, mimeType: file.type, fileName: file.name, dataUrl };
            if (previewEl) {
                previewEl.src = dataUrl;
                previewEl.classList.remove('hidden');
            }
            if (placeholderEl) placeholderEl.classList.add('hidden');
            if (statusEl) {
                statusEl.innerText = `ไฟล์พร้อมแล้ว: ${file.name}`;
                statusEl.style.color = '#22c55e';
            }
        };
        reader.onerror = () => {
            if (statusEl) {
                statusEl.innerText = '? อ่านไฟล์ไม่สำเร็จ';
                statusEl.style.color = '#ef4444';
            }
            delete store[memberKey];
            showPlaceholder();
        };
        reader.readAsDataURL(file);
    }

    // --- Form behavior based on activity ---
    function selectActivityForForm(activityId) {
        if (!requireLoginForRegistration()) return;
        const activity = ALL_ACTIVITIES.find(a => a.id === activityId);
        if (isActivityClosed(activity)) {
            Swal.fire({ icon: 'info', title: 'กิจกรรมนี้ปิดรับสมัครแล้ว', text: 'ไม่สามารถสมัครทีมใหม่ได้' });
            return;
        }
        if (activityCategorySelect && activity) {
            syncCategoryForActivity(activity);
        }
        activitySelect.value = activityId;
        updateFormBasedOnActivity(activityId);
        navigateTo('section-form');
    }

    function syncCategoryForActivity(activity) {
        if (!activityCategorySelect || !activity) return;
        const target = activity.category || '';
        if (activityCategorySelect.value !== target) {
            suppressCategorySync = true;
            activityCategorySelect.value = target;
            suppressCategorySync = false;
        }
        refreshActivitiesAfterCategoryChange(activity.id);
    }

    function refreshActivitiesAfterCategoryChange(preferredActivityId = null) {
        if (!activitySelect) return;
        const activities = getFormActivities();
        populateFormActivitySelect(activities);
        if (preferredActivityId && activities.some(a => a.id === preferredActivityId)) {
            activitySelect.value = preferredActivityId;
        } else if (preferredActivityId) {
            activitySelect.value = '';
        }
    }

    function updateFormBasedOnActivity(activityId) {
        const activity = ALL_ACTIVITIES.find(a => a.id === activityId);
        if (!activity) {
            levelSelect.innerHTML = '<option value="">-- เลือกระดับ --</option>';
            memberReqText.innerText = 'กรุณาเลือกกิจกรรม...';
            teacherFields.innerHTML = '';
            studentFields.innerHTML = '';
            resetMemberPhotoData();
            setSubmitButtonState(true);
            return;
        }
        if (isActivityClosed(activity)) {
            levelSelect.innerHTML = '<option value="">-- เลือกระดับ --</option>';
            memberReqText.innerText = 'กิจกรรมนี้ปิดรับสมัครแล้ว';
            teacherFields.innerHTML = '';
            studentFields.innerHTML = '';
            resetMemberPhotoData();
            setSubmitButtonState(true);
            return;
        }

        setSubmitButtonState(false);
        levelSelect.innerHTML = '<option value="">-- เลือกระดับ --</option>';
        (Array.isArray(activity.levels) ? activity.levels : []).forEach(level => {
            levelSelect.innerHTML += `<option value="${level}">${level}</option>`;
        });
        if (Array.isArray(activity.levels) && activity.levels.length === 1) {
            levelSelect.value = activity.levels[0];
        } else {
            levelSelect.value = '';
        }

        const reqs = {
            teachers: activity.reqTeachers || 1,
            students: activity.reqStudents || 2
        };
        const remainingTeams = calculateRemainingTeams(activity);
        const hasLimit = typeof activity.maxTeams === 'number' && activity.maxTeams > 0;
        const limitText = hasLimit
            ? `รับ ${activity.maxTeams} ทีม (เหลือ ${typeof remainingTeams === 'number' ? remainingTeams : '-'} ทีม)`
            : 'ไม่จำกัดทีม';
        const deadlineText = formatDeadline(activity.registrationDeadline);

        memberReqText.innerHTML =
            `กิจกรรมนี้ต้องการ: ครู ${reqs.teachers} คน, นักเรียน ${reqs.students} คน` +
            `<br>จำนวนทีม: ${limitText}` +
            `<br>ปิดรับสมัคร: ${deadlineText}`;

        resetMemberPhotoData();
        teacherFields.innerHTML = '';
        for (let i = 1; i <= reqs.teachers; i++) {
            const pid = `teacher-photo-${i}`;
            const previewId = `${pid}-preview`;
            const placeholderId = `${pid}-placeholder`;
            const statusId = `${pid}-status`;
            teacherFields.innerHTML += `
                <div class="p-3 border rounded-lg bg-slate-50">
                    <p class="font-medium mb-2">ครู คนที่ ${i}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input type="text" name="teacherPrefix" list="teacher-prefix-options" placeholder="คำนำหน้า" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        <input type="text" name="teacherName" placeholder="ชื่อ-สกุล ครู" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        <input type="tel" name="teacherPhone" placeholder="เบอร์โทร ครู" class="w-full p-2 border border-slate-300 rounded-lg" data-only-digits="true" inputmode="numeric" pattern="[0-9]*" required>
                    </div>
                    <div class="mt-3 flex items-center gap-3">
                        <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white.flex items-center justify-center overflow-hidden">
                            <img id="${previewId}" alt="Teacher preview ${i}" class="hidden w-full h-full object-cover">
                            <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>
                        </div>
                        <div class="flex-1 space-y-1">
                            <input type="file"
                                   id="${pid}"
                                   data-member-photo="true"
                                   data-member-type="teacher"
                                   data-member-index="${i}"
                                   data-preview-target="${previewId}"
                                   data-placeholder-target="${placeholderId}"
                                   data-status-target="${statusId}"
                                   class="w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-sky-100 file:text-sky-700
                                        hover:file:bg-sky-200"
                                   accept="image/png, image/jpeg">
                            <p id="${statusId}" class="text-xs text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)">อัปโหลดรูปเดี่ยวครู (ไม่เกิน 2MB)</p>
                        </div>
                    </div>
                </div>
            `;
        }

        studentFields.innerHTML = '';
        for (let i = 1; i <= reqs.students; i++) {
            const pid = `student-photo-${i}`;
            const previewId = `${pid}-preview`;
            const placeholderId = `${pid}-placeholder`;
            const statusId = `${pid}-status`;
            studentFields.innerHTML += `
                <div class="p-3 border rounded-lg bg-slate-50">
                    <p class="font-medium mb-2">นักเรียน คนที่ ${i}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <input type="text" name="studentPrefix" list="student-prefix-options" placeholder="คำนำหน้า" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        <input type="text" name="studentName" placeholder="ชื่อ-สกุล นักเรียน" class="w-full p-2 border border-slate-300 rounded-lg" required>
                        ${buildClassLevelControlHtml('student', i, '', { scope: 'form' })}
                    </div>
                    <div class="mt-3 flex items-center gap-3">
                        <div class="w-16 h-16 rounded-full border border-dashed border-slate-300 bg-white flex items-center justify-center overflow-hidden">
                            <img id="${previewId}" alt="Student preview ${i}" class="hidden w-full h-full object-cover">
                            <span id="${placeholderId}" class="material-symbols-outlined text-slate-400">person</span>
                        </div>
                        <div class="flex-1 space-y-1">
                            <input type="file"
                                   id="${pid}"
                                   data-member-photo="true"
                                   data-member-type="student"
                                   data-member-index="${i}"
                                   data-preview-target="${previewId}"
                                   data-placeholder-target="${placeholderId}"
                                   data-status-target="${statusId}"
                                   class="w-full text-sm text-slate-500
                                        file:mr-4 file:py-2 file:px-4
                                        file:rounded-lg file:border-0
                                        file:text-sm file:font-semibold
                                        file:bg-sky-100 file:text-sky-700
                                        hover:file:bg-sky-200"
                                   accept="image/png, image/jpeg">
                            <p id="${statusId}" class="text-xs text-slate-500" data-default-status="อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)">อัปโหลดรูปเดี่ยวนักเรียน (ไม่เกิน 2MB)</p>
                        </div>
                    </div>
                </div>
            `;
        }
        attachMemberPhotoListeners();
    }

    function getFormActivities() {
        let activities = [...ALL_ACTIVITIES];
        if (!activityCategorySelect) return activities;
        const selectedCategory = activityCategorySelect.value || '';
        if (selectedCategory) {
            activities = activities.filter(a => (a.category || '') === selectedCategory);
        }
        return activities;
    }

    // --- Export Teams ---
    function base64ToBlob(base64, mimeType) {
        const binary = atob(base64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        return new Blob([bytes], { type: mimeType });
    }
    function downloadBase64File(base64, mimeType, fileName) {
        const blob = base64ToBlob(base64, mimeType);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function handleTeamsExport(format) {
        const allowed = ['csv', 'pdf'];
        if (!allowed.includes(format)) {
            Swal.fire({ icon: 'error', title: 'รูปแบบไม่รองรับ', text: 'ไม่สามารถส่งออกไฟล์ได้' });
            return;
        }

        if (!window.ALL_TEAMS || !ALL_TEAMS.length) {
            Swal.fire({ icon: 'warning', title: 'ยังไม่มีข้อมูลทีม', text: 'โปรดโหลดข้อมูลทีมก่อนส่งออก' });
            return;
        }

        // ส่งออก CSV ผ่าน backend (เดิม)
        if (format === 'csv') {
            Swal.fire({
                title: 'กำลังเตรียมไฟล์ CSV...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            google.script.run
                .withSuccessHandler(res => {
                    Swal.close();
                    if (!res || !res.success) {
                        const msg = (res && res.error) || 'ไม่สามารถส่งออกข้อมูลได้';
                        Swal.fire({ icon: 'error', title: 'ส่งออกไม่สำเร็จ', text: msg });
                        return;
                    }
                    try {
                        downloadBase64File(res.data, res.mimeType || 'text/csv', res.fileName || 'teams.csv');
                        Swal.fire({
                            icon: 'success',
                            title: 'ส่งออกสำเร็จ',
                            text: `ไฟล์ ${res.fileName || 'teams.csv'} ถูกดาวน์โหลดแล้ว`,
                            timer: 2200,
                            showConfirmButton: false
                        });
                    } catch (err) {
                        handleError(err);
                    }
                })
                .withFailureHandler(err => {
                    Swal.close();
                    handleError(err);
                })
                .exportTeams('csv');
            return;
        }

        // ส่งออก PDF สรุปทีมด้วย jsPDF + html2canvas (ฟอนต์ Kanit)
        if (!(window.jspdf && window.jspdf.jsPDF && window.html2canvas)) {
            Swal.fire({
                icon: 'error',
                title: 'ไม่พบ jsPDF/html2canvas',
                text: 'กรุณาตรวจสอบการเชื่อมต่อหรือสคริปต์ jsPDF อีกครั้ง'
            });
            return;
        }
        generateTeamsSummaryPdfKanit();
    }

    function generateTeamsSummaryPdfKanit() {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

        // เตรียม DOM ชั่วคราวสำหรับเรนเดอร์
        const container = document.createElement('div');
        container.className = 'pdf-kanit';
        container.style.position = 'fixed';
        container.style.left = '-10000px';
        container.style.top = '0';
        container.style.width = '1120px';
        container.style.background = '#ffffff';
        container.style.padding = '16px';

        const updatedAt = new Date().toLocaleString('th-TH');

        let html = '';
        html += '<div class="pdf-title">รายงานทีมที่ลงทะเบียน</div>';
        html += '<div class="pdf-subtitle">อัปเดตล่าสุด: ' + escapeHtmlForPdf(updatedAt) + '</div>';
        html += '<table class="pdf-table"><thead><tr>';
        html += '<th>#</th><th>รหัสทีม</th><th>กิจกรรม</th><th>ชื่อทีม</th><th>โรงเรียน</th>';
        html += '<th>ครู (ต้อง/มี)</th><th>นร. (ต้อง/มี)</th><th>ระดับ</th><th>สถานะ</th>';
        html += '</tr></thead><tbody>';

        (ALL_TEAMS || []).forEach((t, i) => {
            let teachers = 0, students = 0;
            try {
                const m = t.members ? JSON.parse(t.members) : {};
                teachers = Array.isArray(m.teachers) ? m.teachers.length : 0;
                students = Array.isArray(m.students) ? m.students.length : 0;
            } catch (e) {}

            html += '<tr>';
            html += '<td>' + (i + 1) + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.teamId || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.activityName || t.activity || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.teamName || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.school || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf((t.requiredTeachers || '-') + ' / ' + teachers) + '</td>';
            html += '<td>' + escapeHtmlForPdf((t.requiredStudents || '-') + ' / ' + students) + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.level || '') + '</td>';
            html += '<td>' + escapeHtmlForPdf(t.status || '') + '</td>';
            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
        document.body.appendChild(container);

        Swal.fire({
            title: 'กำลังสร้าง PDF...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        pdf.html(container, {
            margin: 20,
            autoPaging: 'text',
            html2canvas: { scale: 2, useCORS: true, logging: false }
        }).then(() => {
            Swal.close();
            pdf.save('teams-summary.pdf');
            document.body.removeChild(container);
        }).catch(err => {
            Swal.close();
            document.body.removeChild(container);
            handleError(err);
        });
    }

    function handleAttendanceSheetExport() {
        if (!window.ALL_TEAMS || !ALL_TEAMS.length) {
            Swal.fire({ icon: 'warning', title: 'ยังไม่มีข้อมูลทีม', text: 'โปรดโหลดข้อมูลทีมก่อนส่งออก' });
            return;
        }
        if (!(window.jspdf && window.jspdf.jsPDF && window.html2canvas)) {
            Swal.fire({
                icon: 'error',
                title: 'ไม่พบ jsPDF/html2canvas',
                text: 'กรุณาตรวจสอบการเชื่อมต่อหรือสคริปต์ jsPDF อีกครั้ง'
            });
            return;
        }

        const activityMap = {};
        (window.ALL_ACTIVITIES || []).forEach(a => {
            if (a && (a.id || a.activityId)) {
                const id = String(a.id || a.activityId);
                activityMap[id] = a.name || a.title || id;
            }
        });
        (ALL_TEAMS || []).forEach(t => {
            const id = String(t.activity || t.activityId || '').trim();
            if (!id) return;
            if (!activityMap[id]) activityMap[id] = id;
        });

        const activityIds = Object.keys(activityMap).sort();
        const selectHtml = activityIds.map(id =>
            '<option value="' + escapeHtmlForPdf(id) + '">' +
            escapeHtmlForPdf(id) + ' - ' + escapeHtmlForPdf(activityMap[id]) +
            '</option>'
        ).join('');

        Swal.fire({
            title: 'ใบลงเวลา PDF (กิจกรรม)',
            html:
                '<div class="text-left">' +
                '<label class="block mb-2 text-sm text-slate-700">เลือกกิจกรรม</label>' +
                '<select id="attendance-activity-select" class="swal2-select" style="width:100%;">' +
                '<option value="ALL">ทุกกิจกรรม (แยกหน้า)</option>' +
                selectHtml +
                '</select>' +
                '</div>',
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'สร้าง PDF',
            cancelButtonText: 'ยกเลิก',
            preConfirm: () => {
                const el = document.getElementById('attendance-activity-select');
                return el ? el.value : 'ALL';
            }
        }).then(result => {
            if (!result.isConfirmed) return;
            generateAttendancePdfKanit(result.value, activityMap);
        });
    }

    function generateAttendancePdfKanit(selectedActivityId, activityMap) {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

        // group teams by activity
        const grouped = {};
        (ALL_TEAMS || []).forEach(team => {
            const actId = String(team.activity || team.activityId || '').trim();
            if (!actId) return;
            if (selectedActivityId && selectedActivityId !== 'ALL' && actId !== selectedActivityId) return;
            if (!grouped[actId]) grouped[actId] = [];
            grouped[actId].push(team);
        });

        const actIds = Object.keys(grouped);
        if (!actIds.length) {
            Swal.fire({ icon: 'warning', title: 'ไม่มีข้อมูลทีมในกิจกรรมที่เลือก' });
            return;
        }

        Swal.fire({
            title: 'กำลังสร้าง PDF...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        let firstPage = true;

        const createPageFromContainer = (container, isLast) => {
            return pdf.html(container, {
                margin: 20,
                autoPaging: 'text',
                html2canvas: { scale: 2, useCORS: true, logging: false }
            }).then(() => {
                document.body.removeChild(container);
                if (!isLast) {
                    pdf.addPage();
                }
            });
        };

        const tasks = [];

        actIds.forEach((actId, idx) => {
            const teams = grouped[actId];
            const actName = activityMap[actId] || actId;

            const container = document.createElement('div');
            container.className = 'pdf-kanit';
            container.style.position = 'fixed';
            container.style.left = '-10000px';
            container.style.top = '0';
            container.style.width = '794px';
            container.style.background = '#ffffff';
            container.style.padding = '16px';

            let html = '';
            html += '<div class="pdf-title">ใบลงเวลาเข้าร่วมกิจกรรม / การแข่งขัน</div>';
            html += '<div class="pdf-subtitle">กิจกรรม: ' + escapeHtmlForPdf(actName) + '</div>';
            html += '<div class="pdf-subtitle">วันที่ ........../........../.......... &nbsp;&nbsp; สถานที่ ..............................................</div>';
            html += '<table class="pdf-table"><thead><tr>';
            html += '<th>ลำดับ</th><th>ชื่อ - สกุล</th><th>โรงเรียน / ทีม</th><th>บทบาท</th>';
            html += '<th>ลงเวลาเข้า</th><th>ลงเวลาออก</th><th>ลายมือชื่อ</th>';
            html += '</tr></thead><tbody>';

            let running = 1;
            teams.forEach(team => {
                let members = {};
                try { members = team.members ? JSON.parse(team.members) : {}; } catch (e) {}

                const teachers = Array.isArray(members.teachers) ? members.teachers : [];
                const students = Array.isArray(members.students) ? members.students : [];
                const schoolName = team.school || '';
                const teamLabel = team.teamName ? ' (' + team.teamName + ')' : '';

                teachers.forEach(t => {
                    html += '<tr>';
                    html += '<td>' + (running++) + '</td>';
                    html += '<td>' + escapeHtmlForPdf(t.name || '') + '</td>';
                    html += '<td>' + escapeHtmlForPdf(schoolName + teamLabel) + '</td>';
                    html += '<td>ครูผู้ควบคุม</td>';
                    html += '<td></td><td></td><td></td>';
                    html += '</tr>';
                });

                students.forEach(s => {
                    html += '<tr>';
                    html += '<td>' + (running++) + '</td>';
                    html += '<td>' + escapeHtmlForPdf(s.name || '') + '</td>';
                    html += '<td>' + escapeHtmlForPdf(schoolName + teamLabel) + '</td>';
                    html += '<td>นักเรียน</td>';
                    html += '<td></td><td></td><td></td>';
                    html += '</tr>';
                });
            });

            if (running === 1) {
                html += '<tr><td colspan="7" style="text-align:center;color:#64748b;">ไม่มีรายชื่อ</td></tr>';
            }

            html += '</tbody></table>';
            html += '<div class="pdf-subtitle" style="margin-top:8px;">รวม ' + (running - 1) + ' คน &nbsp;&nbsp;&nbsp; ผู้รับรอง ....................................................</div>';

            container.innerHTML = html;
            document.body.appendChild(container);

            const isLast = (idx === actIds.length - 1);
            tasks.push(createPageFromContainer(container, isLast));
        });

        Promise.all(tasks).then(() => {
            Swal.close();
            const fileName = (selectedActivityId && selectedActivityId !== 'ALL')
                ? ('attendance_' + selectedActivityId + '.pdf')
                : 'attendance_all_activities.pdf';
            pdf.save(fileName);
        }).catch(err => {
            Swal.close();
            handleError(err);
        });
    }

    function escapeHtmlForPdf(value) {
        return String(value || '').replace(/[&<>"']/g, function (m) {
            return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' })[m] || m;
        });
    }
// --- Upload (section 5) ---
    uploadButton.addEventListener('click', () => {
        const teamId = uploadTeamIdSelect.value;
        const fileType = uploadFileTypeSelect.value;
        const file = fileInput.files[0];
        if (!teamId || !fileType || !file) {
            Swal.fire({ icon: 'warning', title: 'กรุณากรอกข้อมูลให้ครบ', text: 'โปรดเลือกทีม ประเภทไฟล์ และไฟล์ที่ต้องการอัปโหลด' });
            return;
        }
        const MAX = 5;
        if (file.size > MAX * 1024 * 1024) {
            uploadStatusDiv.innerHTML = `<p class="text-red-600 font-semibold">? ไฟล์ใหญ่เกิน ${MAX}MB (ไฟล์ของคุณ ${(file.size/1024/1024).toFixed(2)}MB)</p>`;
            return;
        }
        const ALLOWED = ['application/pdf', 'image/jpeg', 'image/png'];
        if (!ALLOWED.includes(file.type)) {
            uploadStatusDiv.innerHTML = `<p class="text-red-600 font-semibold">? รองรับเฉพาะไฟล์ .pdf, .jpg, .png เท่านั้น (ไฟล์ของคุณคือ ${file.type})</p>`;
            return;
        }
        showLoading();
        uploadStatusDiv.innerHTML = `<p class="text-sky-600">กำลังอัปโหลด ${file.name}...</p>`;
        const reader = new FileReader();
        reader.onload = e => {
            const base64Data = e.target.result.split(',')[1];
            const fileData = {
                base64Data,
                mimeType: file.type,
                fileName: file.name,
                teamId,
                fileType
            };
            google.script.run
                .withSuccessHandler(onUploadSuccess)
                .withFailureHandler(onUploadFailure)
                .uploadFile(fileData);
        };
        reader.readAsDataURL(file);
    });

    function onUploadSuccess(res) {
        hideLoading();
        if (res.success) {
        uploadStatusDiv.innerHTML = `<p class="text-green-600">${res.message}</p>`;
            fileInput.value = '';
            uploadFileTypeSelect.value = '';
        } else {
            onUploadFailure({ message: res.error });
        }
    }
    function onUploadFailure(error) {
        hideLoading();
        uploadStatusDiv.innerHTML = `<p class="text-red-600">? อัปโหลดล้มเหลว: ${error.message}</p>`;
    }

    // --- Admin actions ---
    async function approveFile(fileLogId) {
        const result = await Swal.fire({
            icon: 'question',
            title: `ยืนยันการอนุมัติไฟล์ ${fileLogId}?`,
            confirmButtonText: 'อนุมัติ',
            cancelButtonText: 'ยกเลิก',
            showCancelButton: true
        });
        if (!result.isConfirmed) return;
        showLoading();
        google.script.run
            .withSuccessHandler(onAdminActionSuccess)
            .withFailureHandler(handleError)
            .updateFileStatus(fileLogId, 'Approved', '');
    }

    async function rejectFile(fileLogId) {
        const result = await Swal.fire({
            icon: 'warning',
            title: `กรุณาระบุเหตุผลที่ 'ไม่ผ่าน' สำหรับไฟล์ ${fileLogId}`,
            input: 'textarea',
            inputPlaceholder: 'พิมพ์เหตุผลที่ต้องการแจ้งทีม...',
            showCancelButton: true,
            confirmButtonText: 'ส่ง',
            cancelButtonText: 'ยกเลิก'
        });
        if (!result.isConfirmed) return;
        const remarks = result.value || '';
        showLoading();
        google.script.run
            .withSuccessHandler(onAdminActionSuccess)
            .withFailureHandler(handleError)
            .updateFileStatus(fileLogId, 'Rejected', remarks);
    }

    function onAdminActionSuccess(res) {
        hideLoading();
        if (res.success) {
            Swal.fire({ icon: 'success', title: 'อัปเดตสำเร็จ', text: res.message });
            loadFilesForReview();
        } else {
            handleError({ message: res.error });
        }
    }

    // --- Validate form + submit ---
    function validateTeamRegistration(data, activity, teachers, students) {
        const errors = [];
        const trim = v => (v || '').toString().trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^[0-9+()\-\s]{9,20}$/;

        if (!activity) errors.push('กรุณาเลือกกิจกรรมที่ต้องการสมัคร');
        if (!trim(data.level)) errors.push('กรุณาเลือกระดับการแข่งขัน');
        if (!trim(data.school)) {
            errors.push('กรุณากรอกชื่อสถานศึกษา');
        } else if (!isSchoolAllowedForCurrentUser(data.school)) {
            errors.push('คุณไม่มีสิทธิ์เลือกโรงเรียนนี้');
        }

        const contactName = trim(data.contact.name);
        const contactPhone = trim(data.contact.phone);
        const contactEmail = trim(data.contact.email);
        if (!contactName) errors.push('กรุณากรอกชื่อผู้ประสานงาน');
        if (!contactPhone) {
            errors.push('กรุณากรอกเบอร์โทรติดต่อ');
        } else if (!phoneRegex.test(contactPhone)) {
            errors.push('เบอร์โทรต้องมีอย่างน้อย 9 หลัก และสามารถใช้ตัวเลข + - ( ) และเว้นวรรคได้');
        }
        if (!contactEmail) {
            errors.push('กรุณากรอกอีเมลผู้ประสานงาน');
        } else if (!emailRegex.test(contactEmail)) {
            errors.push('รูปแบบอีเมลผู้ประสานงานไม่ถูกต้อง');
        }

        const expectedTeachers = Number(activity?.reqTeachers ?? data.requiredTeachers ?? teachers.length);
        const expectedStudents = Number(activity?.reqStudents ?? data.requiredStudents ?? students.length);

        teachers.forEach((t, i) => {
            const prefix = trim(t.prefix);
            const name = trim(t.name);
            const phone = trim(t.phone);
            if (!prefix || !name || !phone) {
                errors.push(`กรุณากรอกคำนำหน้า ชื่อ และเบอร์โทรของครูคนที่ ${i + 1}`);
            } else if (!phoneRegex.test(phone)) {
                errors.push(`เบอร์โทรของครูคนที่ ${i + 1} ต้องมีอย่างน้อย 9 หลัก และสามารถใช้ตัวเลข + - ( ) และเว้นวรรคได้`);
            }
        });

        students.forEach((s, i) => {
            const prefix = trim(s.prefix);
            const name = trim(s.name);
            const classroom = trim(s.class);
            if (!prefix || !name || !classroom) {
                errors.push(`กรุณากรอกคำนำหน้า ชื่อ และชั้นเรียนของนักเรียนคนที่ ${i + 1}`);
            }
        });

        if (teachers.length !== expectedTeachers) {
            errors.push(`จำนวนครูไม่ตรงตามเงื่อนไข (${expectedTeachers} คน)`);
        }
        if (students.length !== expectedStudents) {
            errors.push(`จำนวนนักเรียนไม่ตรงตามเงื่อนไข (${expectedStudents} คน)`);
        }

        return errors;
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        if (!requireLoginForRegistration()) return;
        if (!form.reportValidity()) return;

        const fd = new FormData(form);
        const getVal = name => (fd.get(name) || '').toString().trim();

        const data = {
            activity: getVal('activity'),
            level: getVal('level'),
            school: getVal('school'),
            teamName: getVal('teamName')
        };

        if (!data.activity) {
            Swal.fire({ icon: 'warning', title: 'กรุณาเลือกกิจกรรม', text: 'โปรดเลือกกิจกรรมที่ต้องการสมัคร' });
            return;
        }

        const activity = ALL_ACTIVITIES.find(a => a.id === data.activity);
        if (!activity) {
            Swal.fire({ icon: 'error', title: 'ไม่พบกิจกรรมที่เลือก', text: 'กรุณาลองใหม่อีกครั้ง' });
            return;
        }
        if (isActivityClosed(activity)) {
            Swal.fire({ icon: 'info', title: 'กิจกรรมนี้ปิดรับสมัครแล้ว', text: 'ไม่สามารถสมัครทีมใหม่ได้' });
            return;
        }

        data.contact = {
            name: getVal('contactName'),
            phone: getVal('contactPhone'),
            email: getVal('contactEmail')
        };

        const teacherNameInputs = Array.from(form.querySelectorAll('input[name="teacherName"]'));
        const teacherPhoneInputs = Array.from(form.querySelectorAll('input[name="teacherPhone"]'));
        const teacherPrefixInputs = Array.from(form.querySelectorAll('input[name="teacherPrefix"]'));
        const teachers = teacherNameInputs.map((input, idx) => {
            const t = {
                prefix: (teacherPrefixInputs[idx]?.value || '').trim(),
                name: (input.value || '').trim(),
                phone: (teacherPhoneInputs[idx]?.value || '').trim()
            };
            const key = `teacher-${idx + 1}`;
            const photo = MEMBER_PHOTO_DATA[key];
            if (photo) t.photoFileData = photo;
            return t;
        });

        const studentNameInputs = Array.from(form.querySelectorAll('input[name="studentName"]'));
        const studentPrefixInputs = Array.from(form.querySelectorAll('input[name="studentPrefix"]'));
        const students = studentNameInputs.map((input, idx) => {
            const s = {
                prefix: (studentPrefixInputs[idx]?.value || '').trim(),
                name: (input.value || '').trim(),
                class: getSelectedClassLevelValue('student', idx + 1, 'form')
            };
            const key = `student-${idx + 1}`;
            const photo = MEMBER_PHOTO_DATA[key];
            if (photo) s.photoFileData = photo;
            return s;
        });

        data.members = { teachers, students };
        data.requiredTeachers = activity ? Number(activity.reqTeachers || teachers.length) : teachers.length;
        data.requiredStudents = activity ? Number(activity.reqStudents || students.length) : students.length;
        const creatorId = getCurrentUserId();
        if (creatorId) {
            data.createdByUserId = creatorId;
            data.createdByUsername = currentUser?.username || '';
        }

        const errors = validateTeamRegistration(data, activity, teachers, students);
        if (errors.length > 0) {
            const html = `<ul class="text-left list-disc list-inside space-y-1">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
            Swal.fire({ icon: 'warning', title: 'กรุณาตรวจสอบข้อมูล', html });
            return;
        }

        if (LOGO_FILE_DATA) data.logoFileData = LOGO_FILE_DATA;
        if (TEAM_PHOTO_FILE_DATA) data.teamPhotoFileData = TEAM_PHOTO_FILE_DATA;

        showLoading();
        google.script.run
            .withSuccessHandler(onRegistrationSuccess)
            .withFailureHandler(handleError)
            .registerTeam(data);
    });

    function onRegistrationSuccess(res) {
        hideLoading();
        if (res.success) {
            Swal.fire({
                icon: 'success',
                title: 'ลงทะเบียนสำเร็จ!',
                text: `รหัสทีมของคุณคือ: ${res.teamId}`
            }).then(() => {
                form.reset();
                LOGO_FILE_DATA = null;
                logoStatus.innerText = "รองรับ .png, .jpg (ไม่เกิน 2MB)";
                logoStatus.style.color = '#64748b';
                logoInput.value = '';
                resetFormLogoPreview();
                resetTeamPhotoUI();
                resetMemberPhotoData();
                activitySelect.value = '';
                updateFormBasedOnActivity('');
                setSubmitButtonState(true);
                CURRENT_STEP = 1;
                updateFormStepUI();
                loadRegisteredTeams(true);
                cachedReport = null;
                lastReportFetch = 0;
                loadSchoolOptions(true);
                navigateTo('section-teams');
            });
        } else {
            handleError({ message: res.error });
        }
    }

    // --- Search handlers ---
    function handleTeamSearchInput(e) {
        const val = e.target.value || '';
        if (teamSearchDebounce) clearTimeout(teamSearchDebounce);
        teamSearchDebounce = setTimeout(() => {
            teamSearchTerm = val.trim().toLowerCase();
            renderTeamTable(ALL_TEAMS);
        }, 200);
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        setSubmitButtonState(true);
        updateAuthUI();
        restoreUserSession();
        loadInitialData();
        initializeAuthSection();
        loadSchoolOptions();
        navigateTo('section-hero', document.querySelector('.nav-item'));

        if (logoInput) logoInput.addEventListener('change', handleLogoSelect);
        if (teamPhotoInput) teamPhotoInput.addEventListener('change', handleTeamPhotoSelect);
        if (signupAvatarInput) signupAvatarInput.addEventListener('change', handleSignupAvatarSelect);

        if (homeActivitySearchInput) homeActivitySearchInput.addEventListener('input', handleHomeActivitySearchInput);
        if (homeActivityLoadMoreBtn) homeActivityLoadMoreBtn.addEventListener('click', handleHomeActivityLoadMore);

        if (teamSearchInput) teamSearchInput.addEventListener('input', handleTeamSearchInput);

        if (activitySelect) {
            activitySelect.addEventListener('change', e => updateFormBasedOnActivity(e.target.value));
        }
        if (activityCategorySelect) {
            activityCategorySelect.addEventListener('change', () => {
                if (suppressCategorySync) return;
                refreshActivitiesAfterCategoryChange();
                updateFormBasedOnActivity(activitySelect.value || '');
            });
        }

        if (schoolInput) {
            schoolInput.addEventListener('focus', () => loadSchoolOptions());
            schoolInput.addEventListener('input', () => loadSchoolOptions());
        }

        const exportCsvBtn = document.getElementById('export-csv-button');
        const exportPdfBtn = document.getElementById('export-pdf-button');
        if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => handleTeamsExport('csv'));
        if (exportPdfBtn) exportPdfBtn.addEventListener('click', () => handleTeamsExport('pdf'));

        [contactNameInput, contactPhoneInput, contactEmailInput].forEach(input => {
            if (input) {
                input.addEventListener('input', markContactFieldManual);
            }
        });
        if (profileForm) {
            profileForm.addEventListener('submit', handleProfileFormSubmit);
        }
        if (navProfileAvatarInput) {
            navProfileAvatarInput.addEventListener('change', handleNavProfileAvatarSelect);
        }
        if (navProfileAvatarSubmit) {
            navProfileAvatarSubmit.addEventListener('click', handleNavProfileAvatarSubmit);
        }
        if (navProfileLogoutButton) {
            navProfileLogoutButton.addEventListener('click', handleNavProfileLogout);
        }
        if (profileLogoutButton) {
            profileLogoutButton.addEventListener('click', handleProfileSectionLogout);
        }
        if (teamManagePanel) {
            teamManagePanel.addEventListener('click', event => {
                if (event.target === teamManagePanel) {
                    closeTeamManager();
                }
            });
        }
        if (teamManageLogoInput) {
            teamManageLogoInput.addEventListener('change', handleTeamManageLogoSelect);
        }
        if (teamManagePhotoInput) {
            teamManagePhotoInput.addEventListener('change', handleTeamManagePhotoSelect);
        }
        if (teamManagePhotoOpen) {
            teamManagePhotoOpen.addEventListener('click', () => {
                if (activeManagedTeam) {
                    openTeamPhotoModal(activeManagedTeam.teamId);
                }
            });
        }
        document.addEventListener('click', handleGlobalProfileMenuClick);
        document.addEventListener('keydown', handleProfileMenuKeydown);
        document.addEventListener('input', handleNumericInputEvent, true);
        document.addEventListener('change', event => {
            if (event.target?.matches('[data-class-level-select="true"]')) {
                toggleClassLevelCustomInput(event.target);
                if ((event.target.dataset.classScope || '') === 'manage') {
                    handleManagedClassLevelValue(
                        event.target.dataset.memberType || 'student',
                        event.target.dataset.memberIndex || '0',
                        event.target.dataset.managedIndex
                    );
                }
            }
        });
        document.addEventListener('input', event => {
            if (event.target?.matches('[data-class-level-custom="true"]') && (event.target.dataset.classScope || '') === 'manage') {
                handleManagedClassLevelValue(
                    event.target.dataset.memberType || 'student',
                    event.target.dataset.memberIndex || '0',
                    event.target.dataset.managedIndex
                );
            }
        });
        if (userManagementRefreshBtn) {
            userManagementRefreshBtn.addEventListener('click', () => loadUserManagementData(true));
        }
        if (userManagementAddButton) {
            userManagementAddButton.addEventListener('click', () => openUserManagementForm());
        }
        if (userManagementForm) {
            userManagementForm.addEventListener('submit', handleUserManagementFormSubmit);
        }
        if (userManagementCancelLink) {
            userManagementCancelLink.addEventListener('click', event => {
                event.preventDefault();
                hideUserManagementForm();
            });
        }
        if (userFormCancelBtn) {
            userFormCancelBtn.addEventListener('click', hideUserManagementForm);
        }
        if (userManagementContent) {
            userManagementContent.addEventListener('click', handleUserManagementContentClick);
        }
        if (schoolManagementRefreshBtn) {
            schoolManagementRefreshBtn.addEventListener('click', () => loadSchoolManagementData(true));
        }
        if (schoolManagementContent) {
            schoolManagementContent.addEventListener('click', handleSchoolManagementContentClick);
        }
    });
</script>
</body>
</html>
